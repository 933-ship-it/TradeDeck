<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TradeDeck</title>
<link rel="icon" type="image/png" href="assets/logo.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- Consolidated CSP Policy -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:
    https://cdn.tailwindcss.com
    https://cdn.jsdelivr.net
    https://www.paypal.com
    https://www.paypalobjects.com
    https://*.paypal.com
    https://*.paypalobjects.com
    https://*.braintreegateway.com
    https://apis.google.com
    https://widget.cloudinary.com
    https://upload-widget.cloudinary.com
    https://cdn.jsdelivr.net/npm/@emailjs/browser@4
    https://www.gstatic.com
    https://933-ship-it.github.io
    https://infird.com
    https://www.googletagmanager.com
    https://www.google-analytics.com
    https://www.gstatic.com/firebasejs/
    https://firebase.googleapis.com
    https://firebaseapp.com
    https://firestore.googleapis.com
    https://identitytoolkit.googleapis.com
    https://*.googleapis.com;
  style-src 'self' 'unsafe-inline' 
    https://fonts.googleapis.com;
  img-src 'self' data: blob:
    https://933-ship-it.github.io
    https://res.cloudinary.com
    https://lh3.googleusercontent.com
    https://www.google.com
    https://www.paypalobjects.com
    https://*.paypalobjects.com
    https://www.google-analytics.com
    https://via.placeholder.com;
  font-src 'self' 
    https://fonts.gstatic.com;
  connect-src 'self'
    https://*.paypal.com
    https://*.paypalobjects.com
    https://*.braintree-api.com
    https://*.braintreegateway.com
    https://api.emailjs.com
    https://933-ship-it.github.io
    https://www.googleapis.com
    https://identitytoolkit.googleapis.com
    https://firestore.googleapis.com
    https://securetoken.googleapis.com
    https://www.googletagmanager.com
    https://www.google-analytics.com
    https://overbridgenet.com
    https://firebase.googleapis.com
    https://firebaseapp.com
    https://*.firebase.googleapis.com
    https://*.firestore.googleapis.com
    https://firebaseinstallations.googleapis.com
    https://*.googleapis.com;
  frame-src 'self'
    https://www.paypal.com
    https://*.paypal.com
    https://widget.cloudinary.com
    https://upload-widget.cloudinary.com
    https://*.paypalobjects.com
    https://*.braintreegateway.com;
  object-src 'none';
  base-uri 'self';
  form-action 'self';
"/>

<!-- External Scripts and Stylesheets -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=AbAmxidRUaYCqMND4GbNaw_9KBb6xEFlH1cLXoIwObQNjJtlgvJ0lSg7rvgVKGrwIQAWgmne6oAy0wFl&currency=USD"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4RXR7V9NCW"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<!-- Google Analytics -->
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4RXR7V9NCW');
</script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyA0RFkuXJjh7X43R6wWdQKrXtdUwVJ-4js",
  authDomain: "tradedeck-82bbb.firebaseapp.com",
  projectId: "tradedeck-82bbb",
  storageBucket: "tradedeck-82bbb.firebasestorage.app",
  messagingSenderId: "755235931546",
  appId: "1:755235931546:web:7e35364b0157cd7fc2a623",
  measurementId: "G-4RXR7V9NCW"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

window.firebaseApp = app;
window.firebaseAuth = auth;
window.firebaseDb = db;
window.firebaseAnalytics = analytics;
</script>

<!-- EmailJS Initialization -->
<script>
(function(){
emailjs.init({ publicKey: 'fmwYD8DAojsvufds2' });
})();
</script>

<!-- Custom Styles -->
<style>
body { font-family: 'Inter', sans-serif; }
main section { transition: opacity 0.3s; }
main section.hidden { opacity: 0; height: 0; overflow: hidden; position: absolute; pointer-events: none; visibility: hidden; }
.product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
.product-card { transition: all 0.2s; }
.input-invalid { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #ef4444 !important; }
.error-summary { background: #fee2e2; color: #b91c1c; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
.interactive-card { cursor: pointer; }
.interactive-card:hover { border-color: #60a5fa; }
.success { color: #16a34a; }
.error { color: #dc2626; }
.loading { color: #fbbf24; }
#editProductModal { z-index: 1000; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;}
</style>
</head>
<body class="bg-gray-100">
<!-- Authentication Overlay -->
<div id="authOverlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50" style="display:none;">
<div class="text-3xl font-bold text-blue-600 mb-4">Please sign in to use TradeDeck</div>
<a href="https://933-ship-it.github.io/TradeDeck-landing-page/" class="text-blue-500 underline text-lg">Go to Sign In</a>
</div>

<div class="flex h-screen">
<!-- Sidebar -->
<aside class="w-64 bg-white shadow-lg p-6 flex flex-col" aria-label="Sidebar navigation">
<h1 class="text-2xl font-bold text-blue-600 mb-8">TradeDeck</h1>
<div id="profileDropdown" class="relative mb-6" style="min-height:56px;">
<img id="userProfilePic" class="h-12 w-12 rounded-full cursor-pointer border-2 border-blue-500 hidden" src="" alt="Profile" />
<div id="dropdownMenu" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-50 border border-gray-100">
<div class="px-4 py-2 text-gray-700 text-sm border-b border-gray-100" id="userEmail"></div>
<button id="deleteAccountBtn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">Delete Account</button>
<button id="signOutBtn" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">Sign Out</button>
</div>
</div>
<nav class="space-y-4 flex-grow">
<a href="#home" class="block py-2 px-4 rounded-lg text-gray-700 bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="home" tabindex="0" aria-current="page">Home</a>
<a href="#sell" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="sell" tabindex="0">Sell</a>
<a href="#dashboard" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="dashboard" tabindex="0">Dashboard</a>
</nav>
</aside>

<main class="flex-1 overflow-y-auto p-10" aria-live="polite">
<!-- Home Section -->
<section id="home" aria-label="Home Products">
<div class="max-w-5xl mx-auto">
<label for="searchBar" class="sr-only">Search products</label>
<input type="search" id="searchBar" aria-label="Search products" placeholder="Search products..." class="w-full mb-8 px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
<div id="productList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
<p id="noProductsMessage" class="col-span-full text-center text-gray-500 hidden">Loading products...</p>
</div>
</div>
</section>

<!-- Product Details Section -->
<section id="productDetails" class="hidden">
<div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
<button id="backToHomeBtn" class="mb-6 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition focus:outline-none focus:ring-2 focus:ring-gray-400" aria-label="Back to Home">Back</button>
<div id="productDetailsContent">
<div class="flex flex-col md:flex-row gap-8">
<div class="md:w-1/2">
<img id="detailProductImage" src="" alt="Product image" class="w-full h-auto rounded-lg shadow-md object-cover max-h-96" />
</div>
<div class="md:w-1/2 flex flex-col justify-between">
<div>
<h2 id="detailProductTitle" class="text-3xl font-bold text-gray-900 mb-2"></h2>
<p id="detailProductDescription" class="text-gray-700 mb-4 text-justify"></p>
<p class="text-2xl font-extrabold text-blue-600 mb-6" id="detailProductPrice"></p>
</div>
<div class="mt-auto">
<button id="detailActionButton" class="w-full py-3 rounded-xl font-semibold transition"></button>
<div id="paypal-button-container" class="mt-6"></div>
</div>
</div>
</div>
</div>
<p id="productDetailsError" class="text-red-500 text-center mt-4 hidden">Product details could not be loaded.</p>
</div>
</section>

<!-- Sell Section -->
<section id="sell" class="hidden">
<div class="max-w-6xl mx-auto mt-16 px-4">
<div id="sellLandingContent">
<div class="text-center mb-16">
<h2 class="text-4xl font-extrabold text-gray-900 mb-4">Turn Your Digital Assets Into Revenue</h2>
<p class="text-lg text-gray-600 mb-6">
Whether it's eBooks, guides, software, templates, or creative packs—TradeDeck gives you the tools to sell to a global audience instantly.
</p>
<button id="startSellingBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold px-8 py-3 rounded-xl shadow-md transition duration-300">Start Selling Now</button>
</div>
<div class="mb-20">
<h3 class="text-2xl font-semibold text-gray-800 mb-8 text-center">How It Works</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
<div class="bg-white p-6 rounded-xl shadow">
<div class="text-blue-600 text-4xl mb-4">📁</div>
<h4 class="text-lg font-semibold mb-2">Upload Your Product</h4>
<p class="text-gray-600 text-sm">PDFs, images, ZIPs, templates, code bundles, and more—just drag and drop.</p>
</div>
<div class="bg-white p-6 rounded-xl shadow">
<div class="text-green-500 text-4xl mb-4">⚙️</div>
<h4 class="text-lg font-semibold mb-2">Customize & Price</h4>
<p class="text-gray-600 text-sm">Set your price, description, preview images, and license terms.</p>
</div>
<div class="bg-white p-6 rounded-xl shadow">
<div class="text-purple-500 text-4xl mb-4">💸</div>
<h4 class="text-lg font-semibold mb-2">Get Paid Securely</h4>
<p class="text-gray-600 text-sm">Your sales are paid directly to your connected PayPal account.</p>
</div>
</div>
</div>
</div>

<!-- Product Form -->
<div id="productForm" class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto hidden">
<div id="formErrorSummary" class="error-summary hidden"></div>
<h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">List Your Digital Product</h3>
<form id="productUploadForm" class="space-y-6" autocomplete="off">
<div>
<label for="title" class="block text-sm font-medium text-gray-700 mb-1">Product Title</label>
<input type="text" id="title" name="title" required maxlength="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter product title" />
</div>
<div>
<label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
<textarea id="description" name="description" required maxlength="500" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe your product"></textarea>
</div>
<div>
<label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price (USD)</label>
<input type="number" id="price" name="price" required min="1" max="10000" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00" />
</div>
<div>
<label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
<select id="category" name="category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
<option value="">Select category</option>
<option value="ebooks">eBooks</option>
<option value="templates">Templates</option>
<option value="software">Software</option>
<option value="graphics">Graphics</option>
<option value="courses">Courses</option>
<option value="music">Music</option>
<option value="other">Other</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
<div id="uploadWidget" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
<p class="text-gray-600">Click to upload product image</p>
<p class="text-xs text-gray-500 mt-2">Recommended: 800x600px, JPG or PNG</p>
</div>
<img id="previewImage" class="hidden mt-4 max-w-full h-48 object-cover rounded-lg mx-auto" alt="Product preview" />
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Product File</label>
<div id="fileUploadWidget" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
<p class="text-gray-600">Click to upload your digital product</p>
<p class="text-xs text-gray-500 mt-2">PDF, ZIP, DOC, etc. (Max 50MB)</p>
</div>
<p id="fileUploadStatus" class="text-sm text-gray-600 mt-2 hidden"></p>
</div>
<div class="flex gap-4">
<button type="button" id="cancelFormBtn" class="flex-1 py-3 px-6 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition">Cancel</button>
<button type="submit" id="submitProductBtn" class="flex-1 py-3 px-6 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">List Product</button>
</div>
</form>
</div>
</div>
</section>

<!-- Dashboard Section -->
<section id="dashboard" class="hidden">
<div class="max-w-6xl mx-auto">
<h2 class="text-3xl font-bold text-gray-900 mb-8">Your Dashboard</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
<div class="bg-white p-6 rounded-xl shadow">
<h3 class="text-lg font-semibold text-gray-900 mb-2">Total Products</h3>
<p class="text-3xl font-bold text-blue-600" id="totalProducts">0</p>
</div>
<div class="bg-white p-6 rounded-xl shadow">
<h3 class="text-lg font-semibold text-gray-900 mb-2">Total Sales</h3>
<p class="text-3xl font-bold text-green-600" id="totalSales">$0.00</p>
</div>
<div class="bg-white p-6 rounded-xl shadow">
<h3 class="text-lg font-semibold text-gray-900 mb-2">Active Listings</h3>
<p class="text-3xl font-bold text-purple-600" id="activeListings">0</p>
</div>
</div>
<div class="bg-white rounded-xl shadow-lg">
<div class="p-6 border-b border-gray-200">
<h3 class="text-xl font-semibold text-gray-900">Your Products</h3>
</div>
<div id="userProductsList" class="p-6">
<p class="text-gray-500 text-center">No products yet. Start selling to see them here!</p>
</div>
</div>
</div>
</section>
</main>
</div>

<!-- Edit Product Modal -->
<div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
<div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
<div class="p-6 border-b border-gray-200">
<h3 class="text-xl font-semibold text-gray-900">Edit Product</h3>
</div>
<div class="p-6">
<form id="editProductForm" class="space-y-4">
<div>
<label for="editTitle" class="block text-sm font-medium text-gray-700 mb-1">Product Title</label>
<input type="text" id="editTitle" name="title" required maxlength="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
</div>
<div>
<label for="editDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
<textarea id="editDescription" name="description" required maxlength="500" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
</div>
<div>
<label for="editPrice" class="block text-sm font-medium text-gray-700 mb-1">Price (USD)</label>
<input type="number" id="editPrice" name="price" required min="1" max="10000" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
</div>
<div>
<label for="editCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
<select id="editCategory" name="category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
<option value="ebooks">eBooks</option>
<option value="templates">Templates</option>
<option value="software">Software</option>
<option value="graphics">Graphics</option>
<option value="courses">Courses</option>
<option value="music">Music</option>
<option value="other">Other</option>
</select>
</div>
<div class="flex gap-4 pt-4">
<button type="button" id="cancelEditBtn" class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">Cancel</button>
<button type="submit" id="saveEditBtn" class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Save Changes</button>
</div>
</form>
</div>
</div>
</div>

<script>
// Global variables
let allProducts = [];
let userProducts = [];
let currentProduct = null;
let currentUser = null;

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    initializeCloudinary();
    initializeNavigation();
    loadProducts();
});

// App initialization
function initializeApp() {
    // Check authentication state
    if (window.firebaseAuth) {
        window.firebaseAuth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('userProfilePic').src = user.photoURL || 'https://via.placeholder.com/48';
                document.getElementById('userProfilePic').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                loadUserProducts();
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('userProfilePic').classList.add('hidden');
            }
        });
    }

    // Profile dropdown
    document.getElementById('userProfilePic').addEventListener('click', () => {
        document.getElementById('dropdownMenu').classList.toggle('hidden');
    });

    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', async () => {
        if (window.firebaseAuth) {
            await window.firebaseAuth.signOut();
        }
    });

    // Delete account
    document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
            alert('Account deletion functionality would be implemented here.');
        }
    });
}

// Cloudinary initialization
function initializeCloudinary() {
    if (window.cloudinary) {
        const imageWidget = cloudinary.createUploadWidget({
            cloudName: 'your-cloud-name',
            uploadPreset: 'your-preset',
            multiple: false,
            resourceType: 'image'
        }, (error, result) => {
            if (result && result.event === 'success') {
                document.getElementById('previewImage').src = result.info.secure_url;
                document.getElementById('previewImage').classList.remove('hidden');
            }
        });

        const fileWidget = cloudinary.createUploadWidget({
            cloudName: 'your-cloud-name',
            uploadPreset: 'your-preset',
            multiple: false,
            resourceType: 'auto'
        }, (error, result) => {
            if (result && result.event === 'success') {
                document.getElementById('fileUploadStatus').textContent = 'File uploaded successfully!';
                document.getElementById('fileUploadStatus').classList.remove('hidden');
            }
        });

        document.getElementById('uploadWidget').addEventListener('click', () => imageWidget.open());
        document.getElementById('fileUploadWidget').addEventListener('click', () => fileWidget.open());
    }
}

// Navigation
function initializeNavigation() {
    document.querySelectorAll('[data-tab]').forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const targetTab = e.target.getAttribute('data-tab');
            showSection(targetTab);
            
            // Update active state
            document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('bg-blue-100', 'text-blue-700'));
            e.target.classList.add('bg-blue-100', 'text-blue-700');
        });
    });

    // Start selling button
    document.getElementById('startSellingBtn').addEventListener('click', () => {
        document.getElementById('sellLandingContent').classList.add('hidden');
        document.getElementById('productForm').classList.remove('hidden');
    });

    // Cancel form
    document.getElementById('cancelFormBtn').addEventListener('click', () => {
        document.getElementById('sellLandingContent').classList.remove('hidden');
        document.getElementById('productForm').classList.add('hidden');
        document.getElementById('productUploadForm').reset();
    });

    // Back to home
    document.getElementById('backToHomeBtn').addEventListener('click', () => {
        showSection('home');
    });
}

// Show section
function showSection(sectionName) {
    document.querySelectorAll('main section').forEach(section => {
        section.classList.add('hidden');
    });
    document.getElementById(sectionName).classList.remove('hidden');
    
    if (sectionName === 'dashboard') {
        loadDashboardData();
    }
}

// Load products
async function loadProducts() {
    // Sample products for demo
    allProducts = [
        {
            id: '1',
            title: 'Digital Marketing Guide',
            description: 'Complete guide to digital marketing strategies',
            price: 29.99,
            category: 'ebooks',
            imageUrl: 'https://via.placeholder.com/300x200',
            fileUrl: '#',
            sellerId: 'demo-seller'
        },
        {
            id: '2',
            title: 'Website Template Pack',
            description: 'Professional website templates',
            price: 49.99,
            category: 'templates',
            imageUrl: 'https://via.placeholder.com/300x200',
            fileUrl: '#',
            sellerId: 'demo-seller'
        }
    ];
    
    displayProducts(allProducts);
}

// Display products
function displayProducts(products) {
    const productList = document.getElementById('productList');
    const noProductsMessage = document.getElementById('noProductsMessage');
    
    if (products.length === 0) {
        noProductsMessage.classList.remove('hidden');
        productList.innerHTML = '<p id="noProductsMessage" class="col-span-full text-center text-gray-500">No products found.</p>';
        return;
    }
    
    noProductsMessage.classList.add('hidden');
    productList.innerHTML = products.map(product => `
        <div class="product-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-200" onclick="showProductDetails('${product.id}')">
            <img src="${product.imageUrl}" alt="${product.title}" class="w-full h-48 object-cover" />
            <div class="p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.title}</h3>
                <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold text-blue-600">$${product.price}</span>
                    <span class="text-xs text-gray-500 px-2 py-1 bg-gray-100 rounded">${product.category}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// Show product details
function showProductDetails(productId) {
    currentProduct = allProducts.find(p => p.id === productId);
    if (!currentProduct) return;
    
    document.getElementById('detailProductImage').src = currentProduct.imageUrl;
    document.getElementById('detailProductTitle').textContent = currentProduct.title;
    document.getElementById('detailProductDescription').textContent = currentProduct.description;
    document.getElementById('detailProductPrice').textContent = `$${currentProduct.price}`;
    
    const actionButton = document.getElementById('detailActionButton');
    if (currentUser && currentProduct.sellerId === currentUser.uid) {
        actionButton.textContent = 'This is your product';
        actionButton.className = 'w-full py-3 rounded-xl font-semibold bg-gray-200 text-gray-600 cursor-not-allowed';
        actionButton.disabled = true;
    } else {
        actionButton.textContent = 'Buy Now';
        actionButton.className = 'w-full py-3 rounded-xl font-semibold bg-blue-600 text-white hover:bg-blue-700 transition';
        actionButton.disabled = false;
    }
    
    showSection('productDetails');
    renderPayPalButtons();
    trackProductView(productId);
}

// PayPal integration
function renderPayPalButtons() {
    const container = document.getElementById('paypal-button-container');
    if (!container || !window.paypal || !currentProduct) return;
    
    container.innerHTML = '';
    
    window.paypal.Buttons({
        style: {
            layout: 'vertical',
            color: 'blue',
            shape: 'rect',
            label: 'paypal'
        },
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: currentProduct.price.toString()
                    },
                    description: currentProduct.title
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                handlePurchaseSuccess(details);
            });
        },
        onError: function(err) {
            console.error('PayPal error:', err);
            alert('Payment failed. Please try again.');
        }
    }).render('#paypal-button-container');
}

// Handle purchase success
function handlePurchaseSuccess(details) {
    trackPurchase(currentProduct, details.id);
    
    // Send download link
    if (currentUser) {
        emailjs.send('your_service_id', 'your_template_id', {
            to_email: currentUser.email,
            product_title: currentProduct.title,
            download_link: currentProduct.fileUrl,
            transaction_id: details.id
        });
    }
    
    alert(`Thank you for your purchase! A download link has been sent to your email.`);
}

// Product form submission
document.getElementById('productUploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentUser) {
        alert('Please sign in to list products.');
        return;
    }
    
    const formData = new FormData(e.target);
    const productData = {
        title: formData.get('title'),
        description: formData.get('description'),
        price: parseFloat(formData.get('price')),
        category: formData.get('category'),
        imageUrl: document.getElementById('previewImage').src || 'https://via.placeholder.com/300x200',
        fileUrl: '#',
        sellerId: currentUser.uid,
        createdAt: new Date(),
        id: Date.now().toString()
    };
    
    try {
        // Add to Firestore
        if (window.firebaseDb) {
            await window.firebaseDb.collection('products').add(productData);
        }
        
        // Add to local arrays
        allProducts.push(productData);
        userProducts.push(productData);
        
        alert('Product listed successfully!');
        showSection('dashboard');
        document.getElementById('productUploadForm').reset();
        document.getElementById('previewImage').classList.add('hidden');
        document.getElementById('sellLandingContent').classList.remove('hidden');
        document.getElementById('productForm').classList.add('hidden');
        
    } catch (error) {
        console.error('Error adding product:', error);
        alert('Failed to list product. Please try again.');
    }
});

// Load user products
async function loadUserProducts() {
    if (!currentUser) return;
    
    userProducts = allProducts.filter(p => p.sellerId === currentUser.uid);
}

// Load dashboard data
function loadDashboardData() {
    if (!currentUser) return;
    
    document.getElementById('totalProducts').textContent = userProducts.length;
    document.getElementById('totalSales').textContent = `$${userProducts.reduce((sum, product) => sum + product.price, 0).toFixed(2)}`;
    document.getElementById('activeListings').textContent = userProducts.length;

    const userProductsList = document.getElementById('userProductsList');
    
    if (userProducts.length === 0) {
        userProductsList.innerHTML = '<p class="text-gray-500 text-center">No products yet. Start selling to see them here!</p>';
        return;
    }

    userProductsList.innerHTML = `
        <div class="space-y-4">
            ${userProducts.map(product => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <img src="${product.imageUrl}" alt="${product.title}" class="w-16 h-16 object-cover rounded-lg" />
                        <div>
                            <h4 class="font-semibold text-gray-900">${product.title}</h4>
                            <p class="text-sm text-gray-600">${product.category}</p>
                            <p class="text-lg font-bold text-blue-600">$${product.price}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="openEditModal(${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Edit</button>
                        <button onclick="deleteProduct('${product.id}')" 
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Edit product modal
function openEditModal(product) {
    document.getElementById('editTitle').value = product.title;
    document.getElementById('editDescription').value = product.description;
    document.getElementById('editPrice').value = product.price;
    document.getElementById('editCategory').value = product.category;
    
    document.getElementById('editProductModal').classList.remove('hidden');
    document.getElementById('editProductModal').dataset.productId = product.id;
}

// Close edit modal
document.getElementById('cancelEditBtn').addEventListener('click', () => {
    document.getElementById('editProductModal').classList.add('hidden');
});

// Handle edit form submission
document.getElementById('editProductForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const productId = document.getElementById('editProductModal').dataset.productId;
    const formData = new FormData(e.target);
    
    const updateProduct = (products) => {
        const index = products.findIndex(p => p.id === productId);
        if (index !== -1) {
            products[index] = {
                ...products[index],
                title: formData.get('title'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                category: formData.get('category')
            };
        }
    };
    
    updateProduct(allProducts);
    updateProduct(userProducts);
    
    document.getElementById('editProductModal').classList.add('hidden');
    loadDashboardData();
    
    alert('Product updated successfully!');
});

// Delete product
function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) {
        return;
    }
    
    allProducts = allProducts.filter(p => p.id !== productId);
    userProducts = userProducts.filter(p => p.id !== productId);
    
    loadDashboardData();
    alert('Product deleted successfully!');
}

// Search functionality
document.getElementById('searchBar').addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredProducts = allProducts.filter(product =>
        product.title.toLowerCase().includes(searchTerm) ||
        product.description.toLowerCase().includes(searchTerm) ||
        product.category.toLowerCase().includes(searchTerm)
    );
    displayProducts(filteredProducts);
});

// Close modal when clicking outside
document.getElementById('editProductModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('editProductModal')) {
        document.getElementById('editProductModal').classList.add('hidden');
    }
});

// Analytics tracking
function trackEvent(eventName, parameters = {}) {
    if (typeof gtag !== 'undefined') {
        gtag('event', eventName, parameters);
    }
}

function trackProductView(productId) {
    trackEvent('view_item', {
        item_id: productId,
        item_name: currentProduct?.title,
        item_category: currentProduct?.category,
        value: currentProduct?.price
    });
}

function trackPurchase(product, transactionId) {
    trackEvent('purchase', {
        transaction_id: transactionId,
        value: product.price,
        currency: 'USD',
        items: [{
            item_id: product.id,
            item_name: product.title,
            item_category: product.category,
            price: product.price,
            quantity: 1
        }]
    });
}
</script>
</body>
</html>
