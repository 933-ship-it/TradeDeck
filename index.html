<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradeDeck - Sell</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="max-w-3xl mx-auto p-6 bg-white shadow-lg mt-12 rounded-md">
    <h1 class="text-2xl font-bold mb-6">Sell a Product</h1>

    <!-- Status -->
    <p id="status" class="text-blue-600 mb-4 hidden">Uploading...</p>

    <!-- Form -->
    <div class="space-y-4">
      <input id="title" type="text" placeholder="Product Title"
        class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-300"/>

      <textarea id="description" rows="4" placeholder="Product Description"
        class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-300"></textarea>

      <input id="price" type="number" placeholder="Price in USD"
        class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-300"/>

      <label class="block">Upload Product File:
        <input id="productFile" type="file" accept=".pdf,.zip,.docx,.pptx"
          class="mt-2"/>
      </label>

      <label class="block">Upload Preview Image:
        <input id="previewImage" type="file" accept="image/*"
          class="mt-2"/>
      </label>

      <button id="submitButton"
        class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Submit Product</button>
    </div>
  </div>

  <script>
    // Firebase config (replace with your own project info)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const statusEl = document.getElementById("status");
    const submitButton = document.getElementById("submitButton");

    // Require Sign-In
    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => {
          alert("Sign-in failed: " + err.message);
        });
      }
    });

    // Submit Logic
    submitButton.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert("Please sign in first.");

      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const price = parseFloat(document.getElementById("price").value);
      const productFile = document.getElementById("productFile").files[0];
      const previewImage = document.getElementById("previewImage").files[0];

      if (!title || !description || !price || !productFile || !previewImage) {
        return alert("All fields are required.");
      }

      if (isNaN(price) || price <= 0) {
        return alert("Please enter a valid price.");
      }

      // Show loading
      statusEl.classList.remove("hidden");
      statusEl.textContent = "Uploading...";

      try {
        // Upload product file
        const productRef = storage.ref(`products/${user.uid}/${Date.now()}-${productFile.name}`);
        await productRef.put(productFile);
        const productURL = await productRef.getDownloadURL();

        // Upload preview image
        const previewRef = storage.ref(`previews/${user.uid}/${Date.now()}-${previewImage.name}`);
        await previewRef.put(previewImage);
        const previewURL = await previewRef.getDownloadURL();

        // Save product to Firestore
        await db.collection("products").add({
          title,
          description,
          price,
          productURL,
          previewURL,
          sellerUID: user.uid,
          sellerEmail: user.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        statusEl.textContent = "Product submitted successfully!";
        submitButton.disabled = true;
      } catch (err) {
        console.error("Upload failed", err);
        statusEl.textContent = "Error: " + err.message;
      }
    };
  </script>
</body>
</html>
