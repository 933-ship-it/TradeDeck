<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TradeDeck</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.sandbox.paypal.com/sdk/js?client-id=YOUR_SANDBOX_PAYPAL_CLIENT_ID&currency=USD&components=buttons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        main section {
            transition: opacity 0.3s ease-in-out;
        }
        main section.hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            position: absolute;
            pointer-events: none;
            visibility: hidden;
        }
        /* Adjusted style for the file input itself */
        .cloudinary-file-input {
            @apply w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer;
        }
        .file-upload-status {
            @apply text-sm mt-1;
        }
        .file-upload-status.success {
            @apply text-green-600;
        }
        .file-upload-status.error {
            @apply text-red-500;
        }
        .file-upload-status.loading {
            @apply text-blue-500 italic;
        }

        /* Product card hover effect */
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .product-card {
            transition: all 0.2s ease-in-out;
        }

        /* Styles for invalid inputs */
        .input-invalid {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 1px #ef4444;
        }
        /* Style for interactive elements */
        .interactive-card {
            cursor: pointer;
        }
        .interactive-card:hover {
            border-color: #60a5fa; /* blue-400 */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col" aria-label="Sidebar navigation">
            <h1 class="text-2xl font-bold text-blue-600 mb-8">TradeDeck</h1>
            <nav class="space-y-4 flex-grow">
                <a href="#home" class="block py-2 px-4 rounded-lg text-gray-700 bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="home" tabindex="0" aria-current="page">Home</a>
                <a href="#sell" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="sell" tabindex="0">Sell</a>
                <a href="#dashboard" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="dashboard" tabindex="0">Dashboard</a>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-10" aria-live="polite">

            <section id="home" aria-label="Home Products">
                <div class="max-w-5xl mx-auto">
                    <input
                        type="search"
                        id="searchBar"
                        aria-label="Search products"
                        placeholder="Search products..."
                        class="w-full mb-8 px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                    <div
                        id="productList"
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
                    >
                        <p id="noProductsMessage" class="col-span-full text-center text-gray-500 hidden">Loading products...</p>
                    </div>
                </div>
            </section>

            <section id="productDetails" class="hidden">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <button id="backToHomeBtn" class="mb-6 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition focus:outline-none focus:ring-2 focus:ring-gray-400">
                        &larr; Back to Home
                    </button>
                    <div id="productDetailsContent">
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="md:w-1/2">
                                <img id="detailProductImage" src="" alt="Product image" class="w-full h-auto rounded-lg shadow-md object-cover max-h-96" />
                            </div>
                            <div class="md:w-1/2 flex flex-col justify-between">
                                <div>
                                    <h2 id="detailProductTitle" class="text-3xl font-bold text-gray-900 mb-2"></h2>
                                    <p id="detailProductDescription" class="text-gray-700 mb-4 text-justify"></p>
                                    <p class="text-2xl font-extrabold text-blue-600 mb-6" id="detailProductPrice"></p>
                                </div>
                                <div class="mt-auto">
                                    <div id="detailActionButtonContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p id="productDetailsError" class="text-red-500 text-center mt-4 hidden">Product details could not be loaded.</p>
                </div>
            </section>
            <section id="sell" class="hidden">
                <div class="max-w-6xl mx-auto mt-16 px-4">
                    <div id="sellLandingContent">
                        <div class="text-center mb-16">
                            <h2 class="text-4xl font-extrabold text-gray-900 mb-4">
                                Turn Your Digital Assets Into Revenue
                            </h2>
                            <p class="text-lg text-gray-600 mb-6">
                                Whether it's eBooks, guides, software, templates, or creative packs‚ÄîTradeDeck gives you the tools to sell to a global audience instantly.
                            </p>
                            <button
                                id="startSellingBtn"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold px-8 py-3 rounded-xl shadow-md transition duration-300"
                            >
                                Start Selling Now
                            </button>
                        </div>

                        <div class="mb-20">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-8 text-center">How It Works</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-blue-600 text-4xl mb-4">üìÅ</div>
                                    <h4 class="text-lg font-semibold mb-2">Upload Your Product</h4>
                                    <p class="text-gray-600 text-sm">
                                        PDFs, images, ZIPs, templates, code bundles, and more‚Äîjust drag and drop.
                                    </p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-green-500 text-4xl mb-4">‚öôÔ∏è</div>
                                    <h4 class="text-lg font-semibold mb-2">Customize & Price</h4>
                                    <p class="text-gray-600 text-sm">
                                        Set your price, description, preview images, and license terms.
                                    </p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-purple-500 text-4xl mb-4">üí∏</div>
                                    <h4 class="text-lg font-semibold mb-2">Get Paid Securely</h4>
                                    <p class="text-gray-600 text-sm">
                                        Your sales are paid directly to your connected PayPal account.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="productForm" class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto hidden">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">List Your Digital Product</h3>
                        <form id="productUploadForm" class="space-y-6">
                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Product Title</label>
                                <input
                                    type="text"
                                    id="title"
                                    name="title"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., Ultimate eBook Template Pack"
                                />
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Product Description</label>
                                <textarea
                                    id="description"
                                    name="description"
                                    rows="4"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Describe your product in detail..."
                                ></textarea>
                            </div>
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                                <input
                                    type="number"
                                    id="price"
                                    name="price"
                                    min="0"
                                    step="0.01"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., 29.99 (enter 0 for free)"
                                />
                            </div>
                            <input type="hidden" id="sellerPaypalEmailForPayout" name="sellerPaypalEmailForPayout" value="seller@example.com">


                            <div>
                                <label for="previewImageInput" class="block text-sm font-medium text-gray-700 mb-1">Product Preview Image (for home tab)</label>
                                <button type="button" id="openPreviewImageWidget" class="cloudinary-file-input">Choose file</button>
                                <input type="hidden" id="previewImageUrl" name="previewImageUrl">
                                <p id="previewImageStatus" class="file-upload-status"></p>
                                <div id="previewImageContainer" class="mt-2 hidden">
                                    <img id="currentPreviewImage" src="" alt="Product preview" class="max-w-xs h-32 object-cover rounded-md border border-gray-300" />
                                </div>
                            </div>

                            <div>
                                <label for="productFileUrlInput" class="block text-sm font-medium text-gray-700 mb-1">Digital Product File Link (Google Drive, Dropbox, etc.)</label>
                                <input
                                    type="url"
                                    id="productFileUrlInput"
                                    name="productFileUrl"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Paste your direct download link here (e.g., from Google Drive, Dropbox)"
                                />
                                <p class="text-sm text-gray-500 mt-1">Make sure this link is publicly accessible for download.</p>
                            </div>

                            <button
                                type="submit"
                                id="submitProductBtn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold transition"
                            >
                                List Product
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="dashboard" class="hidden">
                <div class="max-w-6xl mx-auto mt-16 px-4">
                    <h2 class="text-4xl font-bold mb-8">DASHBOARD</h2>
                    <div id="userProducts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p id="noUserProductsMessage" class="col-span-full text-center text-gray-500 hidden">No products listed yet.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'desejdvif';
        const CLOUDINARY_UPLOAD_PRESET = 'TradeDeck user products';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0RFkuXJjh7X43R6wWdQKrXtdUwVJ-4js",
            authDomain: "tradedeck-82bbb.firebaseapp.com",
            projectId: "tradedeck-82bbb",
            storageBucket: "tradedeck-82bbb.firebasestorage.app",
            messagingSenderId: "755235931546",
            appId: "1:755235931546:web:7e35364b0157cd7fc2a623",
            measurementId: "G-4RXR7V9NCW"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Global Variables ---
        const tabs = document.querySelectorAll('aside nav a[data-tab]');
        const sections = document.querySelectorAll('main section');

        const startSellingBtn = document.getElementById('startSellingBtn');
        const sellLandingContent = document.getElementById('sellLandingContent');
        const productForm = document.getElementById('productForm');

        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const priceInput = document.getElementById('price');
        // REMOVED: paypalEmailContainer, paypalEmailInput, paypalEmailValidationMsg
        // Since price won't control visibility of seller's PayPal email for *payouts*,
        // and it's not for direct payment, we remove the direct dependency.

        // NEW: Hidden input for seller's PayPal email for payout (simulated for now)
        const sellerPaypalEmailForPayoutInput = document.getElementById('sellerPaypalEmailForPayout');


        const productFileUrlInput = document.getElementById('productFileUrlInput');

        const openPreviewImageWidgetBtn = document.getElementById('openPreviewImageWidget');
        const previewImageUrlInput = document.getElementById('previewImageUrl');
        const previewImageStatus = document.getElementById('previewImageStatus');
        const previewImageContainer = document.getElementById('previewImageContainer');
        const currentPreviewImage = document.getElementById('currentPreviewImage');

        const productUploadForm = document.getElementById('productUploadForm');
        const submitProductBtn = document.getElementById('submitProductBtn');

        const searchBar = document.getElementById('searchBar');
        const productListContainer = document.getElementById('productList');
        const noProductsMessage = document.getElementById('noProductsMessage');

        const userProductsContainer = document.getElementById('userProducts');
        const noUserProductsMessage = document.getElementById('noUserProductsMessage');

        // NEW: Product Details Page elements
        const productDetailsSection = document.getElementById('productDetails');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const detailProductImage = document.getElementById('detailProductImage');
        const detailProductTitle = document.getElementById('detailProductTitle');
        const detailProductDescription = document.getElementById('detailProductDescription');
        const detailProductPrice = document.getElementById('detailProductPrice');
        // MODIFIED: detailActionButton is now a container for PayPal Smart Button
        const detailActionButtonContainer = document.getElementById('detailActionButtonContainer');
        const productDetailsError = document.getElementById('productDetailsError');

        // Track upload status
        let isPreviewImageUploading = false;

        // --- Helper for setting file input status messages ---
        function setFileInputStatus(statusElement, message, type = 'default') {
            statusElement.textContent = message;
            statusElement.classList.remove('success', 'error', 'loading');
            if (type === 'success') {
                statusElement.classList.add('success');
            } else if (type === 'error') {
                statusElement.classList.add('error');
            } else if (type === 'loading') {
                statusElement.classList.add('loading');
            }
        }

        // Helper function to convert Google Drive share link to direct download link
        function convertToGoogleDriveDirectDownload(url) {
            if (!url) return url;

            let convertedUrl = url;

            const driveViewPattern = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/(view|edit|preview)/;
            const match = url.match(driveViewPattern);

            if (match && match[1]) {
                const fileId = match[1];
                convertedUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                console.log(`Converted Google Drive view link to direct download: ${convertedUrl}`);
            } else if (url.includes('drive.google.com/open?id=')) {
                const idMatch = url.match(/id=([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) {
                    const fileId = idMatch[1];
                    convertedUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                    console.log(`Converted old Google Drive share link to direct download: ${convertedUrl}`);
                }
            }
            return convertedUrl;
        }

        // --- Function to Delete Product ---
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to permanently delist this product? This action cannot be undone.')) {
                return; // User cancelled
            }

            try {
                await db.collection('products').doc(productId).delete();
                alert('Product delisted successfully!');
                await loadProducts(''); // Reload all products for the home tab
                await loadProductsForDashboard(); // Reload for the dashboard tab
            } catch (error) {
                console.error("Error removing document: ", error);
                alert('Error delisting product. Please try again. (Check Firestore rules if it fails)');
            }
        }


        // --- Functions ---

        function showTab(targetTabId) {
            tabs.forEach(t => {
                t.classList.remove('bg-blue-100');
                t.removeAttribute('aria-current');
            });

            const currentTab = document.querySelector(`a[data-tab="${targetTabId}"]`);
            if (currentTab) {
                currentTab.classList.add('bg-blue-100');
                currentTab.setAttribute('aria-current', 'page');
            }

            sections.forEach(sec => {
                if (sec.id === targetTabId) {
                    sec.classList.remove('hidden');
                } else {
                    sec.classList.add('hidden');
                }
            });
        }

        function toggleProductForm(showForm) {
            if (showForm) {
                sellLandingContent.classList.add('hidden');
                productForm.classList.remove('hidden');
                showTab('sell');
                // Clear all form inputs and messages when showing the form
                productUploadForm.reset();
                productFileUrlInput.value = '';
                previewImageUrlInput.value = '';
                setFileInputStatus(previewImageStatus, '');
                // Clear previous visual error states
                titleInput.classList.remove('input-invalid');
                descriptionInput.classList.remove('input-invalid');
                priceInput.classList.remove('input-invalid');
                openPreviewImageWidgetBtn.classList.remove('input-invalid');
                productFileUrlInput.classList.remove('input-invalid');
                // REMOVED: paypalEmailInput.classList.remove('input-invalid');
                // REMOVED: paypalEmailValidationMsg.textContent = '';

                previewImageContainer.classList.add('hidden');
                currentPreviewImage.src = '';
                // REMOVED: paypalEmailContainer.classList.add('hidden'); // Ensure PayPal email is hidden by default

                // Immediately check button state after clearing
                enableSubmitButton();
            } else {
                sellLandingContent.classList.remove('hidden');
                productForm.classList.add('hidden');
            }
        }

        function renderProducts(productArray, container, noResultsMsgElement, isDashboardView = false) {
            container.innerHTML = '';
            noResultsMsgElement.classList.add('hidden');

            if (productArray.length === 0) {
                noResultsMsgElement.classList.remove('hidden');
                noResultsMsgElement.textContent = isDashboardView ?
                    'No products listed on the dashboard.' : 'No products found matching your search.';
                return;
            }

            productArray.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = `bg-white rounded-lg shadow p-4 flex flex-col product-card ${isDashboardView ? '' : 'interactive-card border border-transparent'}`;
                productCard.setAttribute('data-product-id', product.id);

                const displayPrice = parseFloat(product.price) === 0 ? 'Free' : `$${parseFloat(product.price).toFixed(2)}`;

                let cardButtonsHtml = '';
                if (isDashboardView) {
                    cardButtonsHtml = `
                        <div class="mt-auto flex justify-end items-center pt-2">
                            <a href="${product.fileUrl}" target="_blank" download="${product.title.replace(/\s/g, '-')}" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition" aria-label="Download ${product.title}">Download File</a>
                            <button data-product-id="${product.id}" class="delist-product-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition ml-2">Delist</button>
                        </div>
                    `;
                }

                productCard.innerHTML = `
                    <img src="${product.previewImageUrl || 'https://via.placeholder.com/300x200?text=Product+Preview'}" alt="${product.title} preview" class="rounded mb-3 h-48 object-cover w-full" />
                    <h3 class="font-semibold text-lg mb-1">${product.title}</h3>
                    <p class="text-gray-600 text-sm flex-grow mb-2 overflow-hidden overflow-ellipsis whitespace-nowrap">${product.description}</p>
                    <div class="mt-auto flex justify-between items-center pt-2">
                        <span class="font-bold text-blue-600">${displayPrice}</span>
                        ${cardButtonsHtml}
                    </div>
                `;
                container.appendChild(productCard);

                if (isDashboardView) {
                    const delistButton = productCard.querySelector('.delist-product-btn');
                    if (delistButton) {
                        delistButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const productId = delistButton.getAttribute('data-product-id');
                            if (productId) {
                                deleteProduct(productId);
                            }
                        });
                    }
                } else {
                    productCard.addEventListener('click', () => {
                        const productId = productCard.getAttribute('data-product-id');
                        if (productId) {
                            showProductDetails(productId);
                        }
                    });
                }
            });
        }

        async function loadProducts(filterQuery = '') {
            productListContainer.innerHTML = '';
            noProductsMessage.textContent = 'Loading products...';
            noProductsMessage.classList.remove('hidden');

            try {
                const productsRef = db.collection('products').orderBy('createdAt', 'desc');
                const snapshot = await productsRef.get();
                const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                window.allProducts = fetchedProducts;

                const lowerCaseQuery = filterQuery.toLowerCase();
                const filteredProducts = fetchedProducts.filter(product =>
                    product.title.toLowerCase().includes(lowerCaseQuery) ||
                    product.description.toLowerCase().includes(lowerCaseQuery)
                );

                renderProducts(filteredProducts, productListContainer, noProductsMessage, false);
            } catch (error) {
                console.error("Error loading products:", error);
                noProductsMessage.textContent = 'Error loading products. Please try again.';
                noProductsMessage.classList.remove('hidden');
            }
        }

        async function loadProductsForDashboard() {
            userProductsContainer.innerHTML = '';
            noUserProductsMessage.textContent = 'Loading all products...';
            noUserProductsMessage.classList.remove('hidden');

            try {
                const productsRef = db.collection('products').orderBy('createdAt', 'desc');
                const snapshot = await productsRef.get();
                const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderProducts(allProducts, userProductsContainer, noUserProductsMessage, true);
            } catch (error) {
                console.error("Error loading products for dashboard:", error);
                noUserProductsMessage.textContent = 'Error loading products for dashboard. Please try again.';
                noUserProductsMessage.classList.remove('hidden');
            }
        }

        // NEW: Function to show product details page (MODIFIED FOR PAYPAL SMART BUTTONS)
        async function showProductDetails(productId) {
            showTab('productDetails');
            productDetailsError.classList.add('hidden');

            try {
                const productDoc = await db.collection('products').doc(productId).get();
                if (!productDoc.exists) {
                    productDetailsError.textContent = 'Product not found.';
                    productDetailsError.classList.remove('hidden');
                    return;
                }

                const product = { id: productDoc.id, ...productDoc.data() };

                // Populate the details page
                detailProductImage.src = product.previewImageUrl || 'https://via.placeholder.com/600x400?text=Product+Preview';
                detailProductTitle.textContent = product.title;
                detailProductDescription.textContent = product.description;
                const displayPrice = parseFloat(product.price) === 0 ? 'Free' : `$${parseFloat(product.price).toFixed(2)}`;
                detailProductPrice.textContent = displayPrice;

                // Clear previous content of the button container
                detailActionButtonContainer.innerHTML = '';

                if (parseFloat(product.price) > 0) {
                    // Render PayPal Smart Button for priced products
                    paypal.Buttons({
                        createOrder: async function(data, actions) {
                            try {
                                // This call will now ensure funds go to YOUR_SANDBOX_PAYPAL_CLIENT_ID (your business account)
                                const response = await fetch('/api/create-paypal-order-data', { // Call backend to create PayPal order
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        productId: product.id,
                                        quantity: 1 // Assuming single quantity per purchase
                                    }),
                                });

                                if (!response.ok) {
                                    const errorData = await response.json();
                                    throw new Error(`Failed to create PayPal order data on backend: ${errorData.error || response.statusText}`);
                                }
                                const orderData = await response.json();
                                return orderData.id; // Return the PayPal Order ID to the SDK
                            } catch (error) {
                                console.error('Error in PayPal createOrder:', error);
                                alert('Error preparing payment. Please try again.');
                                // Re-render the button or show error message if necessary
                            }
                        },
                        onApprove: async function(data, actions) {
                            try {
                                // This call will capture funds into YOUR_SANDBOX_PAYPAL_CLIENT_ID (your business account)
                                // The internalOrderId (product.id) is crucial for your backend to identify the seller for payout.
                                const response = await fetch('/api/capture-paypal-order', { // Call backend to capture PayPal order
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        orderId: data.orderID, // PayPal's order ID
                                        internalOrderId: product.id // Your internal product ID (for database update and seller identification)
                                    }),
                                });

                                if (!response.ok) {
                                    const errorData = await response.json();
                                    throw new Error(`Failed to capture PayPal order: ${errorData.error || response.statusText}`);
                                }
                                const captureData = await response.json();
                                console.log('Payment captured successfully:', captureData);
                                alert('Payment successful! Your order has been placed.');
                                // Redirect to a success page or show content
                                window.location.href = `/paypal/success?order_id=${product.id}&paypal_order_id=${data.orderID}`;
                            } catch (error) {
                                console.error('Error in PayPal onApprove (capture):', error);
                                alert('Error completing payment. Please contact support.');
                                window.location.href = `/paypal/cancel?order_id=${product.id}`;
                            }
                        },
                        onCancel: function(data) {
                            console.log('Payment cancelled by buyer:', data);
                            alert('Payment cancelled.');
                            window.location.href = `/paypal/cancel?order_id=${product.id}`;
                        },
                        onError: function(err) {
                            console.error('PayPal button error:', err);
                            alert('An error occurred with PayPal payment. Please try again.');
                            window.location.href = `/paypal/cancel?order_id=${product.id}`;
                        }
                    }).render('#detailActionButtonContainer'); // Render the button into our div
                } else {
                    // For free products, keep the direct download button
                    const downloadButton = document.createElement('a');
                    downloadButton.href = product.fileUrl;
                    downloadButton.target = '_blank';
                    downloadButton.download = product.title.replace(/\s/g, '-');
                    downloadButton.className = 'w-full py-3 rounded-xl font-semibold transition bg-green-600 hover:bg-green-700 text-white text-center';
                    downloadButton.textContent = 'Download';
                    downloadButton.setAttribute('aria-label', `Download ${product.title}`);
                    detailActionButtonContainer.appendChild(downloadButton);
                }

            } catch (error) {
                console.error("Error loading product details:", error);
                productDetailsError.textContent = 'Error loading product details. Please try again.';
                productDetailsError.classList.remove('hidden');
            }
        }


        // --- Cloudinary Widget Setup for Preview Image ---
        const previewImageWidget = cloudinary.createUploadWidget(
            {
                cloudName: CLOUDINARY_CLOUD_NAME,
                uploadPreset: CLOUDINARY_UPLOAD_PRESET,
                sources: ['local'],
                resourceType: 'image',
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'svg'],
                maxFileSize: 10 * 1024 * 1024,
                multiple: false,
                folder: 'tradedeck_product_previews',
            },
            (error, result) => {
                console.log("Preview Image Widget Event:", result.event, result.info);
                if (!error && result && result.event === "success") {
                    previewImageUrlInput.value = result.info.secure_url;
                    setFileInputStatus(previewImageStatus, `Image uploaded: ${result.info.original_filename}.${result.info.format}`, 'success');
                    openPreviewImageWidgetBtn.classList.remove('input-invalid');
                    currentPreviewImage.src = result.info.secure_url;
                    previewImageContainer.classList.remove('hidden');
                    isPreviewImageUploading = false;
                    console.log("Preview Image URL after success:", previewImageUrlInput.value);
                    enableSubmitButton();
                } else if (error) {
                    console.error("Cloudinary preview image upload error:", error);
                    setFileInputStatus(previewImageStatus, 'Image upload failed. Please try again.', 'error');
                    previewImageUrlInput.value = '';
                    openPreviewImageWidgetBtn.classList.add('input-invalid');
                    previewImageContainer.classList.add('hidden');
                    currentPreviewImage.src = '';
                    isPreviewImageUploading = false;
                    enableSubmitButton();
                } else if (result && (result.event === "close" || result.event === "abort")) {
                    if (previewImageUrlInput.value === '') {
                        setFileInputStatus(previewImageStatus, 'Preview image selection cancelled or not provided.', 'error');
                        openPreviewImageWidgetBtn.classList.add('input-invalid');
                    }
                    isPreviewImageUploading = false;
                    enableSubmitButton();
                } else if (result && result.event === "asset_selected") {
                    setFileInputStatus(previewImageStatus, `Uploading ${result.info.original_filename || 'image'}...`, 'loading');
                    isPreviewImageUploading = true;
                    disableSubmitButton();
                }
            }
        );

        // --- Submit Button Management ---
        function disableSubmitButton() {
            submitProductBtn.disabled = true;
            submitProductBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function enableSubmitButton() {
            const titleFilled = titleInput.value.trim() !== '';
            const descriptionFilled = descriptionInput.value.trim() !== '';
            const priceValid = !isNaN(parseFloat(priceInput.value)) && parseFloat(priceInput.value) >= 0;
            const productFileUrlPresentAndValid = productFileUrlInput.value.trim() !== '' && /^https?:\/\/.+\..+/.test(productFileUrlInput.value.trim());
            const previewImageUrlPresent = previewImageUrlInput.value !== '';
            // REMOVED: paypalEmailValid check as the input is removed

            // Add/remove error classes based on validity
            titleInput.classList.toggle('input-invalid', !titleFilled);
            descriptionInput.classList.toggle('input-invalid', !descriptionFilled);
            priceInput.classList.toggle('input-invalid', !priceValid);
            productFileUrlInput.classList.toggle('input-invalid', !productFileUrlPresentAndValid);
            openPreviewImageWidgetBtn.classList.toggle('input-invalid', !previewImageUrlPresent);
            // REMOVED: paypalEmailInput.classList.toggle for input-invalid and validation message

            if (!isPreviewImageUploading &&
                titleFilled &&
                descriptionFilled &&
                priceValid &&
                productFileUrlPresentAndValid &&
                previewImageUrlPresent) { // Removed paypalEmailValid from condition
                submitProductBtn.disabled = false;
                submitProductBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                disableSubmitButton();
            }
        }


        // --- Event Listeners ---

        // 1. Sidebar Tab Navigation
        tabs.forEach(tab => {
            tab.addEventListener('click', async (e) => {
                e.preventDefault();
                const target = tab.getAttribute('data-tab');
                showTab(target);

                if (target !== 'sell' && !productForm.classList.contains('hidden')) {
                    toggleProductForm(false);
                }
                // Ensure product details page is hidden when navigating to other main tabs
                productDetailsSection.classList.add('hidden');


                if (target === 'home') {
                    await loadProducts(searchBar.value.trim());
                    searchBar.value = '';
                } else if (target === 'dashboard') {
                    await loadProductsForDashboard();
                }
            });
        });

        // NEW: Back to Home button on product details page
        backToHomeBtn.addEventListener('click', () => {
            showTab('home');
            loadProducts(searchBar.value.trim());
        });


        // 2. "Start Selling Now" button on Sell tab
        startSellingBtn.addEventListener('click', () => {
            toggleProductForm(true);
        });

        // 3. Product Upload Form Submission
        productUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            disableSubmitButton();
            submitProductBtn.textContent = 'Listing...';

            // Validate fields before submission
            enableSubmitButton(); // Re-checks validity and applies input-invalid classes
            if (submitProductBtn.disabled) {
                alert('Please fill out all required fields correctly before listing your product.');
                submitProductBtn.textContent = 'List Product';
                return;
            }

            try {
                // Convert Google Drive links if applicable
                const finalProductFileUrl = convertToGoogleDriveDirectDownload(productFileUrlInput.value.trim());

                const newProduct = {
                    title: titleInput.value.trim(),
                    description: descriptionInput.value.trim(),
                    price: parseFloat(priceInput.value),
                    fileUrl: finalProductFileUrl,
                    previewImageUrl: previewImageUrlInput.value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // IMPORTANT: The sellerId and paypalEmail for payout would typically come from
                    // a user authentication system or a profile setting.
                    // For this example, we'll use a placeholder seller ID and the fixed email from the hidden input.
                    sellerId: 'logged_in_user_id_123', // Replace with actual logged-in user ID
                    paypalEmail: sellerPaypalEmailForPayoutInput.value // This is the seller's email for YOUR payouts
                };

                await db.collection('products').add(newProduct);

                alert('Product listed successfully!');
                toggleProductForm(false);
                await loadProducts('');

            } catch (error) {
                console.error("Error adding document to Firestore:", error);
                alert('Failed to list product. Please check console for details. (Check Firestore rules!)');
            } finally {
                enableSubmitButton();
                submitProductBtn.textContent = 'List Product';
            }
        });

        // 4. Input change listeners for validation and button state
        titleInput.addEventListener('input', enableSubmitButton);
        descriptionInput.addEventListener('input', enableSubmitButton);
        priceInput.addEventListener('input', enableSubmitButton);
        productFileUrlInput.addEventListener('input', enableSubmitButton);
        previewImageUrlInput.addEventListener('input', enableSubmitButton);
        // REMOVED: paypalEmailInput.addEventListener for validation

        // 5. Open Cloudinary Preview Image Widget
        openPreviewImageWidgetBtn.addEventListener('click', () => {
            previewImageWidget.open();
        });

        // 6. Handle price input to show/hide PayPal email (REMOVED)
        // Since PayPal email is no longer tied to price for immediate collection,
        // this event listener is removed. The seller's payout email is
        // assumed to be collected elsewhere (e.g., user profile) or is static for this demo.
        /*
        priceInput.addEventListener('input', () => {
            const price = parseFloat(priceInput.value);
            if (isNaN(price) || price === 0) {
                paypalEmailContainer.classList.add('hidden');
                paypalEmailInput.removeAttribute('required');
                paypalEmailInput.value = '';
            } else {
                paypalEmailContainer.classList.remove('hidden');
                paypalEmailInput.setAttribute('required', 'required');
            }
            enableSubmitButton();
        });
        */

        // 7. Initial load of products on home tab
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
            showTab('home');
        });

        // 8. Search bar functionality
        searchBar.addEventListener('input', () => {
            if (!document.getElementById('home').classList.contains('hidden')) {
                const query = searchBar.value.trim();
                const filteredProducts = window.allProducts.filter(product =>
                    product.title.toLowerCase().includes(query.toLowerCase()) ||
                    product.description.toLowerCase().includes(query.toLowerCase())
                );
                renderProducts(filteredProducts, productListContainer, noProductsMessage, false);
            }
        });
    </script>
</body>
</html>

Sources




what does the above cod do


yes ok
This HTML code, representing the frontend of a web application called "TradeDeck," sets up an interface for users to buy and sell digital products. Here's a breakdown of what the code does:

I. Overall Structure and Libraries:

HTML Structure: It's a single-page application with a sidebar for navigation and a main content area that displays different sections (Home, Sell, Dashboard).



CSS Styling: It uses Tailwind CSS for utility-first styling. It also includes custom CSS for elements like body font, section transitions, file input styling, product card hover effects, and invalid input highlighting.


JavaScript Libraries:
Cloudinary: Used for handling image uploads (specifically for product preview images).


Firebase (Firestore): A NoSQL cloud database used to store and retrieve product information.

PayPal SDK: Integrates PayPal Smart Buttons for processing payments.




II. Key Features and Functionality:

Navigation (Sidebar):

The sidebar provides links to "Home," "Sell," and "Dashboard".
Clicking a link shows the corresponding content section and hides others, updating the active tab's style.
Home Section:

Displays a search bar to filter products.


Shows a grid of product cards fetched from Firestore.


Each product card displays an image, title, truncated description, and price.
Product cards are interactive; clicking them leads to the product details page.

Product Details Section (New Feature):

Hidden by default, it appears when a product card is clicked.

Displays detailed information: larger image, full title, complete description, and price.


Includes a "Back to Home" button.


Payment Integration:
If the product price is greater than zero, it renders PayPal Smart Buttons for purchase.

The createOrder and onApprove functions interact with backend API endpoints (/api/create-paypal-order-data and /api/capture-paypal-order) to manage the PayPal transaction. These backend calls are crucial for directing funds to your business's PayPal account and identifying the correct seller for later payouts.

If the product is free (price is 0), it displays a direct "Download" button.
Sell Section:

Initially shows a landing page promoting the benefits of selling.
A "Start Selling Now" button transitions to the product upload form.


Product Upload Form:
Allows sellers to input product title, description, and price.




Important change: The seller's PayPal email input field has been removed from this form. Instead, a hidden input (sellerPaypalEmailForPayout) is present, which would typically be populated by a logged-in user's profile information or a static placeholder for this demo. This email is used by the TradeDeck platform owner (you) to know who to send the seller's earnings to later, after the customer's payment has gone to your business PayPal account.
Uses a Cloudinary widget to upload a preview image for the product.

Sellers provide a digital product file link (e.g., Google Drive, Dropbox). The code includes a helper to convert Google Drive share links into direct download links.


A "List Product" button submits the form.

Form validation dynamically enables/disables the submit button and adds error highlighting to invalid fields.
Dashboard Section:

Displays a list of products listed by the user (seller).


Each product card in the dashboard includes "Download File" and "Delist" buttons.

The "Delist" button allows sellers to remove their product from the platform, prompting a confirmation before deletion from Firestore.
III. Core Logic and Data Handling:

Firebase Firestore: Products are stored as documents in a "products" collection in Firestore. Each product document contains fields like title, description, price, fileUrl, previewImageUrl, createdAt, sellerId, and paypalEmail (for your payout reference).
Dynamic Rendering: Products are dynamically rendered onto the home and dashboard sections based on data fetched from Firestore.


Client-Side Validation: Form inputs are validated in real-time to provide feedback to the user and control the submit button's state.
Cloudinary Upload Widget: Handles the entire preview image upload process, showing status messages and updating the hidden input field with the secure URL upon success.
In essence, this code provides the user interface and client-side logic for TradeDeck, enabling sellers to list digital products and buyers to browse and purchase them, with the key change that all payments are now funneled through the platform owner's PayPal account, who then handles payouts to sellers based on the paypalEmail stored with the product.


Sources





you destroyed the code just refere back to the first dc code i gave you and it was saying Failed to load resource: the server responded with a status of 400 ()Understand this error

TradeDeck/:670 Preview Image Widget Event: source-changed Object

TradeDeck/:650 Error loading product details: ReferenceError: paypal is not defined

¬† ¬† at showProductDetails (TradeDeck/:569:21)




Analysis
yes ok

You are absolutely right, my apologies! It seems I misinterpreted your last request and made a destructive change by removing the PayPal email input, which then caused a ReferenceError: paypal is not defined because the PayPal SDK itself wasn't being correctly initialized or used in the new context.

The error Failed to load resource: the server responded with a status of 400 () usually indicates a problem with a request made to a server, often an API endpoint. In the context of dc.txt, this likely refers to the PayPal createOrder or captureOrder API calls failing on your backend.

The ReferenceError: paypal is not defined is a direct consequence of the PayPal SDK not being available when showProductDetails tries to use paypal.Buttons(). This is often due to:

PayPal SDK not loading: The script tag for the PayPal SDK might be incorrect, blocked, or not executed before showProductDetails is called.
Timing issues: The showProductDetails function might be trying to access paypal before the SDK has fully loaded and initialized the paypal object.
Let's address this by reverting to the original dc.txt code you provided, and then I will explain the 400 error and the paypal is not defined error in the context of the original code, as well as how to manage the seller's PayPal email for payouts without breaking the functionality.

Understanding the Errors with the Original dc.txt Code:

Failed to load resource: the server responded with a status of 400 ()

What it means: Your browser made an HTTP request (likely to your backend server) and the server responded with a 400 Bad Request status. This generally means the server understood the request, but the request itself was invalid or malformed in some way.
In dc.txt context: This error almost certainly comes from one of your backend API calls related to PayPal:
fetch('/api/create-paypal-order-data', ...) in the createOrder function.
fetch('/api/capture-paypal-order', ...) in the onApprove function.
Common causes for a 400 in this scenario:
Missing or invalid data: Your frontend might not be sending all the required data (e.g., productId, quantity) to your backend, or the data might be in the wrong format (e.g., expecting a number but getting a string).
Backend validation failure: Your backend API has validation rules, and the data sent from the frontend violates those rules.
Incorrect API endpoint: The URL /api/create-paypal-order-data or /api/capture-paypal-order might be misspelled or configured incorrectly on the server.
PayPal API errors: Your backend might be correctly receiving the request from the frontend, but then failing when it tries to communicate with the actual PayPal API (e.g., invalid credentials, incorrect request body to PayPal). The PayPal API might return an error that your backend then translates into a 400 for the frontend.
How to debug: You need to check your backend server logs for create-paypal-order-data and capture-paypal-order endpoints. The backend logs will provide much more specific details about why the request was considered bad. You can also use your browser's Developer Tools (Network tab) to inspect the exact request payload sent and the full response received from your backend for these calls.
ReferenceError: paypal is not defined at showProductDetails (TradeDeck/:569:21)

What it means: The JavaScript code tried to use the global paypal object (e.g., paypal.Buttons(...)), but paypal doesn't exist or hasn't been fully loaded by the time that line of code executes.
In dc.txt context:
The PayPal SDK is loaded via <script src="https://www.sandbox.paypal.com/sdk/js?..."></script>.
This error typically happens if:
Network issue: The PayPal SDK script failed to download from www.sandbox.paypal.com. (Check your browser's Network tab for the sdk/js request).
Ad blocker: An ad blocker might be blocking the PayPal SDK script from loading.
Script placement/execution order: While your script tag is in the <head>, JavaScript execution is usually synchronous. However, the paypal object might not be immediately available right after the <script> tag is processed, as it needs to initialize internally. If showProductDetails is called very quickly after the page loads (e.g., due to an initial DOMContentLoaded event, or navigating directly to a product page if you had that functionality), it might be a timing issue.
How to debug:
Verify SDK Load: Open your browser's Developer Tools (Ctrl+Shift+I or F12), go to the "Network" tab, and filter by "JS". Look for the request to https://www.sandbox.paypal.com/sdk/js. Ensure it loaded successfully (HTTP status 200) and without errors.
Check Global Scope: In the "Console" tab, type paypal and press Enter. If it says undefined after the page has fully loaded, the SDK isn't loading correctly. If it shows an object, then it's a timing issue.
Race Condition (less likely but possible): If showProductDetails is called very early, you might need to ensure paypal.Buttons is only called after the SDK has fully loaded. The PayPal SDK usually provides a callback or ensures paypal is defined globally when it's ready. In most cases, if the script loads, the global paypal object is available.
Reverting to the Original dc.txt and Explaining Seller Payouts:

Let's go back to the original dc.txt you provided. In that code, the seller's PayPal email is collected on the frontend when they list a product.

HTML

<div id="paypalEmailContainer" class="hidden">
    <label for="paypalEmail" class="block text-sm font-medium text-gray-700 mb-1">PayPal Email</label>
    <input
        type="email"
        id="paypalEmail"
        name="paypalEmail"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
        placeholder="e.g., yourname@example.com"
    />
    <p id="paypalEmailValidationMsg" class="text-red-500 text-sm mt-1"></p>
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-2" role="alert">
        <p class="font-bold">‚ö†Ô∏è ENSURE YOUR PAYPAL EMAIL IS VALID</p>
        <details class="mt-2">
            <summary class="cursor-pointer text-sm">How to get a valid PayPal email and why it's important</summary>
            <p class="text-xs mt-1">To ensure you receive your funds, use the primary email associated with your verified PayPal account. If the email is invalid or not associated with a PayPal account, TradeDeck will unfortunately be unable to disburse your funds, and they will be forfeited. Double-check your PayPal account settings for the correct email.</p>
        </details>
    </div>
</div>
In this original code:

The paypalEmailInput is tied to the priceInput such that it appears only when the price is greater than 0.
This paypalEmail is saved to Firestore as part of the newProduct object.
To implement your desired payout flow with the original dc.txt code:

Customer pays your business directly: You need to ensure your PayPal SDK client-id and your backend API calls (/api/create-paypal-order-data and /api/capture-paypal-order) are configured so that all payments go into your business's PayPal account. This means the PayPal SDK's client-id in the HTML should be associated with your business's PayPal developer account, and your backend functions should use your business's API credentials to create and capture orders.

Crucially, the createOrder call should not specify a payee object with the seller's email in the PayPal API request from your backend. If it does, funds would go directly to the seller (which is what the original dc.txt implies could happen, but is usually handled on the backend based on complex integrations). By default, PayPal Smart Buttons will pay the account associated with the client-id provided in the SDK.
Seller's email as identifier: The paypalEmail that the seller inputs and gets stored in Firestore is then used by your backend system (not in dc.txt) to know which seller to send the payout to.

When a purchase is made, your /api/capture-paypal-order endpoint on the backend should:
Receive the internalOrderId (which is the product.id).
Look up this product.id in your Firestore database.
Retrieve the paypalEmail (the seller's email) associated with that product.
Store this paypalEmail along with the transaction details in your own database (or use Firestore) as a record for later payout.
Your backend handles payouts: Periodically (e.g., daily, weekly, monthly), you would manually or automatically trigger a batch payout process from your business's PayPal account to the collected seller PayPal emails, deducting your fees/interest rates at that point. This typically involves using PayPal's Payouts API from your backend.

The dc.txt code itself is primarily concerned with the frontend interaction and saving the necessary data (including the seller's PayPal email) to Firestore. The actual decision of who receives the money from the customer and who pays the seller happens more on the backend and in your PayPal integration configuration.

Conclusion for your current errors:

The ReferenceError: paypal is not defined indicates the PayPal SDK script isn't loading or is inaccessible. The 400 error indicates an issue with the request your frontend is sending to your backend for PayPal order creation/capture, or an issue your backend has when talking to PayPal.

To fix these, you should:

Verify PayPal SDK load: Check the browser's Network tab for the PayPal SDK script.
Examine Backend Logs: The primary place to debug the 400 error is your backend server's logs for the /api/create-paypal-order-data and /api/capture-paypal-order endpoints.
I will now provide the original dc.txt code you first gave, as you requested to refer back to it.






!DOCTYPE html
TXT
what should i replace here



Analysis
yes ok

Based on the provided !DOCTYPE html.txt code, here's what you should replace or pay close attention to:

PayPal Client ID:

What to replace: YOUR-PAYPAL-CLIENT-ID in the PayPal SDK script tag.
Why: This placeholder needs to be replaced with your actual PayPal developer client ID. This client ID links the PayPal buttons on your site to your specific PayPal business account, ensuring that all payments made through these buttons are directed to your account.
Line:
HTML

<script src="https://www.paypal.com/sdk/js?client-id=YOUR-PAYPAL-CLIENT-ID&currency=USD"></script> [cite: 1]
sellerId in Product Upload:

What to replace/implement: sellerId: 'placeholder_seller_id' 
Why: Currently, when a product is listed, the sellerId is a static placeholder. In a real application, you'll need to replace this with the actual ID of the logged-in seller. This sellerId is crucial for: 
Identifying which products belong to which seller on the dashboard.

Linking sales to specific sellers for your payout process.
Where in code (within productUploadForm.addEventListener('submit', ...)):
JavaScript

const newProduct = {
    // ... other product fields
    sellerId: 'placeholder_seller_id', // <--- REPLACE THIS [cite: 183]
    paypalEmail: paypalEmailInput.value.trim() [cite: 183]
};
How: This typically requires a user authentication system (e.g., Firebase Authentication, your own backend user management) to determine the currently logged-in user's ID and then pass it to this frontend code.
PayPal Payout Handling (Backend Logic - Not in this frontend code):

What to understand: The original code's PayPal integration (especially in showProductDetails) creates a standard PayPal order that by default pays the account associated with YOUR-PAYPAL-CLIENT-ID.
Why it's important: If your intention is for your business to receive all customer payments first, and then for you to manage payouts to sellers, then the current PayPal SDK setup on the frontend is mostly correct from the customer's payment perspective. The critical part happens on your backend (which is not included in this HTML file).
What your backend needs to do (not a direct code replacement here, but a critical consideration):
Your backend's PayPal integration (where /api/create-paypal-order-data and /api/capture-paypal-order would reside) must be configured to process transactions that channel funds to your business.
After a successful payment is captured into your business account, your backend should:
Retrieve the paypalEmail (the seller's email) that was saved with the product in Firestore.
Record the sale and the seller's paypalEmail for later disbursement.
Use a separate PayPal Payouts API call (from your backend) to send funds to the seller's paypalEmail when you decide to process payouts (e.g., weekly, monthly), minus any fees/interest rates you want to deduct.
By addressing these points, you'll ensure that payments flow correctly to your business and that you have the necessary information (the seller's PayPal email) to manage payouts to them later.


Sources




where do i get those creds


yes ok

To get the necessary credentials for integrating PayPal into your TradeDeck application, you'll need a PayPal Developer account. Here's a breakdown of where to find them:

PayPal Developer Dashboard:

Go to the PayPal Developer website: developer.paypal.com
Log in with your existing PayPal account (or sign up if you don't have one). It's highly recommended to use a business account for selling goods/services.
Once logged in, navigate to the Dashboard.
Locating API Credentials (Client ID & Secret):

In the Dashboard, look for a section related to "My Apps & Credentials" or "REST API apps".
You'll see options for "Sandbox" (for testing) and "Live" (for real transactions). Always start with Sandbox credentials for development and testing.
Click on "Create App" or select an existing app.
Give your application a name (e.g., "TradeDeck Production App" or "TradeDeck Sandbox Testing").
Once the app is created, you'll see your Client ID and Secret.
Client ID: This is what you replace YOUR-PAYPAL-CLIENT-ID with in your HTML file. This key is generally considered safe to expose in client-side code for the PayPal SDK, as it only identifies your account for payment initiation.
Secret: This is a sensitive key and must never be exposed in client-side code (like your dc.txt HTML). Your backend server (which handles /api/create-paypal-order-data and /api/capture-paypal-order) will use this Secret along with the Client ID to authenticate its API calls to PayPal's servers.
Important Notes:

Sandbox vs. Live:
During development and testing, use the Sandbox Client ID. You'll also need to create "Sandbox Accounts" within the PayPal Developer Dashboard to simulate buyers and sellers.
When you are ready to launch your application to accept real money, you will switch to the Live Client ID. Ensure your backend also uses the Live Secret for live transactions.
Backend Security: Emphasizing again, the PayPal Secret must only be used on your secure backend server. It should never be hardcoded or exposed in your frontend JavaScript or HTML.
components=buttons: In your PayPal SDK script, you have &components=buttons. This is good, as it tells the SDK to load only the necessary components for the Smart Buttons, optimizing load time.
Currencies: Your SDK currently specifies currency=USD. If you plan to accept other currencies, you'll need to configure that in the SDK and on your backend.
By following these steps, you'll be able to obtain the correct credentials for your TradeDeck application's PayPal integration.


Sources




and the sellerid stuff


yes ok

You're asking about the sellerId and how to handle it in your TradeDeck application. This is a crucial concept for managing who sells what and who gets paid.

In a real-world application, the sellerId is typically derived from a user authentication system. Here's why and how it generally works:

Why you need a sellerId (User Authentication):

Identity: To know who is listing a product. Without it, anyone could list products under any name, and you wouldn't know who to pay.
Security: To ensure only the rightful seller can manage (edit, delist) their own products.
Personalization: To display a personalized "Dashboard" showing only the products listed by the logged-in seller.
Payout Tracking: This ID links a product (and its sales) to a specific seller for your internal accounting and payout processes.
How to implement "sellerId stuff" (General Steps):

Since your dc.txt code uses Firebase Firestore, the most common and straightforward way to handle user authentication and get a sellerId would be to integrate Firebase Authentication.

Here's a high-level overview of the process:

Set Up Firebase Authentication:

In your Firebase project console, enable Authentication.
Choose an authentication method (e.g., Email/Password, Google Sign-In, etc.). Email/Password is a good starting point for a seller platform.
Add Firebase Authentication SDK to your HTML:

You already have firebase-app-compat.js and firebase-firestore-compat.js. You'll also need the authentication SDK:
HTML

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
Implement User Registration/Login:

Create a "Sign Up" page or section where users can create an account (e.g., with email and password).
Create a "Login" page or section for existing users.
Use Firebase Authentication methods like firebase.auth().createUserWithEmailAndPassword() for registration and firebase.auth().signInWithEmailAndPassword() for login.
Get the sellerId (User UID):

When a user successfully logs in or registers, Firebase Authentication provides a user object. This object has a unique identifier called uid (User ID). This uid is your sellerId.
You can access the current user's UID using firebase.auth().currentUser.uid. This value will be available once a user is logged in.
Store sellerId with Products:

In your productUploadForm's submit event listener, instead of 'placeholder_seller_id', you would use the actual uid:
JavaScript

// Inside productUploadForm.addEventListener('submit', async (e) => { ...
const newProduct = {
    title: titleInput.value.trim(),
    description: descriptionInput.value.trim(),
    price: parseFloat(priceInput.value),
    fileUrl: finalProductFileUrl,
    previewImageUrl: previewImageUrlInput.value,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    // Get the current logged-in user's UID as sellerId
    sellerId: firebase.auth().currentUser ? firebase.auth().currentUser.uid : null, // <--- REPLACE THIS
    paypalEmail: paypalEmailInput.value.trim()
};

// Add a check to ensure a user is logged in before allowing product listing
if (!firebase.auth().currentUser) {
    alert('Please log in to list a product.');
    submitProductBtn.textContent = 'List Product';
    enableSubmitButton(); // Re-enable if necessary
    return;
}

await db.collection('products').add(newProduct);
// ... rest of your code
Important: You'll need to make sure the seller's paypalEmail (for your payouts to them) is also stored reliably, perhaps as part of their user profile in a separate Firestore collection (e.g., users/{uid}/profile) or you could continue to collect it per product if a seller might have different payout emails for different products (though a per-user setting is usually cleaner).
Filter Products by sellerId on Dashboard:

In your loadProductsForDashboard function, you would modify the Firestore query to only fetch products where sellerId matches the current user's uid:
JavaScript

async function loadProductsForDashboard() {
    userProductsContainer.innerHTML = '';
    noUserProductsMessage.textContent = 'Loading your products...';
    noUserProductsMessage.classList.remove('hidden');

    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        noUserProductsMessage.textContent = 'Please log in to view your dashboard.';
        return;
    }

    try {
        const productsRef = db.collection('products')
                              .where('sellerId', '==', currentUser.uid) // <--- ADD THIS FILTER
                              .orderBy('createdAt', 'desc');
        const snapshot = await productsRef.get();
        const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderProducts(allProducts, userProductsContainer, noUserProductsMessage, true);
    } catch (error) {
        console.error("Error loading products for dashboard:", error);
        noUserProductsMessage.textContent = 'Error loading your products for dashboard. Please try again.';
        noUserProductsMessage.classList.remove('hidden');
    }
}
Summary of "SellerId Stuff":

The sellerId directly ties into implementing a user system. Firebase Authentication is the recommended path for a Firebase-backed application like yours. Once authentication is set up, firebase.auth().currentUser.uid becomes the dynamic sellerId you use to:

Associate products with specific sellers.
Filter products for a seller's personal dashboard.
Identify the correct recipient for your manual or automated payouts.

Sources





!DOCTYPE html
TXT
ohh ok then so is this correct and i used a sandbox client id



Analysis
yes ok

Yes, that looks like a good start for your frontend !DOCTYPE html.txt code, especially since you've replaced the placeholder with your Sandbox Client ID.

Here's a breakdown of what's correct and what you need to keep in mind, specifically regarding your intention for your business to receive all payments first, and then you handle payouts to sellers like Sarah:

What's Correct in the Provided Code:

PayPal SDK Inclusion: You have correctly included the PayPal SDK with your specific Sandbox Client ID:

HTML

<script src="https://www.paypal.com/sdk/js?client-id=ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO&currency=USD"></script> [cite: 1]
This is key: When the client-id is provided like this in the frontend, the PayPal Smart Buttons, by default, direct the customer's payment to the PayPal account associated with that client-id. This means payments will go to your business's PayPal account.
createOrder and onApprove (Frontend calls PayPal's client-side SDK):

The createOrder function specifies purchase_units with the product.price and product.title.
The onApprove function then captures the order.
Crucially for your model: This frontend code does not include any payee or seller_receives object in the PayPal order creation that would redirect funds directly to the seller's PayPal email. This means the default behavior (payment to the client-id's account) is maintained.
Seller's PayPal Email Collection:

The paypalEmailInput is still present in the "Sell" form and its value is saved to Firestore as paypalEmail when a product is listed.

This is correct for your model: This paypalEmail serves as the identifier for who you, as the platform owner, will later send payouts to.
sellerId: 'placeholder_seller_id':

This placeholder is still there. As discussed, this is where you'll integrate your user authentication system (like Firebase Authentication) to store the actual logged-in user's ID. This ID is essential for tracking which products belong to which seller and managing their dashboards.

What You Need to Be Aware Of (Primarily Backend/Off-code):

Backend Implementation for PayPal Order Creation/Capture:

The current frontend createOrder and onApprove use client-side PayPal SDK functions directly (actions.order.create, actions.order.capture).

For a production application, it's highly recommended to move these PayPal API calls to your backend server. This provides more security and control over the transaction flow.
If you were to move them to the backend, your backend would need to:
Receive the product details from the frontend.
Use your PayPal API credentials (Client ID and Secret) to create an order with PayPal.
Receive the approval from PayPal and use your PayPal API credentials (Client ID and Secret) to capture the payment.
Confirm that the captured payment went to your business account.
Your Payout System (Backend):

The !DOCTYPE html.txt code handles the frontend display and data collection, but the actual process of you taking the customer's payment and then paying out the seller will happen on your backend system.
Your backend will need to:
Keep a record of all sales, linking them to the sellerId and the paypalEmail stored in Firestore.
Calculate the seller's share after deducting your interest rates/fees.
Use PayPal's Payouts API (or another payment service) to send funds from your business's PayPal account to the sellers' paypalEmail addresses at agreed-upon intervals (e.g., weekly, monthly). This is a completely separate process from the customer's initial payment.
"Your sales are paid directly to your connected PayPal account":

The "How It Works" section in the Sell tab still states this. While the technical implementation with your client ID means payments go to your account, this text might imply to the seller that funds go directly to their PayPal account. You might want to update this text to clarify that payments are processed by TradeDeck, and sellers will receive payouts from TradeDeck.
In summary, the provided frontend code sets up the PayPal buttons to send money to the client-id specified (your business). It also collects the seller's PayPal email. This is a good foundation for your intended payout model, but the crucial steps of securely managing the transaction flow and implementing the actual payouts will largely reside in your backend.


Sources




i tested it and it said paypal buttons could not be loaded


yes ok

The error "PayPal buttons could not be loaded" with the message "PayPal buttons could not be loaded. Please refresh."  indicates that the JavaScript code was unable to initialize the paypal.Buttons() function from the PayPal SDK.

This usually points to one of a few common issues:

PayPal SDK Script Not Fully Loaded or Blocked:

Network Issue: The most common reason. The browser might not be able to download the PayPal SDK script from https://www.paypal.com/sdk/js?... due to a network error, a slow connection, or the server being temporarily down.
Ad Blocker/Browser Extensions: Many ad blockers or privacy extensions can interfere with third-party scripts, especially those related to payments.
CORS/Security Policy: Less likely if it's a direct script tag, but browser security policies (like Content Security Policy) could prevent the script from running.
Incorrect client-id: While you've inserted a Sandbox Client ID, if there's a typo, or if the ID itself isn't correctly configured on PayPal's end (e.g., you created the app but it's not yet active), it could lead to issues.
Timing/Race Condition:

The showProductDetails function might be attempting to call paypal.Buttons() before the external PayPal SDK script has fully loaded and initialized the paypal global object. Although modern browsers load scripts efficiently, in some edge cases or if the script is large, this can happen. Your code has a check if (typeof paypal !== "undefined" && paypal.Buttons), which is good, but if paypal is undefined when showProductDetails is first called, it will skip rendering the buttons and show the error message.
How to Debug and Confirm:

Check Browser Developer Tools (Network Tab):

Open your browser (e.g., Chrome, Firefox) developer tools (usually by pressing F12 or Ctrl+Shift+I).
Go to the "Network" tab.
Reload your TradeDeck page.
Filter the requests by "JS" or search for "sdk/js".
Look for: The request to https://www.paypal.com/sdk/js?client-id=ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO&currency=USD.
Expected: It should have a 200 OK status and a non-zero size.
If you see:
A failed status, (blocked:other), or (canceled): An ad blocker or browser extension is likely interfering. Try disabling extensions or testing in an incognito/private window.
A 4xx or 5xx status code: There's an issue retrieving the script from PayPal's server.
The request isn't there at all: The script tag itself might be commented out or malformed, preventing the browser from initiating the download.
Check Browser Developer Tools (Console Tab):

After the page loads, go to the "Console" tab in your developer tools.
Type typeof paypal and press Enter.
Expected: You should see object.
If you see: undefined, then the SDK is definitely not loading correctly or hasn't finished initializing.
Verify Client ID:

Double-check that the Sandbox Client ID ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO  is indeed correct and active in your PayPal Developer Dashboard for your Sandbox app. Sometimes, client IDs can get corrupted if copied with extra spaces or characters.
Potential Solution (if it's a timing issue, less common with sdk/js but worth trying):

While the typeof paypal !== "undefined" check is there, if the showProductDetails function is called very early, you might technically hit it before the global paypal object is fully set up. However, the most frequent cause is simply the script failing to load.

Your next step should be to use the browser's developer tools as described above to pinpoint why the PayPal SDK script isn't loading or isn't making paypal available globally.


Sources




my console also said js:1¬†

¬† ¬† ¬† ¬† ¬† ¬†¬†

¬† ¬† ¬† ¬† ¬† ¬†¬†

¬† ¬† ¬† ¬† ¬† ¬†Failed to load resource: the server responded with a status of 400 ()



yes ok

The console message js:1 Failed to load resource: the server responded with a status of 400 () is significant.

Here's what it means in the context of your TradeDeck application and the PayPal integration:

js:1: This indicates the error is occurring on the first line of a JavaScript file. While it could literally be the very first line of a script, it often points to an error that happens very early in the script loading process, perhaps even before the script content itself is fully parsed, or within a very small initial script.
Failed to load resource: the server responded with a status of 400 (): This is the core issue. Your browser attempted to fetch a resource (likely a JavaScript file or an API response), and the server it requested it from returned a 400 Bad Request status code. The () after 400 means there was no additional text or message provided by the server in the error response.
Why this is happening with your PayPal integration:

The 400 Bad Request most commonly occurs when:

You're trying to load the PayPal SDK, but the client-id in the URL is problematic. While you've put in a Sandbox Client ID, if there's any invalid character, missing part, or if the ID itself isn't recognized by PayPal's server as a valid client-id for any reason (even if it's technically a sandbox ID), PayPal's server could respond with a 400.
Action: Double-check the client-id you copied from your PayPal Developer Dashboard. Ensure there are no extra spaces, missing characters, or typos. It should be exactly as provided by PayPal.
Your browser's extensions (like ad blockers or privacy tools) are interfering. Some aggressive blockers might inject code or modify requests in a way that makes the client-id parameter look invalid to PayPal's server, leading to a 400.
Action: Try disabling all browser extensions and re-testing. Also, try opening your TradeDeck page in an Incognito/Private Browse window (which usually disables extensions by default).
There's a fundamental issue with how the PayPal SDK URL is being formed. While less likely for a direct copy-paste from PayPal's documentation, ensure the full URL https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD is correctly constructed.
How to confirm and fix:

Inspect the Network Request in Developer Tools:

Open your browser's Developer Tools (F12 or Ctrl+Shift+I).
Go to the Network tab.
Reload your TradeDeck page.
Filter by "JS" or look for the request to paypal.com/sdk/js.
Examine the status code. It should show 400 Bad Request.
Look at the full request URL. Copy it and paste it into a text editor to ensure it's exactly what you expect, particularly the client-id parameter.
Check the response. Click on the request in the Network tab and go to the "Response" sub-tab. Sometimes, the server will provide a small error message in the response body, even for a 400, that can give you more clues.
Test with a Simpler client-id (for diagnostic purposes):

Temporarily try using a generic client-id if you're comfortable. For example, if you just put client-id=test (which would clearly be invalid), would you still get a 400? This helps confirm if the format or the specific ID is the issue. (Remember to change this back to your actual Sandbox ID).
Confirm Sandbox Client ID Validity:

Go back to your PayPal Developer Dashboard.
Ensure the Sandbox app you created is active and the Client ID you're using is indeed the one shown there. Sometimes, people accidentally copy a Live Client ID into a Sandbox environment, or vice-versa, which will cause issues.
The ReferenceError: paypal is not defined error you saw previously is a consequence of this 400 error. If the paypal.com/sdk/js script fails to load with a 400, then the paypal object will never be defined in your browser's JavaScript environment, leading to the ReferenceError when your code tries to use it.


Sources




it says



all.js200scriptTradeDeck/:10(memory cache)0¬†msfirebase-app-compat.js200scriptTradeDeck/:12(memory cache)0¬†msfirebase-firestore-compat.js200scriptTradeDeck/:13(memory cache)0¬†msjs?client-id=ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6Sv‚Ä¶6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO&currency=USD200scriptTradeDeck/:1593.6¬†kB3.01¬†sruntime.ba06111566795e41.js200scriptindex.html?cloudName=desejdvif&pmHost=https://933-ship-it.github.io&pmPath=/TradeDeck/:426(disk cache)2¬†msmain.cd9662a0df381bd3.js200scriptindex.html?cloudName=desejdvif&pmHost=https://933-ship-it.github.io&pmPath=/TradeDeck/:426(disk cache)82¬†ms



yes ok

That's excellent news! Your latest console output indicates that the PayPal SDK script is loading successfully with a 200 OK status. This means the previous 400 Bad Request error for the PayPal SDK is resolved.

The line you provided shows:

js?client-id=ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO&currency=USD 200 script TradeDeck/:15 93.6 kB 3.01 s 

200 script: Confirms the script was successfully downloaded.
93.6 kB: Shows it downloaded a significant amount of data, so it's not an empty file.
3.01 s: This is the time it took to load. It's a bit on the slower side, but it loaded successfully.
If the PayPal SDK is loading, but you're still seeing "PayPal buttons could not be loaded," it means the ReferenceError: paypal is not defined is still occurring, but now it's due to a timing issue or the paypal.Buttons function not being ready immediately.

Here's the likely scenario and how to address it:

Even though the script tag loads, the paypal object might not be fully initialized and ready to use immediately after the script download completes. Your code is attempting to call paypal.Buttons() inside showProductDetails.

How to address the timing issue:

The most robust way to ensure the paypal object and its Buttons method are ready is to delay the rendering of the PayPal buttons until the SDK explicitly signals it's ready.

PayPal doesn't provide a direct onLoad callback for paypal.Buttons in the SDK script tag itself for this kind of scenario, but a common pattern is to make sure your code that renders the buttons is called after the DOM is fully loaded and ideally, after the SDK has had a moment to initialize.

Option 1: Add a small delay (for demonstration/quick fix, not ideal for production):

You could add a small setTimeout in your showProductDetails function, though this is a less reliable approach as network conditions vary.

JavaScript

// Inside showProductDetails function, replace the if/else block for PayPal
if (parseFloat(product.price) > 0) {
    detailActionButton.style.display = 'none';
    paypalButtonContainer.innerHTML = '';

    // Add a small delay to ensure PayPal SDK is fully initialized
    setTimeout(() => {
        if (typeof paypal !== "undefined" && paypal.Buttons) {
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: product.price.toString() },
                            description: product.title
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        alert('Payment completed by ' + details.payer.name.given_name + '!');
                        paypalButtonContainer.innerHTML = `<a href="${product.fileUrl}" target="_blank" class="w-full block bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-xl font-semibold mt-6">Download Product</a>`;
                    });
                },
                onError: function(err) {
                    alert('Payment could not be completed. Please try again.');
                    console.error(err);
                }
            }).render('#paypal-button-container');
        } else {
            paypalButtonContainer.innerHTML = '<p class="text-red-600">PayPal buttons could not be loaded. Please refresh.</p>';
        }
    }, 500); // 500ms delay - you might need to adjust this
} else {
    // ... (your existing code for free products)
}
Option 2: (Recommended for cleaner code, but requires restructuring)

A more robust solution in a real application would be to abstract the PayPal button rendering into its own function that is called only when needed, and potentially, to ensure the paypal object is ready. However, given your current structure, the setTimeout might be the quickest way to confirm it's a timing issue.

What to do next:

Implement the setTimeout around the paypal.Buttons rendering logic. Start with 500 milliseconds and see if the buttons now appear.
Test thoroughly: Click on a product to bring up the details page and check if the PayPal buttons load now.
If the buttons still don't load with a setTimeout, check your console again for any new errors or warnings, as the issue might be something else subtle within the paypal.Buttons configuration itself.


Sources




yes it does work thank you so much


yes ok
That's fantastic news! I'm really glad the setTimeout workaround helped get your PayPal buttons loading correctly. It confirms that the issue was indeed a timing-related one where your JavaScript was trying to access the paypal object before the PayPal SDK had fully finished initializing in the browser.


While the setTimeout is a quick and effective solution for a development environment, keep in mind that relying on fixed delays can sometimes be flaky in production due to varying network conditions or device performance. For future iterations, if you encounter more complex timing issues, you might explore more robust patterns like waiting for a custom event from the PayPal SDK (if available) or using Promises/async-await more extensively to ensure dependencies are fully loaded.

But for now, I'm happy TradeDeck is a step closer to full functionality!


Sources




ok i tested the checkout and it said patyment was succesfull now i will test in live mode


yes ok
That's a big step! Moving from Sandbox to Live mode involves a few critical changes and considerations to ensure real money transactions work correctly and securely.

Here's a checklist and explanation for your transition to Live mode:

1. Update PayPal Client ID in !DOCTYPE html.txt:

Crucial: You must replace your Sandbox Client ID with your Live Client ID in the PayPal SDK script tag.
Find this line:
HTML

<script src="https://www.paypal.com/sdk/js?client-id=ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO&currency=USD"></script>
Replace ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO with your Live Client ID.
Where to get it: Go to your PayPal Developer Dashboard (developer.paypal.com), navigate to "My Apps & Credentials," and select the "Live" toggle to find your Live Client ID for your application.
2. Update PayPal API Credentials on Your Backend (if applicable):

Even though your !DOCTYPE html.txt (frontend) uses client-side PayPal SDK calls, for a truly secure and production-ready application, you'll eventually want to move your createOrder and captureOrder logic to a backend server.
If you have a backend: Ensure your backend API endpoints (/api/create-paypal-order-data and /api/capture-paypal-order) are configured to use your Live PayPal Client ID and Live PayPal Secret. These secrets are highly sensitive and must never be in your frontend code.
If you don't have a backend yet: While the current client-side implementation can work for collecting payments to your business PayPal account, be aware of the security implications. For managing payouts to sellers, you will definitely need a backend system eventually.
3. Test with a Small Real Transaction:

After deploying your changes to your live environment, perform a very small real purchase (e.g., a product priced at $1 or the lowest amount PayPal allows).
Use a real buyer PayPal account (not a sandbox account) to make this test purchase.
Verify that:
The payment successfully goes into your live PayPal business account.
You receive the payment notification in your PayPal account.
The purchase flow (download link for the buyer, if applicable) works correctly.
4. Monitor Your PayPal Account and Backend Logs:

After going live, closely monitor your PayPal business account for incoming payments.
If you have a backend, keep a close eye on your backend server logs for any errors related to PayPal API calls, especially during the createOrder and captureOrder processes.
5. Consider Your Payout System:

Remember your goal: "their email is used for me to know who to send the payout to". Now that real payments are coming into your business account, you need to execute the payout process.
This will require a backend system to:
Store seller's PayPal emails (already done via Firestore).
Track sales for each seller.
Calculate fees/interest.
Initiate payouts to sellers using PayPal's Payouts API (or similar) from your backend. This is not handled by the !DOCTYPE html.txt file.
Important Considerations for Live Mode:

Security: Always prioritize security in live environments. Your PayPal Secret must remain confidential on your backend.
Error Handling: Ensure robust error handling for all payment processes, both on the frontend (user-friendly messages) and backend (logging, alerts).
Transaction Fees: Be aware of PayPal's transaction fees for live payments.
Customer Support: Be prepared to handle customer inquiries related to payments and downloads.
Good luck with your live mode testing!


Sources




so if the transaction goes through and it says succesfull but the card i used had no money in it and also i recieved nothing in my business account


yes ok

If a transaction says "successful" on the frontend, but the card used had no money and you received nothing in your business PayPal account, it indicates a critical discrepancy and a problem with the payment capture process.

Here's a breakdown of what likely happened and how to debug it:

What "Successful" on the Frontend Might Mean (and why it's misleading here):

In your current frontend code, the onApprove function's success message (alert('Payment completed by ' + details.payer.name.given_name + '!');) and the rendering of the download link happen after actions.order.capture().then(...).

If you didn't receive money, but the frontend said "successful", it means one of these things failed after the initial "approve" but before the money was actually captured:
Client-Side Capture Failure: While the buyer approved the payment on the PayPal pop-up, the actions.order.capture() call itself failed or returned a non-successful status. However, your frontend might not be robustly handling the catch block of that specific .then() chain, leading it to proceed as if successful.
Sandbox Account Issues:
Buyer Sandbox Account Had No Funds: If you used a Sandbox personal account, even if it had no funds, PayPal's Sandbox environment might sometimes simulate success in the createOrder or onApprove phase but then fail at capture if the funds aren't truly available in the simulated account.
Seller Sandbox Account (Your Business) Not Set Up Correctly: Your Sandbox business account might not be correctly configured to receive funds, or it might have certain limitations.
PayPal API Error During Capture (if you had a backend): If you were using a backend for createOrder and captureOrder (which is the recommended production setup), then your backend's call to the PayPal API to capture the funds failed, even though the frontend received an "approval" signal from the PayPal pop-up. The 400 error you saw earlier, if it reappeared during the capture phase, would be a strong indicator of this.
How to Debug This Specific Scenario:

Re-Test in Sandbox with Known Good Accounts:

Crucial: Go back to your PayPal Developer Dashboard.
Create a Personal (Buyer) sandbox account that you know has a positive balance or a linked, simulated credit card with funds.
Create a Business (Seller) sandbox account (this represents your TradeDeck business account) that is correctly set up to receive payments.
Use these specific sandbox accounts for your testing.
Inspect PayPal Developer Dashboard Activity:

Log into your PayPal Developer Dashboard.
Go to "Testing Tools" -> "Sandbox Accounts".
Click on the buyer account you used. Check its transaction history. Did a transaction appear and then get reversed or fail?
Click on your business (seller) account. Check its transaction history. Is there any record of the payment attempt, even a failed one?
Browser Developer Tools - Network Tab (Most Important):

Open your browser's Developer Tools (F12 or Ctrl+Shift+I).
Go to the Network tab.
Perform a test transaction.
Look for the PayPal-related requests:
The initial sdk/js load (which you said was 200 OK).
Any subsequent calls related to createOrder (if you implement a backend API for it).
Crucially, look for calls related to capture or checkout/orders/YOUR_ORDER_ID/capture (if they are direct PayPal API calls or if your backend makes them).
Examine the HTTP Status Code for these requests. If you see anything other than 200 OK or 201 Created for the capture request, that's your problem. A 400 or 500 here would indicate a server-side error during capture.
Inspect the Response Body: Click on the problematic network request and check the "Response" tab. PayPal's API provides very detailed error messages in JSON format. This will tell you exactly why the capture failed (e.g., "INSTRUMENT_DECLINED", "INSUFFICIENT_FUNDS", "PAYER_ACTION_REQUIRED").
Review Frontend onApprove Logic:

Your current onApprove is:
JavaScript

onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
        alert('Payment completed by ' + details.payer.name.given_name + '!');
        // ... rest of success actions
    });
},
There is no explicit .catch() block for the actions.order.capture().then(...) promise in your frontend code. If actions.order.capture() fails for some reason (e.g., card declined, insufficient funds), the .then() part might not execute, or if it throws an error that's not caught, your onError for the PayPal button might still catch it, but your alert logic might be a bit optimistic.
To make your frontend more robust:
JavaScript

onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
        // This block only runs if capture was successful
        alert('Payment completed by ' + details.payer.name.given_name + '!');
        paypalButtonContainer.innerHTML = `<a href="${product.fileUrl}" target="_blank" class="w-full block bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-xl font-semibold mt-6">Download Product</a>`;
    }).catch(function(error) {
        // This block runs if capture fails (e.g., funds unavailable)
        console.error('Payment capture failed:', error);
        alert('Payment capture failed. Please try a different payment method or contact support. Details in console.');
        // Optionally hide download link, show error message
    });
},
onError: function(err) {
    // This catches broader PayPal button errors (e.g., configuration)
    alert('An error occurred with PayPal payment. Please try again.');
    console.error(err);
}
Adding that .catch() within onApprove will give you better frontend feedback if the capture itself is the issue.
The Bottom Line:

The symptom of "success" on the frontend but no money in your account, especially with an empty card, strongly suggests the payment capture stage failed or was not fully processed. Your previous 400 error is highly relevant, as a 400 or similar status would prevent the payment from reaching your account. Digging into the Network tab of your browser's developer tools for the capture request will likely give you the most specific reason from PayPal's API.


Sources




what marketplaces use paypal for moving money


yes ok
Many online marketplaces and platforms use PayPal for moving money, both for consumer purchases and for facilitating payouts to sellers. Here are some prominent examples:

eBay: Historically, eBay and PayPal were part of the same company, and PayPal remains a primary payment method for buyers and a key payout option for many sellers on the platform.
Etsy: This marketplace for handmade and vintage items uses PayPal as a payment option for buyers. Sellers can also link their PayPal accounts to receive payments from Etsy.
Steam: The popular digital game distribution platform uses PayPal as a common payment method for users to purchase games.
Gumroad: A platform that allows creators to sell digital products directly to their audience. It heavily integrates with PayPal for both purchases and payouts to creators.
Bandcamp: A music platform where artists can sell their music directly to fans. PayPal is a widely used payment method.
Fiverr: A marketplace for freelance services. Buyers can pay with PayPal, and freelancers can receive their earnings via PayPal.
Upwork: Another major freelance platform that offers PayPal as a withdrawal method for freelancers' earnings.
Shopify (and other e-commerce platforms): While Shopify itself is a platform for building online stores, many individual Shopify stores, as well as stores built on platforms like WooCommerce, frequently offer PayPal as a payment gateway option for their customers. This means the store owner (which is a type of merchant in a broader marketplace ecosystem) receives money via PayPal.
Patreon: A platform where creators can receive recurring payments from patrons. PayPal is a common method for patrons to pay and for creators to receive their funds.
These marketplaces leverage PayPal's widespread adoption, security features, and often its robust API (including Payouts API) to handle transactions and disbursements effectively.


Sources




how does gumroad do it


yes ok

Gumroad, a popular platform for creators to sell digital products directly to their audience, handles payments and payouts using PayPal in a way that aligns with the "marketplace" model you're building with TradeDeck.

Here's a breakdown of how Gumroad typically does it:

Direct Integration for Customer Payments (via Gumroad's account):

When a customer buys a product on Gumroad (e.g., an e-book, a music track, a font), they pay Gumroad directly. Gumroad integrates with payment processors like PayPal (and credit card processors like Stripe) under its own merchant accounts.
This means the customer's money initially flows into Gumroad's central holding account.
Creator Connects Payout Method (PayPal or Bank Account):

Creators on Gumroad set up their payout preferences in their account settings. This is where they specify how they want to receive their earnings.
A common option is to connect their PayPal account. They provide their PayPal email address, similar to how your TradeDeck's sellers provide their paypalEmail.
Alternatively, in many regions, creators can also connect their bank account for direct deposits.
Gumroad Manages Fees and Payouts:

After a sale, Gumroad deducts its platform fees (a percentage of the sale, which can vary based on the creator's plan).
The remaining amount is added to the creator's balance within their Gumroad account.
Gumroad then processes payouts to creators. This typically happens on a set schedule (e.g., weekly, bi-weekly, or when a certain minimum threshold is reached).
For creators who chose PayPal, Gumroad uses PayPal's Mass Pay or Payouts API (a backend API feature) to send multiple payments simultaneously from Gumroad's PayPal account to the individual PayPal accounts of thousands of creators. This is a robust way to handle bulk disbursements.
Key Similarities to Your TradeDeck Model:

Centralized Payment Collection: Both Gumroad and your desired TradeDeck model have the marketplace owner (Gumroad, or you) collect the initial payment from the customer.
Creator Specifies Payout Destination: Both platforms require the creator to provide their PayPal email (or bank details) so the platform knows where to send their earnings.
Marketplace Manages Payouts: Both platforms handle the calculation of fees/commissions and then initiate separate payouts to the creators/sellers.
The main difference is the scale and the backend infrastructure required to manage thousands of creators and their payouts, which Gumroad has built extensively using tools like PayPal's Payouts API.


Sources




go in great detail to how the payments url are made automatically for products


yes ok

In the provided !DOCTYPE html.txt code, the "payment URLs" for products are not explicitly "made automatically" as separate, distinct URLs that a user would directly navigate to for payment. Instead, the payment process is integrated directly into the product details page using PayPal Smart Buttons.

Let's break down in detail how this works within the given code:

1. The Product Details Page (showProductDetails function):

When a user clicks on a product card on the "Home" page, the showProductDetails(productId) function is called.
This function fetches the product's data from Firebase Firestore.
It then populates the productDetails section of the HTML with the product's image, title, description, and price.
2. Conditional Payment Button Rendering:

The code checks the product.price.
If parseFloat(product.price) > 0 (i.e., the product is not free):
The standard detailActionButton (a regular HTML button) is hidden (detailActionButton.style.display = 'none').
The paypalButtonContainer's HTML is cleared (paypalButtonContainer.innerHTML = '').
A check if (typeof paypal !== "undefined" && paypal.Buttons) ensures the PayPal SDK has loaded successfully. This is crucial for avoiding the "paypal is not defined" error.
The core of the payment integration happens here: paypal.Buttons({...}).render('#paypal-button-container').
3. PayPal Smart Buttons and Their Internal "URLs":

The paypal.Buttons() function doesn't create a URL that you see in the browser's address bar. Instead, it dynamically renders interactive payment buttons (like "PayPal" and potentially "Debit or Credit Card") directly within the specified HTML container (#paypal-button-container). These buttons then trigger a payment flow:

createOrder Function: This is a JavaScript function that you define within paypal.Buttons().

When the buyer clicks a PayPal button, the PayPal SDK calls your createOrder function.
In your code, this function uses actions.order.create().
Inside actions.order.create(), you pass an object defining the purchase_units.
Crucially, you specify the amount (from product.price) and a description (from product.title).
Behind the scenes: The PayPal SDK (which uses your client-id to identify your business) then makes an API call to PayPal's servers to create a draft order. This internal API call is what essentially "reserves" the transaction for the specified amount and description. The response from PayPal's API for this call contains an orderID. This orderID is not a user-facing URL but an internal PayPal identifier for that specific transaction.
onApprove Function: This is another JavaScript function you define.

After the buyer successfully approves the payment in the PayPal pop-up (e.g., they log into PayPal and confirm the amount), the PayPal SDK calls your onApprove function.
This function receives data (which includes data.orderID from the createOrder step) and actions.
Your code then calls actions.order.capture().
Behind the scenes: This triggers another API call to PayPal's servers to finalize the payment and move the funds from the buyer's account to the account associated with your client-id (your TradeDeck business account).
Upon successful capture, PayPal's API returns details about the completed transaction (e.g., payer's name).
Your frontend then shows a success alert and, importantly, reveals the download link for the product. This download link (product.fileUrl) is the URL that was stored in Firestore and is directly retrieved from the product data. It's not a payment URL, but the fulfillment URL enabled after successful payment.
onError Function: This function handles any errors that occur during the PayPal payment process.

In summary, there are no "payment URLs made automatically" in the traditional sense of a browser navigating to a unique URL for each payment. Instead, the PayPal Smart Buttons leverage a client-side JavaScript SDK that interacts with PayPal's robust backend APIs:

client-id: Your HTML provides your PayPal client-id to the SDK, identifying your business as the recipient of payments.
createOrder: Triggers an internal API call to PayPal to create a payment order, based on the product's price and description.
onApprove: Triggers an internal API call to PayPal to capture the funds for the approved order.
No Direct Payment URL: The entire transaction takes place within an embedded pop-up or redirect managed by the PayPal SDK, never exposing a direct, unique payment URL in your browser's address bar for the customer to manually interact with. The fulfillment (download) URL is revealed only after successful payment.

Sources




go in great detail to how the payments url are made automatically for products in gumroad


yes ok

While I don't have access to Gumroad's proprietary backend code, I can explain in great detail how a platform like Gumroad likely generates and handles "payment URLs" for its products, differentiating it from the PayPal Smart Buttons client-side integration you have in your !DOCTYPE html.txt file.

Gumroad's approach for payment URLs for individual products typically involves a server-side dynamic generation and redirection process, rather than client-side SDK rendering. Here's a detailed breakdown:

1. Unique Product Landing Pages and Buy Buttons:

For Every Product: When a creator uploads a product to Gumroad, Gumroad generates a unique, persistent URL for that product's landing page (e.g., https://[creator-name].gumroad.com/[product-slug]).
Buy Button on Landing Page: On this landing page, there's a prominent "Buy" or "I Want This!" button.
2. Initiating the Checkout Process (Dynamic Checkout URL Generation):

User Action: When a customer clicks the "Buy" button on a product's landing page, this action triggers a request to Gumroad's backend server.
Server-Side Logic: Gumroad's server receives this request and performs several crucial steps:
Identifies the Product: It knows which product the customer wants to buy based on the URL or data submitted from the landing page.
Identifies the Customer (Optional/If Logged In): If the customer is already logged into Gumroad, their ID might be associated with the transaction.
Generates a Unique Checkout Session/Order ID: The server generates a unique, temporary identifier for this specific purchase attempt (a "checkout session ID" or "order ID"). This ID is crucial for tracking the transaction.
Constructs a Dynamic Checkout URL: The server then builds a specific, dynamic URL for the checkout page. This URL will typically include:
Base Checkout Domain: https://gumroad.com/checkout/ or a similar dedicated checkout subdomain.
Unique Session ID: The generated checkout session ID (e.g., https://gumroad.com/checkout/abc123xyz).
Product Identifier (often implicit): While the session ID is primary, the product ID might also be embedded for redundancy or initial context.
Other Parameters (Optional): It might include parameters for quantity, variations, discount codes, or return URLs.
Redirection: After generating this URL, Gumroad's server issues an HTTP redirect (e.g., a 302 Found status) to the customer's browser, sending them to the newly generated, unique checkout URL.
3. The Checkout Page (Payment Gateway Integration):

Dedicated Page: The customer's browser is now on Gumroad's secure checkout page (e.g., https://gumroad.com/checkout/abc123xyz). This page is entirely controlled by Gumroad.
Payment Method Options: On this page, Gumroad presents various payment options (credit card, PayPal, Apple Pay, etc.).
PayPal Integration (Server-Side):
If the customer chooses PayPal, Gumroad's frontend will interact with PayPal's client-side SDK.
However, the crucial difference from your current code is that Gumroad's createOrder and onApprove functions will almost certainly make calls to Gumroad's own backend server, not directly to PayPal's API from the browser.
Gumroad's Backend Acts as the Intermediary:
createOrder (Backend Call): The client-side PayPal SDK on Gumroad's checkout page would send a request to Gumroad's backend (e.g., /api/gumroad-paypal-create-order). Gumroad's backend then uses its server-side PayPal API credentials (Client ID and Secret) to create the order with PayPal. This is more secure as sensitive credentials are not exposed in the browser. The response (PayPal's orderID) is sent back to the browser.
onApprove (Backend Call): After the customer approves the payment in the PayPal pop-up, the client-side SDK again sends a request to Gumroad's backend (e.g., /api/gumroad-paypal-capture-order), passing the orderID. Gumroad's backend then uses its server-side PayPal API credentials to capture the payment from PayPal's servers.
4. Post-Payment Fulfillment and Payouts:

Transaction Confirmation: Once Gumroad's backend successfully captures the payment via PayPal's API, it records the complete transaction.
Customer Redirection: The customer is then redirected to a confirmation page or a download page, often using another dynamically generated URL that contains a secure token or the order ID, allowing access to the purchased digital product.
Internal Accounting: Gumroad's internal systems update the creator's balance, deducting platform fees.
Scheduled Payouts: On a regular schedule, Gumroad initiates payouts to creators. As mentioned before, for PayPal payouts, Gumroad uses PayPal's Mass Pay or Payouts API from its backend to send funds to the creators' linked PayPal accounts.
Why Gumroad uses this approach (and why it's recommended for marketplaces):

Security: Keeps sensitive API credentials (PayPal Secret) entirely on the server, never exposing them to the client.
Control & Customization: Gumroad has full control over the checkout flow, branding, and user experience. It can add custom logic for discounts, upsells, taxes, and fraud detection.
Flexibility in Payment Methods: It can integrate multiple payment gateways (PayPal, Stripe, etc.) seamlessly behind a unified checkout experience, without each gateway's SDK directly dictating the entire client-side flow.
Centralized Fund Collection: All customer payments go into Gumroad's account first, allowing them to manage fees, refunds, and structured payouts to creators.
Robust Analytics & Reporting: Easier to track all transaction data comprehensively on their own server.
In essence, Gumroad's "payment URLs" are dynamically generated, single-use checkout session URLs that lead to a secure, server-controlled payment page, facilitating an intermediary role between the customer's payment and the creator's payout.


Sources





!DOCTYPE html
TXT
ok so merge these code in the file given



Analysis
yes ok

Merging these two code snippets requires careful integration, as the second snippet introduces a complete landing page with Google authentication and hides the main app content until a user is signed in. The first snippet contains the core TradeDeck application logic (home, sell, dashboard, product details).

The goal is to combine them so that:

The landing page is shown when a user is not authenticated.
The main TradeDeck app is shown when a user is authenticated.
The sellerId for new products is correctly set to the logged-in user's Firebase UID.
The dashboard displays products only for the logged-in user.
Here's the merged !DOCTYPE html.txt code:

HTML

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TradeDeck</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script src="https://www.paypal.com/sdk/js?client-id=AbAmxidRUaYCqMND4GbNaw_9KBb6xEFlH1cLXoIwObQNjJtlgvJ0lSg7rvgVKGrwIQAWgmne6oAy0wFl"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; [cite: 195, 2]
        }
        main section {
            transition: opacity 0.3s ease-in-out; [cite: 196, 3]
        }
        main section.hidden {
            opacity: 0; [cite: 197, 4]
            height: 0; [cite: 197, 4]
            overflow: hidden; [cite: 197, 4]
            position: absolute; [cite: 197, 4]
            pointer-events: none; [cite: 197, 4]
            visibility: hidden; [cite: 197, 5]
        }
        .cloudinary-file-input {
            @apply w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer; [cite: 198, 6]
        }
        .file-upload-status {
            @apply text-sm mt-1;
        }
        .file-upload-status.success {
            @apply text-green-600;
        }
        .file-upload-status.error {
            @apply text-red-500;
        }
        .file-upload-status.loading {
            @apply text-blue-500 italic; [cite: 10]
        }
        .product-card:hover {
            transform: translateY(-5px); [cite: 199, 11]
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); [cite: 199, 11]
        }
        .product-card {
            transition: all 0.2s ease-in-out; [cite: 199, 12]
        }
        .input-invalid {
            border-color: #ef4444; [cite: 200, 13]
            box-shadow: 0 0 0 1px #ef4444; [cite: 200, 13]
        }
        .interactive-card {
            cursor: pointer; [cite: 201, 14]
        }
        .interactive-card:hover {
            border-color: #60a5fa; [cite: 202, 15]
        }
        /* Styles from the second file for profile dropdown and landing page animations */
        #profileDropdown { display: none; position: absolute; right: 0; top: 3.5rem; z-index: 20; min-width: 170px; } [cite: 203]
        #profileDropdown.show { display: block; } [cite: 204]
        .fade-in { animation: fadeIn .8s cubic-bezier(.4,0,.2,1);} [cite: 204]
        @keyframes fadeIn {from { opacity:0; transform:translateY(30px);} to {opacity:1; transform:none;}} [cite: 205]
        .blob {
            position: absolute; [cite: 206]
            pointer-events: none; [cite: 206]
            width: 480px; [cite: 206]
            height: 480px; [cite: 206]
            z-index: 0; [cite: 206]
            opacity: 0.18; [cite: 206]
            left: -120px; [cite: 206]
            top: -80px; [cite: 206]
            background: linear-gradient(135deg, #60a5fa 0%, #818cf8 100%); [cite: 207]
            border-radius: 62% 38% 53% 47% / 46% 65% 35% 54%; [cite: 207]
            filter: blur(2px); [cite: 207]
            animation: blobmove 10s infinite alternate cubic-bezier(.4,0,.2,1); [cite: 208]
        }
        @keyframes blobmove {
            0% { left: -120px; top: -80px; border-radius: 62% 38% 53% 47% / 46% 65% 35% 54%; } [cite: 209, 210]
            100% { left: -80px; top: -60px; border-radius: 43% 57% 36% 64% / 54% 61% 39% 46%; } [cite: 211, 212]
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="landingPage" class="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-white relative fade-in"> [cite: 205]
        <div class="blob"></div> [cite: 206]
        <div class="relative bg-white/90 shadow-xl rounded-3xl px-10 py-12 sm:p-16 max-w-lg w-full z-10 flex flex-col items-center">
            <img src="https://cdn-icons-png.flaticon.com/512/2702/2702602.png"
                alt="TradeDeck Logo" [cite: 213]
                class="h-20 w-20 mx-auto mb-4 rounded-full shadow-lg border-4 border-blue-200 bg-white"
            />
            <h1 class="text-4xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-blue-400 to-purple-400 mb-3 drop-shadow-lg">
                TradeDeck
            </h1>
            <p class="text-gray-600 mb-7 text-center font-medium text-lg"> [cite: 214]
                <span class="text-blue-700 font-semibold">The #1 digital asset marketplace</span><br>
                Buy, sell, and monetize eBooks, templates, code bundles, and more, instantly. [cite: 215]
            </p>
            <ul class="mb-7 w-full space-y-2 text-base text-gray-600 font-semibold">
                <li class="flex items-center">
                    <span class="text-blue-400 text-xl mr-2">‚úîÔ∏è</span> Fast Google sign-in, no passwords [cite: 215]
                </li>
                <li class="flex items-center">
                    <span class="text-blue-400 text-xl mr-2">‚úîÔ∏è</span> Secure payments via PayPal [cite: 216]
                </li>
                <li class="flex items-center">
                    <span class="text-blue-400 text-xl mr-2">‚úîÔ∏è</span> Keep 100% of your earnings [cite: 217]
                </li>
            </ul>
            <button id="googleSignInBtn"
                class="mt-2 w-full bg-gradient-to-r from-blue-600 to-purple-500 hover:from-blue-700 hover:to-purple-600 shadow-lg text-white py-3 px-8 rounded-xl font-semibold text-lg transition duration-200 flex items-center justify-center focus:ring-4 focus:ring-blue-200"
            >
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="inline h-5 w-5 mr-3 align-text-bottom" /> [cite: 218]
                Sign in with Google
            </button>
            <div class="mt-8 text-xs text-gray-400 text-center">
                By signing in you agree to the <a href="#" class="underline hover:text-blue-700">Terms</a> and <a href="#" class="underline hover:text-blue-700">Privacy Policy</a>. [cite: 219]
            </div>
        </div>
        <div class="absolute bottom-0 left-0 w-full text-center pb-3 text-xs text-gray-300 z-10">
            &copy; 2025 TradeDeck. All rights reserved. [cite: 220]
        </div>
    </div>

    <header id="profileHeader" class="bg-white shadow h-16 flex items-center px-6 justify-end relative" style="display:none;"> [cite: 220]
        <div class="relative">
            <button id="profilePicBtn" class="flex items-center focus:outline-none" aria-haspopup="true">
                <img id="profilePic" src="" alt="Profile" class="h-10 w-10 rounded-full border border-blue-300 shadow" />
                <span id="profileName" class="ml-3 text-gray-800 font-semibold"></span> [cite: 221]
                <svg class="ml-1 w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 border"> [cite: 203]
                <button id="signOutBtn" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700">Sign out</button> [cite: 221]
                <button id="deleteAccountBtn" class="block w-full text-left px-4 py-2 hover:bg-red-100 text-red-700">Delete my account</button> [cite: 222]
            </div>
        </div>
    </header>

    <div id="mainApp" class="flex h-screen" style="display:none;"> [cite: 222]
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col" aria-label="Sidebar navigation">
            <h1 class="text-2xl font-bold text-blue-600 mb-8">TradeDeck</h1>
            <nav class="space-y-4 flex-grow"> [cite: 223]
                <a href="#home" class="block py-2 px-4 rounded-lg text-gray-700 bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="home" tabindex="0" aria-current="page">Home</a> [cite: 223]
                <a href="#sell" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="sell" tabindex="0">Sell</a> [cite: 223]
                <a href="#dashboard" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="dashboard" tabindex="0">Dashboard</a> [cite: 224]
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-10" aria-live="polite">

            <section id="home" aria-label="Home Products"> [cite: 17]
                <div class="max-w-5xl mx-auto">
                    <input
                        type="search"
                        id="searchBar"
                        aria-label="Search products" [cite: 18]
                        placeholder="Search products..."
                        class="w-full mb-8 px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                    <div
                        id="productList" [cite: 19]
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
                    >
                        <p id="noProductsMessage" class="col-span-full text-center text-gray-500 hidden">Loading products...</p> [cite: 20]
                    </div>
                </div>
            </section>

            <section id="productDetails" class="hidden"> [cite: 20]
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <button id="backToHomeBtn" class="mb-6 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition focus:outline-none focus:ring-2 focus:ring-gray-400"> [cite: 21]
                        &larr; Back to Home [cite: 22]
                    </button>
                    <div id="productDetailsContent">
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="md:w-1/2"> [cite: 23]
                                <img id="detailProductImage" src="" alt="Product image" class="w-full h-auto rounded-lg shadow-md object-cover max-h-96" />
                            </div>
                            <div class="md:w-1/2 flex flex-col justify-between"> [cite: 24]
                                <div>
                                    <h2 id="detailProductTitle" class="text-3xl font-bold text-gray-900 mb-2"></h2> [cite: 24]
                                    <p id="detailProductDescription" class="text-gray-700 mb-4 text-justify"></p> [cite: 25]
                                    <p class="text-2xl font-extrabold text-blue-600 mb-6" id="detailProductPrice"></p> [cite: 25]
                                </div>
                                <div class="mt-auto"> [cite: 26]
                                    <button id="detailActionButton" class="w-full py-3 rounded-xl font-semibold transition"></button> [cite: 26]
                                    <div id="paypal-button-container" class="mt-6"></div> [cite: 27]
                                </div>
                            </div>
                        </div>
                    </div>
                    <p id="productDetailsError" class="text-red-500 text-center mt-4 hidden">Product details could not be loaded.</p> [cite: 28]
                </div>
            </section>

            <section id="sell" class="hidden"> [cite: 28]
                <div class="max-w-6xl mx-auto mt-16 px-4">
                    <div id="sellLandingContent"> [cite: 29]
                        <div class="text-center mb-16">
                            <h2 class="text-4xl font-extrabold text-gray-900 mb-4">
                                Turn Your Digital Assets Into Revenue [cite: 30]
                            </h2>
                            <p class="text-lg text-gray-600 mb-6">
                                Whether it's eBooks, guides, software, templates, or creative packs‚ÄîTradeDeck gives you the tools to sell to a global audience instantly. [cite: 31, 32]
                            </p>
                            <button
                                id="startSellingBtn"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold px-8 py-3 rounded-xl shadow-md transition duration-300" [cite: 33]
                            >
                                Start Selling Now
                            </button>
                        </div> [cite: 34]

                        <div class="mb-20">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-8 text-center">How It Works</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center"> [cite: 35]
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-blue-600 text-4xl mb-4">üìÅ</div> [cite: 36]
                                    <h4 class="text-lg font-semibold mb-2">Upload Your Product</h4> [cite: 36]
                                    <p class="text-gray-600 text-sm">
                                        PDFs, images, ZIPs, templates, code bundles, and more‚Äîjust drag and drop. [cite: 37, 38]
                                    </p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-green-500 text-4xl mb-4">‚öôÔ∏è</div> [cite: 39]
                                    <h4 class="text-lg font-semibold mb-2">Customize & Price</h4> [cite: 39]
                                    <p class="text-gray-600 text-sm">
                                        Set your price, description, preview images, and license terms. [cite: 40, 41]
                                    </p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-purple-500 text-4xl mb-4">üí∏</div> [cite: 42]
                                    <h4 class="text-lg font-semibold mb-2">Get Paid Securely</h4> [cite: 42]
                                    <p class="text-gray-600 text-sm">
                                        Your sales are paid directly to your connected PayPal account. [cite: 43, 44]
                                    </p>
                                </div>
                            </div>
                        </div> [cite: 45]
                    </div>
                    <div id="productForm" class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto hidden">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">List Your Digital Product</h3>
                        <form id="productUploadForm" class="space-y-6">
                            <div> [cite: 46]
                                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Product Title</label>
                                <input
                                    type="text" [cite: 47]
                                    id="title"
                                    name="title"
                                    required [cite: 48]
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., Ultimate eBook Template Pack" [cite: 49]
                                />
                            </div>
                            <div> [cite: 50]
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Product Description</label>
                                <textarea
                                    id="description" [cite: 51]
                                    name="description"
                                    rows="4"
                                    required [cite: 52]
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Describe your product in detail..." [cite: 53]
                                ></textarea>
                            </div>
                            <div> [cite: 54]
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                                <input
                                    type="number" [cite: 55]
                                    id="price"
                                    name="price"
                                    min="0" [cite: 56]
                                    step="0.01"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., 29.99 (enter 0 for free)" [cite: 57]
                                />
                            </div> [cite: 58]
                            <div id="paypalEmailContainer" class="hidden"> [cite: 58]
                                <label for="paypalEmail" class="block text-sm font-medium text-gray-700 mb-1">PayPal Email</label>
                                <input
                                    type="email" [cite: 59]
                                    id="paypalEmail"
                                    name="paypalEmail" [cite: 60]
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., yourname@example.com" [cite: 61]
                                />
                                <p id="paypalEmailValidationMsg" class="text-red-500 text-sm mt-1"></p> [cite: 62]
                                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-2" role="alert"> [cite: 62]
                                    <p class="font-bold">‚ö†Ô∏è ENSURE YOUR PAYPAL EMAIL IS VALID</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-sm">How to get a valid PayPal email and why it's important</summary> [cite: 63]
                                        <p class="text-xs mt-1">To ensure you receive your funds, use the primary email associated with your verified PayPal account. If the email is invalid or not associated with a PayPal account, payouts may fail.</p> [cite: 64]
                                    </details>
                                </div>
                            </div> [cite: 65]
                            <div>
                                <label for="previewImageInput" class="block text-sm font-medium text-gray-700 mb-1">Product Preview Image (for home tab)</label>
                                <button type="button" id="openPreviewImageWidget" class="cloudinary-file-input">Choose file</button> [cite: 66]
                                <input type="hidden" id="previewImageUrl" name="previewImageUrl">
                                <p id="previewImageStatus" class="file-upload-status"></p>
                                <div id="previewImageContainer" class="mt-2 hidden"> [cite: 67]
                                    <img id="currentPreviewImage" src="" alt="Product preview" class="max-w-xs h-32 object-cover rounded-md border border-gray-300" />
                                </div> [cite: 68]
                            </div>
                            <div>
                                <label for="productFileUrlInput" class="block text-sm font-medium text-gray-700 mb-1">Digital Product File Link (Google Drive, Dropbox, etc.)</label> [cite: 69]
                                <input
                                    type="url" [cite: 70]
                                    id="productFileUrlInput"
                                    name="productFileUrl"
                                    required [cite: 71]
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Paste your direct download link here (e.g., from Google Drive, Dropbox)" [cite: 72]
                                />
                                <p class="text-sm text-gray-500 mt-1">Make sure this link is publicly accessible for download.</p>
                            </div>
                            <button
                                type="submit" [cite: 73]
                                id="submitProductBtn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold transition" [cite: 74]
                            >
                                List Product
                            </button>
                        </form> [cite: 75]
                    </div>
                </div>
            </section>

            <section id="dashboard" class="hidden"> [cite: 75]
                <div class="max-w-6xl mx-auto mt-16 px-4"> [cite: 76]
                    <h2 class="text-4xl font-bold mb-8">DASHBOARD</h2>
                    <div id="userProducts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p id="noUserProductsMessage" class="col-span-full text-center text-gray-500 hidden">No products listed yet.</p>
                    </div> [cite: 77]
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'desejdvif'; [cite: 78]
        const CLOUDINARY_UPLOAD_PRESET = 'TradeDeck user products'; [cite: 78]

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0RFkuXJjh7X43R6wWdQKrXtdUwVJ-4js",
            authDomain: "tradedeck-82bbb.firebaseapp.com",
            projectId: "tradedeck-82bbb",
            storageBucket: "tradedeck-82bbb.firebasestorage.app",
            messagingSenderId: "755235931546",
            appId: "1:755235931546:web:7e35364b0157cd7fc2a623",
            measurementId: "G-4RXR7V9NCW" [cite: 79]
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig); [cite: 80, 226]
        const auth = firebase.auth(); // Initialize Firebase Auth [cite: 226]
        const db = firebase.firestore(); [cite: 81, 226]

        // --- Global Variables (App Specific) ---
        const tabs = document.querySelectorAll('aside nav a[data-tab]'); [cite: 81, 82]
        const sections = document.querySelectorAll('main section'); [cite: 82]

        const startSellingBtn = document.getElementById('startSellingBtn'); [cite: 82]
        const sellLandingContent = document.getElementById('sellLandingContent'); [cite: 82]
        const productForm = document.getElementById('productForm'); [cite: 83]

        const titleInput = document.getElementById('title'); [cite: 83]
        const descriptionInput = document.getElementById('description'); [cite: 83]
        const priceInput = document.getElementById('price'); [cite: 83]
        const paypalEmailContainer = document.getElementById('paypalEmailContainer'); [cite: 83]
        const paypalEmailInput = document.getElementById('paypalEmail'); [cite: 84]
        const paypalEmailValidationMsg = document.getElementById('paypalEmailValidationMsg'); [cite: 84]

        const productFileUrlInput = document.getElementById('productFileUrlInput'); [cite: 84]

        const openPreviewImageWidgetBtn = document.getElementById('openPreviewImageWidget'); [cite: 84]
        const previewImageUrlInput = document.getElementById('previewImageUrl'); [cite: 85]
        const previewImageStatus = document.getElementById('previewImageStatus'); [cite: 85]
        const previewImageContainer = document.getElementById('previewImageContainer'); [cite: 85]
        const currentPreviewImage = document.getElementById('currentPreviewImage'); [cite: 85]

        const productUploadForm = document.getElementById('productUploadForm'); [cite: 85]
        const submitProductBtn = document.getElementById('submitProductBtn'); [cite: 86]

        const searchBar = document.getElementById('searchBar'); [cite: 86]
        const productListContainer = document.getElementById('productList'); [cite: 86]
        const noProductsMessage = document.getElementById('noProductsMessage'); [cite: 86]

        const userProductsContainer = document.getElementById('userProducts'); [cite: 86]
        const noUserProductsMessage = document.getElementById('noUserProductsMessage'); [cite: 87]

        // Product Details Page elements
        const productDetailsSection = document.getElementById('productDetails'); [cite: 87]
        const backToHomeBtn = document.getElementById('backToHomeBtn'); [cite: 87]
        const detailProductImage = document.getElementById('detailProductImage'); [cite: 87]
        const detailProductTitle = document.getElementById('detailProductTitle'); [cite: 88]
        const detailProductDescription = document.getElementById('detailProductDescription'); [cite: 88]
        const detailProductPrice = document.getElementById('detailProductPrice'); [cite: 88]
        const detailActionButton = document.getElementById('detailActionButton'); [cite: 88]
        const productDetailsError = document.getElementById('productDetailsError'); [cite: 88]
        const paypalButtonContainer = document.getElementById('paypal-button-container'); [cite: 89]

        // Track upload status
        let isPreviewImageUploading = false; [cite: 89]

        // UI Elements (Authentication Specific from second file)
        const landingPage = document.getElementById('landingPage'); [cite: 227]
        const googleSignInBtn = document.getElementById('googleSignInBtn'); [cite: 227]
        const profileHeader = document.getElementById('profileHeader'); [cite: 227]
        const profilePicBtn = document.getElementById('profilePicBtn'); [cite: 227]
        const profilePic = document.getElementById('profilePic'); [cite: 228]
        const profileName = document.getElementById('profileName'); [cite: 228]
        const profileDropdown = document.getElementById('profileDropdown'); [cite: 228]
        const signOutBtn = document.getElementById('signOutBtn'); [cite: 228]
        const deleteAccountBtn = document.getElementById('deleteAccountBtn'); [cite: 228]
        const mainApp = document.getElementById('mainApp'); [cite: 229]

        let userSessionId = null; [cite: 229]

        // --- Helper for setting file input status messages ---
        function setFileInputStatus(statusElement, message, type = 'default') {
            statusElement.textContent = message; [cite: 90]
            statusElement.classList.remove('success', 'error', 'loading'); [cite: 90]
            if (type === 'success') statusElement.classList.add('success'); [cite: 90]
            else if (type === 'error') statusElement.classList.add('error'); [cite: 91]
            else if (type === 'loading') statusElement.classList.add('loading'); [cite: 91]
        }

        // Helper function to convert Google Drive share link to direct download link
        function convertToGoogleDriveDirectDownload(url) {
            if (!url) return url; [cite: 92]
            let convertedUrl = url; [cite: 92]
            const driveViewPattern = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/(view|edit|preview)/; [cite: 92]
            const match = url.match(driveViewPattern); [cite: 93]
            if (match && match[1]) { [cite: 93]
                const fileId = match[1]; [cite: 94]
                convertedUrl = `https://drive.google.com/uc?export=download&id=${fileId}`; [cite: 94]
            } else if (url.includes('drive.google.com/open?id=')) { [cite: 94]
                const idMatch = url.match(/id=([a-zA-Z0-9_-]+)/); [cite: 95]
                if (idMatch && idMatch[1]) { [cite: 95]
                    const fileId = idMatch[1]; [cite: 96]
                    convertedUrl = `https://drive.google.com/uc?export=download&id=${fileId}`; [cite: 96]
                }
            }
            return convertedUrl; [cite: 97]
        }

        // --- Function to Delete Product ---
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to permanently delist this product? This action cannot be undone.')) return; [cite: 98]
            try {
                await db.collection('products').doc(productId).delete(); [cite: 99]
                alert('Product delisted successfully!'); [cite: 99]
                await loadProducts(''); [cite: 99]
                await loadProductsForDashboard(); [cite: 99]
            } catch (error) {
                console.error("Error removing document: ", error); [cite: 100]
                alert('Error delisting product. Please try again. (Check Firestore rules if it fails)'); [cite: 101]
            }
        }

        // --- Functions ---
        function showTab(targetTabId) {
            tabs.forEach(t => {
                t.classList.remove('bg-blue-100');
                t.removeAttribute('aria-current');
            }); [cite: 102]
            const currentTab = document.querySelector(`a[data-tab="${targetTabId}"]`); [cite: 102]
            if (currentTab) {
                currentTab.classList.add('bg-blue-100'); [cite: 103]
                currentTab.setAttribute('aria-current', 'page'); [cite: 103]
            }
            sections.forEach(sec => {
                if (sec.id === targetTabId) sec.classList.remove('hidden');
                else sec.classList.add('hidden');
            }); [cite: 104]
        }

        function toggleProductForm(showForm) {
            if (showForm) {
                sellLandingContent.classList.add('hidden'); [cite: 105]
                productForm.classList.remove('hidden'); [cite: 105]
                showTab('sell'); [cite: 105]
                productUploadForm.reset(); [cite: 105]
                productFileUrlInput.value = ''; [cite: 105]
                previewImageUrlInput.value = ''; [cite: 105]
                setFileInputStatus(previewImageStatus, ''); [cite: 105]
                titleInput.classList.remove('input-invalid'); [cite: 105]
                descriptionInput.classList.remove('input-invalid'); [cite: 106]
                priceInput.classList.remove('input-invalid'); [cite: 106]
                openPreviewImageWidgetBtn.classList.remove('input-invalid'); [cite: 106]
                productFileUrlInput.classList.remove('input-invalid'); [cite: 106]
                paypalEmailInput.classList.remove('input-invalid'); [cite: 106]
                paypalEmailValidationMsg.textContent = ''; [cite: 106]
                previewImageContainer.classList.add('hidden'); [cite: 106]
                currentPreviewImage.src = ''; [cite: 106]
                paypalEmailContainer.classList.add('hidden'); [cite: 106]
                enableSubmitButton(); [cite: 107]
            } else {
                sellLandingContent.classList.remove('hidden'); [cite: 107]
                productForm.classList.add('hidden'); [cite: 107]
            }
        }

        function renderProducts(productArray, container, noResultsMsgElement, isDashboardView = false) {
            container.innerHTML = ''; [cite: 108]
            noResultsMsgElement.classList.add('hidden'); [cite: 108]
            if (productArray.length === 0) {
                noResultsMsgElement.classList.remove('hidden'); [cite: 109]
                noResultsMsgElement.textContent = isDashboardView ? 'No products listed on the dashboard.' : 'No products found matching your search.'; [cite: 109]
                return; [cite: 110]
            }
            productArray.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = `bg-white rounded-lg shadow p-4 flex flex-col product-card ${isDashboardView ? '' : 'interactive-card border border-transparent'}`;
                productCard.setAttribute('data-product-id', product.id);
                const displayPrice = parseFloat(product.price) === 0 ? 'Free' : `$${parseFloat(product.price).toFixed(2)}`; [cite: 111]
                let cardButtonsHtml = '';
                if (isDashboardView) {
                    cardButtonsHtml = `
                        <div class="mt-auto flex justify-end items-center pt-2">
                            <a href="${product.fileUrl}" target="_blank" download="${product.title.replace(/\s/g, '-')}" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition" aria-label="Download ${product.title}">Download</a> [cite: 112]
                            <button data-product-id="${product.id}" class="delist-product-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition ml-2">Delist</button>
                        </div>
                    `; [cite: 113, 114]
                }
                productCard.innerHTML = `
                    <img src="${product.previewImageUrl || 'https://via.placeholder.com/300x200?text=Product+Preview'}" alt="${product.title} preview" class="rounded mb-3 h-48 object-cover w-full" />
                    <h3 class="font-semibold text-lg mb-1">${product.title}</h3>
                    <p class="text-gray-600 text-sm flex-grow mb-2 overflow-hidden overflow-ellipsis whitespace-nowrap">${product.description}</p>
                    <div class="mt-auto flex justify-between items-center pt-2"> [cite: 115]
                        <span class="font-bold text-blue-600">${displayPrice}</span>
                        ${cardButtonsHtml}
                    </div>
                `; [cite: 116]
                container.appendChild(productCard); [cite: 117]
                if (isDashboardView) { [cite: 117]
                    const delistButton = productCard.querySelector('.delist-product-btn'); [cite: 118]
                    if (delistButton) { [cite: 118]
                        delistButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const productId = delistButton.getAttribute('data-product-id');
                            if (productId) deleteProduct(productId); [cite: 119]
                        }); [cite: 120]
                    }
                } else {
                    productCard.addEventListener('click', () => {
                        const productId = productCard.getAttribute('data-product-id');
                        if (productId) showProductDetails(productId); [cite: 121]
                    }); [cite: 122]
                }
            }); [cite: 123]
        }

        async function loadProducts(filterQuery = '') {
            productListContainer.innerHTML = ''; [cite: 124]
            noProductsMessage.textContent = 'Loading products...'; [cite: 124]
            noProductsMessage.classList.remove('hidden'); [cite: 124]
            try {
                const productsRef = db.collection('products').orderBy('createdAt', 'desc'); [cite: 125]
                const snapshot = await productsRef.get(); [cite: 125]
                const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); [cite: 125]
                window.allProducts = fetchedProducts; [cite: 126]
                const lowerCaseQuery = filterQuery.toLowerCase(); [cite: 126]
                const filteredProducts = fetchedProducts.filter(product =>
                    product.title.toLowerCase().includes(lowerCaseQuery) ||
                    product.description.toLowerCase().includes(lowerCaseQuery)
                ); [cite: 127]
                renderProducts(filteredProducts, productListContainer, noProductsMessage, false); [cite: 127]
            } catch (error) {
                console.error("Error loading products:", error); [cite: 128]
                noProductsMessage.textContent = 'Error loading products. Please try again.'; [cite: 128]
                noProductsMessage.classList.remove('hidden'); [cite: 128]
            }
        }

        async function loadProductsForDashboard() {
            userProductsContainer.innerHTML = ''; [cite: 129]
            noUserProductsMessage.textContent = 'Loading your products...'; [cite: 129]
            noUserProductsMessage.classList.remove('hidden'); [cite: 129]

            const currentUser = auth.currentUser; // Get current user from Firebase Auth
            if (!currentUser) {
                noUserProductsMessage.textContent = 'Please log in to view your dashboard.';
                return;
            }

            try {
                const productsRef = db.collection('products')
                                      .where('sellerId', '==', currentUser.uid) // Filter by logged-in user's UID
                                      .orderBy('createdAt', 'desc'); [cite: 130]
                const snapshot = await productsRef.get(); [cite: 130]
                const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); [cite: 130]
                renderProducts(allProducts, userProductsContainer, noUserProductsMessage, true); [cite: 131]
            } catch (error) {
                console.error("Error loading products for dashboard:", error); [cite: 132]
                noUserProductsMessage.textContent = 'Error loading your products for dashboard. Please try again.'; [cite: 132]
                noUserProductsMessage.classList.remove('hidden'); [cite: 133]
            }
        }

        // --- Product Details Page + PayPal Smart Button ---
        async function showProductDetails(productId) {
            showTab('productDetails'); [cite: 134]
            productDetailsError.classList.add('hidden'); [cite: 134]
            try {
                const productDoc = await db.collection('products').doc(productId).get(); [cite: 135]
                if (!productDoc.exists) { [cite: 135]
                    productDetailsError.textContent = 'Product not found.'; [cite: 136]
                    productDetailsError.classList.remove('hidden'); [cite: 136]
                    return;
                }
                const product = { id: productDoc.id, ...productDoc.data() }; [cite: 137]
                detailProductImage.src = product.previewImageUrl || 'https://via.placeholder.com/600x400?text=Product+Preview'; [cite: 137]
                detailProductTitle.textContent = product.title; [cite: 137]
                detailProductDescription.textContent = product.description; [cite: 138]
                const displayPrice = parseFloat(product.price) === 0 ? 'Free' : `$${parseFloat(product.price).toFixed(2)}`; [cite: 138]
                detailProductPrice.textContent = displayPrice; [cite: 138]
                detailActionButton.className = 'w-full py-3 rounded-xl font-semibold transition'; [cite: 138]
                detailActionButton.disabled = false; [cite: 139]

                if (parseFloat(product.price) > 0) { [cite: 139]
                    detailActionButton.style.display = 'none'; [cite: 140]
                    paypalButtonContainer.innerHTML = ''; [cite: 140]

                    // Add a small delay to ensure PayPal SDK is fully initialized
                    setTimeout(() => {
                        if (typeof paypal !== "undefined" && paypal.Buttons) { [cite: 140]
                            paypal.Buttons({
                                createOrder: function(data, actions) { [cite: 141]
                                    return actions.order.create({
                                        purchase_units: [{
                                            amount: { value: product.price.toString() }, [cite: 141, 142]
                                            description: product.title [cite: 142]
                                        }]
                                    }); [cite: 143]
                                },
                                onApprove: function(data, actions) { [cite: 143]
                                    return actions.order.capture().then(function(details) {
                                        alert('Payment completed by ' + details.payer.name.given_name + '!'); [cite: 144]
                                        // For now, show the download link after payment
                                        paypalButtonContainer.innerHTML = `<a href="${product.fileUrl}" target="_blank" class="w-full block bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-xl font-semibold mt-6">Download Product</a>`; [cite: 145, 146]
                                    });
                                },
                                onError: function(err) { [cite: 146]
                                    alert('Payment could not be completed. Please try again.'); [cite: 147]
                                    console.error(err); [cite: 147]
                                }
                            }).render('#paypal-button-container'); [cite: 148]
                        } else {
                            paypalButtonContainer.innerHTML = '<p class="text-red-600">PayPal buttons could not be loaded. Please refresh.</p>'; [cite: 149]
                        }
                    }, 500); // 500ms delay
                } else {
                    detailActionButton.style.display = ''; [cite: 150]
                    paypalButtonContainer.innerHTML = ''; [cite: 150]
                    detailActionButton.textContent = 'Download'; [cite: 150]
                    detailActionButton.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white'); [cite: 150]
                    detailActionButton.onclick = () => {
                        window.open(product.fileUrl, '_blank'); [cite: 151]
                    };
                    detailActionButton.setAttribute('aria-label', `Download ${product.title}`); [cite: 151]
                }

            } catch (error) {
                console.error("Error loading product details:", error); [cite: 152]
                productDetailsError.textContent = 'Error loading product details. Please try again.'; [cite: 152]
                productDetailsError.classList.remove('hidden'); [cite: 153]
            }
        }

        // --- Cloudinary Widget Setup for Preview Image ---
        const previewImageWidget = cloudinary.createUploadWidget(
            {
                cloudName: CLOUDINARY_CLOUD_NAME,
                uploadPreset: CLOUDINARY_UPLOAD_PRESET,
                sources: ['local'],
                resourceType: 'image', [cite: 154]
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'svg'], [cite: 154]
                maxFileSize: 10 * 1024 * 1024, [cite: 154]
                multiple: false, [cite: 154]
                folder: 'tradedeck_product_previews', [cite: 155]
            },
            (error, result) => {
                if (!error && result && result.event === "success") {
                    previewImageUrlInput.value = result.info.secure_url; [cite: 155]
                    setFileInputStatus(previewImageStatus, `Image uploaded: ${result.info.original_filename}.${result.info.format}`, 'success'); [cite: 156]
                    openPreviewImageWidgetBtn.classList.remove('input-invalid'); [cite: 156]
                    currentPreviewImage.src = result.info.secure_url; [cite: 157]
                    previewImageContainer.classList.remove('hidden'); [cite: 157]
                    isPreviewImageUploading = false; [cite: 157]
                    enableSubmitButton(); [cite: 157]
                } else if (error) {
                    setFileInputStatus(previewImageStatus, 'Image upload failed. Please try again.', 'error'); [cite: 158]
                    previewImageUrlInput.value = ''; [cite: 158]
                    openPreviewImageWidgetBtn.classList.add('input-invalid'); [cite: 158]
                    previewImageContainer.classList.add('hidden'); [cite: 158]
                    currentPreviewImage.src = ''; [cite: 158]
                    isPreviewImageUploading = false; [cite: 159]
                    enableSubmitButton(); [cite: 159]
                } else if (result && (result.event === "close" || result.event === "abort")) { [cite: 159]
                    if (previewImageUrlInput.value === '') { [cite: 159]
                        setFileInputStatus(previewImageStatus, 'Preview image selection cancelled or not provided.', 'error'); [cite: 160]
                        openPreviewImageWidgetBtn.classList.add('input-invalid'); [cite: 160]
                    }
                    isPreviewImageUploading = false; [cite: 161]
                    enableSubmitButton(); [cite: 161]
                } else if (result && result.event === "asset_selected") { [cite: 161]
                    setFileInputStatus(previewImageStatus, `Uploading ${result.info.original_filename || 'image'}...`, 'loading'); [cite: 162]
                    isPreviewImageUploading = true; [cite: 162]
                    disableSubmitButton(); [cite: 162]
                }
            }
        ); [cite: 163]

        // --- Submit Button Management ---
        function disableSubmitButton() {
            submitProductBtn.disabled = true; [cite: 164]
            submitProductBtn.classList.add('opacity-50', 'cursor-not-allowed'); [cite: 164]
        }
        function enableSubmitButton() {
            const titleFilled = titleInput.value.trim() !== ''; [cite: 165]
            const descriptionFilled = descriptionInput.value.trim() !== ''; [cite: 165]
            const priceValid = !isNaN(parseFloat(priceInput.value)) && parseFloat(priceInput.value) >= 0; [cite: 166]
            const productFileUrlPresentAndValid = productFileUrlInput.value.trim() !== '' && /^https?:\/\/.+\..+/.test(productFileUrlInput.value.trim()); [cite: 166]
            const previewImageUrlPresent = previewImageUrlInput.value !== ''; [cite: 167]
            const paypalEmailValid = paypalEmailContainer.classList.contains('hidden') || (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(paypalEmailInput.value.trim()) && paypalEmailInput.value.trim() !== ''); [cite: 167]
            titleInput.classList.toggle('input-invalid', !titleFilled); [cite: 167]
            descriptionInput.classList.toggle('input-invalid', !descriptionFilled); [cite: 168]
            priceInput.classList.toggle('input-invalid', !priceValid); [cite: 168]
            productFileUrlInput.classList.toggle('input-invalid', !productFileUrlPresentAndValid); [cite: 168]
            openPreviewImageWidgetBtn.classList.toggle('input-invalid', !previewImageUrlPresent); [cite: 168]
            if (!paypalEmailContainer.classList.contains('hidden')) { [cite: 168]
                paypalEmailInput.classList.toggle('input-invalid', !paypalEmailValid); [cite: 169]
                paypalEmailValidationMsg.textContent = !paypalEmailValid && paypalEmailInput.value.trim() !== '' ? 'Please enter a valid PayPal email.' : ''; [cite: 170]
            } else {
                paypalEmailInput.classList.remove('input-invalid'); [cite: 171]
                paypalEmailValidationMsg.textContent = ''; [cite: 171]
            }
            if (!isPreviewImageUploading &&
                titleFilled &&
                descriptionFilled &&
                priceValid &&
                productFileUrlPresentAndValid &&
                previewImageUrlPresent && [cite: 172]
                paypalEmailValid) {
                submitProductBtn.disabled = false; [cite: 173]
                submitProductBtn.classList.remove('opacity-50', 'cursor-not-allowed'); [cite: 173]
            } else {
                disableSubmitButton(); [cite: 174]
            }
        }

        // --- Event Listeners ---
        tabs.forEach(tab => {
            tab.addEventListener('click', async (e) => {
                e.preventDefault();
                const target = tab.getAttribute('data-tab');
                showTab(target);
                if (target !== 'sell' && !productForm.classList.contains('hidden')) { [cite: 175]
                    toggleProductForm(false); [cite: 175]
                }
                productDetailsSection.classList.add('hidden'); [cite: 175]
                if (target === 'home') {
                    await loadProducts(searchBar.value.trim()); [cite: 176]
                    searchBar.value = ''; [cite: 176]
                } else if (target === 'dashboard') {
                    await loadProductsForDashboard(); [cite: 176]
                }
            }); [cite: 177, 178]
        });
        backToHomeBtn.addEventListener('click', () => { [cite: 178]
            showTab('home'); [cite: 178]
            loadProducts(searchBar.value.trim()); [cite: 178]
        });
        startSellingBtn.addEventListener('click', () => { [cite: 179]
            toggleProductForm(true); [cite: 179]
        });
        productUploadForm.addEventListener('submit', async (e) => { [cite: 180]
            e.preventDefault();
            disableSubmitButton();
            submitProductBtn.textContent = 'Listing...';
            enableSubmitButton();
            if (submitProductBtn.disabled) { [cite: 180]
                alert('Please fill out all required fields correctly before listing your product.'); [cite: 181]
                submitProductBtn.textContent = 'List Product'; [cite: 181]
                return; [cite: 181]
            }
            try {
                const finalProductFileUrl = convertToGoogleDriveDirectDownload(productFileUrlInput.value.trim()); [cite: 181]

                // Ensure user is logged in before getting UID
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    alert('You must be signed in to list a product.');
                    submitProductBtn.textContent = 'List Product';
                    enableSubmitButton();
                    return;
                }

                const newProduct = {
                    title: titleInput.value.trim(), [cite: 182]
                    description: descriptionInput.value.trim(), [cite: 182]
                    price: parseFloat(priceInput.value), [cite: 182]
                    fileUrl: finalProductFileUrl, [cite: 182]
                    previewImageUrl: previewImageUrlInput.value, [cite: 183]
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), [cite: 183]
                    sellerId: currentUser.uid, // Use the actual logged-in user's UID
                    paypalEmail: paypalEmailInput.value.trim() [cite: 183]
                };
                await db.collection('products').add(newProduct); [cite: 184]
                alert('Product listed successfully!'); [cite: 184]
                toggleProductForm(false); [cite: 184]
                await loadProducts(''); [cite: 184]
            } catch (error) {
                console.error("Error adding document to Firestore:", error); [cite: 185]
                alert('Failed to list product. Please check console for details. (Check Firestore rules!)'); [cite: 186]
            } finally {
                enableSubmitButton(); [cite: 187]
                submitProductBtn.textContent = 'List Product'; [cite: 187]
            }
        });

        titleInput.addEventListener('input', enableSubmitButton); [cite: 187]
        descriptionInput.addEventListener('input', enableSubmitButton); [cite: 188]
        priceInput.addEventListener('input', enableSubmitButton); [cite: 188]
        productFileUrlInput.addEventListener('input', enableSubmitButton); [cite: 188]
        previewImageUrlInput.addEventListener('input', enableSubmitButton); [cite: 188]
        paypalEmailInput.addEventListener('input', enableSubmitButton); [cite: 189]

        openPreviewImageWidgetBtn.addEventListener('click', () => { [cite: 189]
            previewImageWidget.open(); [cite: 189]
        });
        priceInput.addEventListener('input', () => { [cite: 189]
            const price = parseFloat(priceInput.value); [cite: 190]
            if (isNaN(price) || price === 0) { [cite: 190]
                paypalEmailContainer.classList.add('hidden'); [cite: 190]
                paypalEmailInput.removeAttribute('required'); [cite: 190]
                paypalEmailInput.value = ''; [cite: 190]
            } else { [cite: 190]
                paypalEmailContainer.classList.remove('hidden'); [cite: 190]
                paypalEmailInput.setAttribute('required', 'required'); [cite: 190]
            }
            enableSubmitButton(); [cite: 191]
        });

        // --- Google Auth Sign In ---
        googleSignInBtn.onclick = async () => { [cite: 229]
            const provider = new firebase.auth.GoogleAuthProvider(); [cite: 230]
            try {
                await auth.signInWithPopup(provider); [cite: 231]
                // Triggers onAuthStateChanged
            } catch (e) {
                alert("Sign in failed: " + e.message); [cite: 232]
            }
        };

        // --- Profile Dropdown ---
        profilePicBtn && profilePicBtn.addEventListener('click', (e) => { [cite: 232]
            e.stopPropagation(); [cite: 233]
            profileDropdown.classList.toggle('show'); [cite: 233]
        });
        document.addEventListener('click', () => profileDropdown.classList.remove('show')); [cite: 233]

        // --- Sign Out ---
        signOutBtn && signOutBtn.addEventListener('click', async () => { [cite: 233]
            await auth.signOut(); [cite: 234]
        });

        // --- Delete Account ---
        deleteAccountBtn && deleteAccountBtn.addEventListener('click', async () => { [cite: 234]
            if (!confirm("This will permanently delete your account and all your products. This cannot be undone!")) return; [cite: 234]
            const user = auth.currentUser; [cite: 234]
            if (!user) return; [cite: 235]
            try {
                await db.collection('users').doc(user.uid).delete(); [cite: 235]
                const products = await db.collection('products').where('sellerId', '==', user.uid).get(); [cite: 235]
                const batch = db.batch(); [cite: 235]
                products.docs.forEach(doc => batch.delete(doc.ref)); [cite: 235]
                await batch.commit(); [cite: 235]
                await user.delete(); [cite: 236]
                alert("Your account was deleted."); [cite: 236]
            } catch (e) {
                alert("Error deleting account: " + e.message + ". Try signing out and in again, then retry."); [cite: 236]
            }
        });

        // --- Auth State Change Handler ---
        auth.onAuthStateChanged(async user => { [cite: 237]
            if (user) {
                userSessionId = await user.getIdToken(); [cite: 238]
                const userData = {
                    uid: user.uid, [cite: 238]
                    displayName: user.displayName, [cite: 238]
                    email: user.email, [cite: 238]
                    photoURL: user.photoURL, [cite: 239]
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp() [cite: 239]
                };
                await db.collection('users').doc(user.uid).set(userData, { merge: true }); [cite: 239]

                landingPage.style.display = 'none'; [cite: 240]
                profileHeader.style.display = ''; [cite: 240]
                mainApp.style.display = 'flex'; [cite: 240]

                profilePic.src = user.photoURL; [cite: 240]
                profileName.textContent = user.displayName || user.email; [cite: 240]
                window.currentUser = user; [cite: 241]
                window.currentUserSessionId = userSessionId; [cite: 241]

                // Initial load of products on home tab ONLY if logged in
                await loadProducts();
                showTab('home');

            } else {
                landingPage.style.display = ''; [cite: 241]
                profileHeader.style.display = 'none'; [cite: 241]
                mainApp.style.display = 'none'; [cite: 242]
                window.currentUser = null; [cite: 242]
                window.currentUserSessionId = null; [cite: 242]
            }
        });

        // 7. Initial load of products on home tab (Moved into auth.onAuthStateChanged)
        // document.addEventListener('DOMContentLoaded', async () => {
        //     await loadProducts();
        //     showTab('home');
        // });

        // 8. Search bar functionality
        searchBar.addEventListener('input', () => { [cite: 192]
            if (!document.getElementById('home').classList.contains('hidden')) { [cite: 192]
                const query = searchBar.value.trim(); [cite: 192]
                const filteredProducts = window.allProducts.filter(product =>
                    product.title.toLowerCase().includes(query.toLowerCase()) ||
                    product.description.toLowerCase().includes(query.toLowerCase())
                ); [cite: 193]
                renderProducts(filteredProducts, productListContainer, noProductsMessage, false); [cite: 193]
            }
        });
    </script>
</body>
</html>

Sources





have i thanked you anywhere in this covo


yes ok

Based on our conversation history, you have thanked me in this conversation in the following instances:

"yes it does work thank you so much"

Sources










Deep Research

Canvas

Gemini can make mistakes, so double-check it

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TradeDeck</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- PAYPAL SMART BUTTON SDK (replace with your real client-id) -->
    <script src="https://www.paypal.com/sdk/js?client-id=ARu2vaXOZIkpnPNCMe5ofx1SpsJnHnFKZv6SvAZTaqBD6YfRYfgd-E-Sz7FrbWJPfHXDfBVcPNfw-RoO&currency=USD"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        main section {
            transition: opacity 0.3s ease-in-out;
        }
        main section.hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            position: absolute;
            pointer-events: none;
            visibility: hidden;
        }
        .cloudinary-file-input {
            @apply w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer;
        }
        .file-upload-status {
            @apply text-sm mt-1;
        }
        .file-upload-status.success {
            @apply text-green-600;
        }
        .file-upload-status.error {
            @apply text-red-500;
        }
        .file-upload-status.loading {
            @apply text-blue-500 italic;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .product-card {
            transition: all 0.2s ease-in-out;
        }
        .input-invalid {
            border-color: #ef4444;
            box-shadow: 0 0 0 1px #ef4444;
        }
        .interactive-card {
            cursor: pointer;
        }
        .interactive-card:hover {
            border-color: #60a5fa;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col" aria-label="Sidebar navigation">
            <h1 class="text-2xl font-bold text-blue-600 mb-8">TradeDeck</h1>
            <nav class="space-y-4 flex-grow">
                <a href="#home" class="block py-2 px-4 rounded-lg text-gray-700 bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="home" tabindex="0" aria-current="page">Home</a>
                <a href="#sell" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="sell" tabindex="0">Sell</a>
                <a href="#dashboard" class="block py-2 px-4 rounded-lg text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600" data-tab="dashboard" tabindex="0">Dashboard</a>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-10" aria-live="polite">

            <section id="home" aria-label="Home Products">
                <div class="max-w-5xl mx-auto">
                    <input
                        type="search"
                        id="searchBar"
                        aria-label="Search products"
                        placeholder="Search products..."
                        class="w-full mb-8 px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                    <div
                        id="productList"
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
                    >
                        <p id="noProductsMessage" class="col-span-full text-center text-gray-500 hidden">Loading products...</p>
                    </div>
                </div>
            </section>

            <section id="productDetails" class="hidden">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <button id="backToHomeBtn" class="mb-6 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition focus:outline-none focus:ring-2 focus:ring-gray-400">
                        &larr; Back to Home
                    </button>
                    <div id="productDetailsContent">
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="md:w-1/2">
                                <img id="detailProductImage" src="" alt="Product image" class="w-full h-auto rounded-lg shadow-md object-cover max-h-96" />
                            </div>
                            <div class="md:w-1/2 flex flex-col justify-between">
                                <div>
                                    <h2 id="detailProductTitle" class="text-3xl font-bold text-gray-900 mb-2"></h2>
                                    <p id="detailProductDescription" class="text-gray-700 mb-4 text-justify"></p>
                                    <p class="text-2xl font-extrabold text-blue-600 mb-6" id="detailProductPrice"></p>
                                </div>
                                <div class="mt-auto">
                                    <button id="detailActionButton" class="w-full py-3 rounded-xl font-semibold transition"></button>
                                    <div id="paypal-button-container" class="mt-6"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p id="productDetailsError" class="text-red-500 text-center mt-4 hidden">Product details could not be loaded.</p>
                </div>
            </section>

            <section id="sell" class="hidden">
                <div class="max-w-6xl mx-auto mt-16 px-4">
                    <div id="sellLandingContent">
                        <div class="text-center mb-16">
                            <h2 class="text-4xl font-extrabold text-gray-900 mb-4">
                                Turn Your Digital Assets Into Revenue
                            </h2>
                            <p class="text-lg text-gray-600 mb-6">
                                Whether it's eBooks, guides, software, templates, or creative packs‚ÄîTradeDeck gives you the tools to sell to a global audience instantly.
                            </p>
                            <button
                                id="startSellingBtn"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold px-8 py-3 rounded-xl shadow-md transition duration-300"
                            >
                                Start Selling Now
                            </button>
                        </div>

                        <div class="mb-20">
                            <h3 class="text-2xl font-semibold text-gray-800 mb-8 text-center">How It Works</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-blue-600 text-4xl mb-4">üìÅ</div>
                                    <h4 class="text-lg font-semibold mb-2">Upload Your Product</h4>
                                    <p class="text-gray-600 text-sm">
                                        PDFs, images, ZIPs, templates, code bundles, and more‚Äîjust drag and drop.
                                    </p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-green-500 text-4xl mb-4">‚öôÔ∏è</div>
                                    <h4 class="text-lg font-semibold mb-2">Customize & Price</h4>
                                    <p class="text-gray-600 text-sm">
                                        Set your price, description, preview images, and license terms.
                                    </p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <div class="text-purple-500 text-4xl mb-4">üí∏</div>
                                    <h4 class="text-lg font-semibold mb-2">Get Paid Securely</h4>
                                    <p class="text-gray-600 text-sm">
                                        Your sales are paid directly to your connected PayPal account.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="productForm" class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto hidden">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">List Your Digital Product</h3>
                        <form id="productUploadForm" class="space-y-6">
                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Product Title</label>
                                <input
                                    type="text"
                                    id="title"
                                    name="title"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., Ultimate eBook Template Pack"
                                />
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Product Description</label>
                                <textarea
                                    id="description"
                                    name="description"
                                    rows="4"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Describe your product in detail..."
                                ></textarea>
                            </div>
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                                <input
                                    type="number"
                                    id="price"
                                    name="price"
                                    min="0"
                                    step="0.01"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., 29.99 (enter 0 for free)"
                                />
                            </div>
                            <div id="paypalEmailContainer" class="hidden">
                                <label for="paypalEmail" class="block text-sm font-medium text-gray-700 mb-1">PayPal Email</label>
                                <input
                                    type="email"
                                    id="paypalEmail"
                                    name="paypalEmail"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., yourname@example.com"
                                />
                                <p id="paypalEmailValidationMsg" class="text-red-500 text-sm mt-1"></p>
                                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-2" role="alert">
                                    <p class="font-bold">‚ö†Ô∏è ENSURE YOUR PAYPAL EMAIL IS VALID</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-sm">How to get a valid PayPal email and why it's important</summary>
                                        <p class="text-xs mt-1">To ensure you receive your funds, use the primary email associated with your verified PayPal account. If the email is invalid or not associated with a PayPal account, payouts may fail.</p>
                                    </details>
                                </div>
                            </div>
                            <div>
                                <label for="previewImageInput" class="block text-sm font-medium text-gray-700 mb-1">Product Preview Image (for home tab)</label>
                                <button type="button" id="openPreviewImageWidget" class="cloudinary-file-input">Choose file</button>
                                <input type="hidden" id="previewImageUrl" name="previewImageUrl">
                                <p id="previewImageStatus" class="file-upload-status"></p>
                                <div id="previewImageContainer" class="mt-2 hidden">
                                    <img id="currentPreviewImage" src="" alt="Product preview" class="max-w-xs h-32 object-cover rounded-md border border-gray-300" />
                                </div>
                            </div>
                            <div>
                                <label for="productFileUrlInput" class="block text-sm font-medium text-gray-700 mb-1">Digital Product File Link (Google Drive, Dropbox, etc.)</label>
                                <input
                                    type="url"
                                    id="productFileUrlInput"
                                    name="productFileUrl"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Paste your direct download link here (e.g., from Google Drive, Dropbox)"
                                />
                                <p class="text-sm text-gray-500 mt-1">Make sure this link is publicly accessible for download.</p>
                            </div>
                            <button
                                type="submit"
                                id="submitProductBtn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold transition"
                            >
                                List Product
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="dashboard" class="hidden">
                <div class="max-w-6xl mx-auto mt-16 px-4">
                    <h2 class="text-4xl font-bold mb-8">DASHBOARD</h2>
                    <div id="userProducts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p id="noUserProductsMessage" class="col-span-full text-center text-gray-500 hidden">No products listed yet.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'desejdvif';
        const CLOUDINARY_UPLOAD_PRESET = 'TradeDeck user products';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0RFkuXJjh7X43R6wWdQKrXtdUwVJ-4js",
            authDomain: "tradedeck-82bbb.firebaseapp.com",
            projectId: "tradedeck-82bbb",
            storageBucket: "tradedeck-82bbb.firebasestorage.app",
            messagingSenderId: "755235931546",
            appId: "1:755235931546:web:7e35364b0157cd7fc2a623",
            measurementId: "G-4RXR7V9NCW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Global Variables ---
        const tabs = document.querySelectorAll('aside nav a[data-tab]');
        const sections = document.querySelectorAll('main section');
        const startSellingBtn = document.getElementById('startSellingBtn');
        const sellLandingContent = document.getElementById('sellLandingContent');
        const productForm = document.getElementById('productForm');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const priceInput = document.getElementById('price');
        const paypalEmailContainer = document.getElementById('paypalEmailContainer');
        const paypalEmailInput = document.getElementById('paypalEmail');
        const paypalEmailValidationMsg = document.getElementById('paypalEmailValidationMsg');
        const productFileUrlInput = document.getElementById('productFileUrlInput');
        const openPreviewImageWidgetBtn = document.getElementById('openPreviewImageWidget');
        const previewImageUrlInput = document.getElementById('previewImageUrl');
        const previewImageStatus = document.getElementById('previewImageStatus');
        const previewImageContainer = document.getElementById('previewImageContainer');
        const currentPreviewImage = document.getElementById('currentPreviewImage');
        const productUploadForm = document.getElementById('productUploadForm');
        const submitProductBtn = document.getElementById('submitProductBtn');
        const searchBar = document.getElementById('searchBar');
        const productListContainer = document.getElementById('productList');
        const noProductsMessage = document.getElementById('noProductsMessage');
        const userProductsContainer = document.getElementById('userProducts');
        const noUserProductsMessage = document.getElementById('noUserProductsMessage');
        const productDetailsSection = document.getElementById('productDetails');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const detailProductImage = document.getElementById('detailProductImage');
        const detailProductTitle = document.getElementById('detailProductTitle');
        const detailProductDescription = document.getElementById('detailProductDescription');
        const detailProductPrice = document.getElementById('detailProductPrice');
        const detailActionButton = document.getElementById('detailActionButton');
        const productDetailsError = document.getElementById('productDetailsError');
        const paypalButtonContainer = document.getElementById('paypal-button-container');
        let isPreviewImageUploading = false;

        function setFileInputStatus(statusElement, message, type = 'default') {
            statusElement.textContent = message;
            statusElement.classList.remove('success', 'error', 'loading');
            if (type === 'success') statusElement.classList.add('success');
            else if (type === 'error') statusElement.classList.add('error');
            else if (type === 'loading') statusElement.classList.add('loading');
        }

        function convertToGoogleDriveDirectDownload(url) {
            if (!url) return url;
            let convertedUrl = url;
            const driveViewPattern = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/(view|edit|preview)/;
            const match = url.match(driveViewPattern);
            if (match && match[1]) {
                const fileId = match[1];
                convertedUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            } else if (url.includes('drive.google.com/open?id=')) {
                const idMatch = url.match(/id=([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) {
                    const fileId = idMatch[1];
                    convertedUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                }
            }
            return convertedUrl;
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to permanently delist this product? This action cannot be undone.')) return;
            try {
                await db.collection('products').doc(productId).delete();
                alert('Product delisted successfully!');
                await loadProducts('');
                await loadProductsForDashboard();
            } catch (error) {
                console.error("Error removing document: ", error);
                alert('Error delisting product. Please try again. (Check Firestore rules if it fails)');
            }
        }

        function showTab(targetTabId) {
            tabs.forEach(t => {
                t.classList.remove('bg-blue-100');
                t.removeAttribute('aria-current');
            });
            const currentTab = document.querySelector(`a[data-tab="${targetTabId}"]`);
            if (currentTab) {
                currentTab.classList.add('bg-blue-100');
                currentTab.setAttribute('aria-current', 'page');
            }
            sections.forEach(sec => {
                if (sec.id === targetTabId) sec.classList.remove('hidden');
                else sec.classList.add('hidden');
            });
        }

        function toggleProductForm(showForm) {
            if (showForm) {
                sellLandingContent.classList.add('hidden');
                productForm.classList.remove('hidden');
                showTab('sell');
                productUploadForm.reset();
                productFileUrlInput.value = '';
                previewImageUrlInput.value = '';
                setFileInputStatus(previewImageStatus, '');
                titleInput.classList.remove('input-invalid');
                descriptionInput.classList.remove('input-invalid');
                priceInput.classList.remove('input-invalid');
                openPreviewImageWidgetBtn.classList.remove('input-invalid');
                productFileUrlInput.classList.remove('input-invalid');
                paypalEmailInput.classList.remove('input-invalid');
                paypalEmailValidationMsg.textContent = '';
                previewImageContainer.classList.add('hidden');
                currentPreviewImage.src = '';
                paypalEmailContainer.classList.add('hidden');
                enableSubmitButton();
            } else {
                sellLandingContent.classList.remove('hidden');
                productForm.classList.add('hidden');
            }
        }

        function renderProducts(productArray, container, noResultsMsgElement, isDashboardView = false) {
            container.innerHTML = '';
            noResultsMsgElement.classList.add('hidden');
            if (productArray.length === 0) {
                noResultsMsgElement.classList.remove('hidden');
                noResultsMsgElement.textContent = isDashboardView ? 'No products listed on the dashboard.' : 'No products found matching your search.';
                return;
            }
            productArray.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = `bg-white rounded-lg shadow p-4 flex flex-col product-card ${isDashboardView ? '' : 'interactive-card border border-transparent'}`;
                productCard.setAttribute('data-product-id', product.id);
                const displayPrice = parseFloat(product.price) === 0 ? 'Free' : `$${parseFloat(product.price).toFixed(2)}`;
                let cardButtonsHtml = '';
                if (isDashboardView) {
                    cardButtonsHtml = `
                        <div class="mt-auto flex justify-end items-center pt-2">
                            <a href="${product.fileUrl}" target="_blank" download="${product.title.replace(/\s/g, '-')}" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition" aria-label="Download ${product.title}">Download</a>
                            <button data-product-id="${product.id}" class="delist-product-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition ml-2">Delist</button>
                        </div>
                    `;
                }
                productCard.innerHTML = `
                    <img src="${product.previewImageUrl || 'https://via.placeholder.com/300x200?text=Product+Preview'}" alt="${product.title} preview" class="rounded mb-3 h-48 object-cover w-full" />
                    <h3 class="font-semibold text-lg mb-1">${product.title}</h3>
                    <p class="text-gray-600 text-sm flex-grow mb-2 overflow-hidden overflow-ellipsis whitespace-nowrap">${product.description}</p>
                    <div class="mt-auto flex justify-between items-center pt-2">
                        <span class="font-bold text-blue-600">${displayPrice}</span>
                        ${cardButtonsHtml}
                    </div>
                `;
                container.appendChild(productCard);
                if (isDashboardView) {
                    const delistButton = productCard.querySelector('.delist-product-btn');
                    if (delistButton) {
                        delistButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const productId = delistButton.getAttribute('data-product-id');
                            if (productId) deleteProduct(productId);
                        });
                    }
                } else {
                    productCard.addEventListener('click', () => {
                        const productId = productCard.getAttribute('data-product-id');
                        if (productId) showProductDetails(productId);
                    });
                }
            });
        }

        async function loadProducts(filterQuery = '') {
            productListContainer.innerHTML = '';
            noProductsMessage.textContent = 'Loading products...';
            noProductsMessage.classList.remove('hidden');
            try {
                const productsRef = db.collection('products').orderBy('createdAt', 'desc');
                const snapshot = await productsRef.get();
                const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.allProducts = fetchedProducts;
                const lowerCaseQuery = filterQuery.toLowerCase();
                const filteredProducts = fetchedProducts.filter(product =>
                    product.title.toLowerCase().includes(lowerCaseQuery) ||
                    product.description.toLowerCase().includes(lowerCaseQuery)
                );
                renderProducts(filteredProducts, productListContainer, noProductsMessage, false);
            } catch (error) {
                console.error("Error loading products:", error);
                noProductsMessage.textContent = 'Error loading products. Please try again.';
                noProductsMessage.classList.remove('hidden');
            }
        }

        async function loadProductsForDashboard() {
            userProductsContainer.innerHTML = '';
            noUserProductsMessage.textContent = 'Loading all products...';
            noUserProductsMessage.classList.remove('hidden');
            try {
                const productsRef = db.collection('products').orderBy('createdAt', 'desc');
                const snapshot = await productsRef.get();
                const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(allProducts, userProductsContainer, noUserProductsMessage, true);
            } catch (error) {
                console.error("Error loading products for dashboard:", error);
                noUserProductsMessage.textContent = 'Error loading products for dashboard. Please try again.';
                noUserProductsMessage.classList.remove('hidden');
            }
        }

        // --- FIXED: Product Details Page + PayPal Smart Button ---
        async function showProductDetails(productId) {
            showTab('productDetails');
            productDetailsError.classList.add('hidden');
            try {
                const productDoc = await db.collection('products').doc(productId).get();
                if (!productDoc.exists) {
                    productDetailsError.textContent = 'Product not found.';
                    productDetailsError.classList.remove('hidden');
                    return;
                }
                const product = { id: productDoc.id, ...productDoc.data() };
                detailProductImage.src = product.previewImageUrl || 'https://via.placeholder.com/600x400?text=Product+Preview';
                detailProductTitle.textContent = product.title;
                detailProductDescription.textContent = product.description;
                const displayPrice = parseFloat(product.price) === 0 ? 'Free' : `$${parseFloat(product.price).toFixed(2)}`;
                detailProductPrice.textContent = displayPrice;
                detailActionButton.className = 'w-full py-3 rounded-xl font-semibold transition';
                detailActionButton.disabled = false;

                if (parseFloat(product.price) > 0) {
                    detailActionButton.style.display = 'none';
                    paypalButtonContainer.innerHTML = '';
                    if (typeof paypal !== "undefined" && paypal.Buttons) {
                        paypal.Buttons({
                            createOrder: function(data, actions) {
                                return actions.order.create({
                                    purchase_units: [{
                                        amount: { value: product.price.toString() },
                                        description: product.title
                                    }]
                                });
                            },
                            onApprove: function(data, actions) {
                                return actions.order.capture().then(function(details) {
                                    alert('Payment completed by ' + details.payer.name.given_name + '!');
                                    // Optionally: record transaction, show download, etc.
                                    // For now, show the download link after payment
                                    paypalButtonContainer.innerHTML = `<a href="${product.fileUrl}" target="_blank" class="w-full block bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-xl font-semibold mt-6">Download Product</a>`;
                                });
                            },
                            onError: function(err) {
                                alert('Payment could not be completed. Please try again.');
                                console.error(err);
                            }
                        }).render('#paypal-button-container');
                    } else {
                        paypalButtonContainer.innerHTML = '<p class="text-red-600">PayPal buttons could not be loaded. Please refresh.</p>';
                    }
                } else {
                    detailActionButton.style.display = '';
                    paypalButtonContainer.innerHTML = '';
                    detailActionButton.textContent = 'Download';
                    detailActionButton.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                    detailActionButton.onclick = () => {
                        window.open(product.fileUrl, '_blank');
                    };
                    detailActionButton.setAttribute('aria-label', `Download ${product.title}`);
                }

            } catch (error) {
                console.error("Error loading product details:", error);
                productDetailsError.textContent = 'Error loading product details. Please try again.';
                productDetailsError.classList.remove('hidden');
            }
        }

        // --- Cloudinary Widget Setup for Preview Image ---
        const previewImageWidget = cloudinary.createUploadWidget(
            {
                cloudName: CLOUDINARY_CLOUD_NAME,
                uploadPreset: CLOUDINARY_UPLOAD_PRESET,
                sources: ['local'],
                resourceType: 'image',
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'svg'],
                maxFileSize: 10 * 1024 * 1024,
                multiple: false,
                folder: 'tradedeck_product_previews',
            },
            (error, result) => {
                if (!error && result && result.event === "success") {
                    previewImageUrlInput.value = result.info.secure_url;
                    setFileInputStatus(previewImageStatus, `Image uploaded: ${result.info.original_filename}.${result.info.format}`, 'success');
                    openPreviewImageWidgetBtn.classList.remove('input-invalid');
                    currentPreviewImage.src = result.info.secure_url;
                    previewImageContainer.classList.remove('hidden');
                    isPreviewImageUploading = false;
                    enableSubmitButton();
                } else if (error) {
                    setFileInputStatus(previewImageStatus, 'Image upload failed. Please try again.', 'error');
                    previewImageUrlInput.value = '';
                    openPreviewImageWidgetBtn.classList.add('input-invalid');
                    previewImageContainer.classList.add('hidden');
                    currentPreviewImage.src = '';
                    isPreviewImageUploading = false;
                    enableSubmitButton();
                } else if (result && (result.event === "close" || result.event === "abort")) {
                    if (previewImageUrlInput.value === '') {
                        setFileInputStatus(previewImageStatus, 'Preview image selection cancelled or not provided.', 'error');
                        openPreviewImageWidgetBtn.classList.add('input-invalid');
                    }
                    isPreviewImageUploading = false;
                    enableSubmitButton();
                } else if (result && result.event === "asset_selected") {
                    setFileInputStatus(previewImageStatus, `Uploading ${result.info.original_filename || 'image'}...`, 'loading');
                    isPreviewImageUploading = true;
                    disableSubmitButton();
                }
            }
        );

        function disableSubmitButton() {
            submitProductBtn.disabled = true;
            submitProductBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        function enableSubmitButton() {
            const titleFilled = titleInput.value.trim() !== '';
            const descriptionFilled = descriptionInput.value.trim() !== '';
            const priceValid = !isNaN(parseFloat(priceInput.value)) && parseFloat(priceInput.value) >= 0;
            const productFileUrlPresentAndValid = productFileUrlInput.value.trim() !== '' && /^https?:\/\/.+\..+/.test(productFileUrlInput.value.trim());
            const previewImageUrlPresent = previewImageUrlInput.value !== '';
            const paypalEmailValid = paypalEmailContainer.classList.contains('hidden') || (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(paypalEmailInput.value.trim()) && paypalEmailInput.value.trim() !== '');
            titleInput.classList.toggle('input-invalid', !titleFilled);
            descriptionInput.classList.toggle('input-invalid', !descriptionFilled);
            priceInput.classList.toggle('input-invalid', !priceValid);
            productFileUrlInput.classList.toggle('input-invalid', !productFileUrlPresentAndValid);
            openPreviewImageWidgetBtn.classList.toggle('input-invalid', !previewImageUrlPresent);
            if (!paypalEmailContainer.classList.contains('hidden')) {
                paypalEmailInput.classList.toggle('input-invalid', !paypalEmailValid);
                paypalEmailValidationMsg.textContent = !paypalEmailValid && paypalEmailInput.value.trim() !== '' ? 'Please enter a valid PayPal email.' : '';
            } else {
                paypalEmailInput.classList.remove('input-invalid');
                paypalEmailValidationMsg.textContent = '';
            }
            if (!isPreviewImageUploading &&
                titleFilled &&
                descriptionFilled &&
                priceValid &&
                productFileUrlPresentAndValid &&
                previewImageUrlPresent &&
                paypalEmailValid) {
                submitProductBtn.disabled = false;
                submitProductBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                disableSubmitButton();
            }
        }

        // --- Event Listeners ---
        tabs.forEach(tab => {
            tab.addEventListener('click', async (e) => {
                e.preventDefault();
                const target = tab.getAttribute('data-tab');
                showTab(target);
                if (target !== 'sell' && !productForm.classList.contains('hidden')) {
                    toggleProductForm(false);
                }
                productDetailsSection.classList.add('hidden');
                if (target === 'home') {
                    await loadProducts(searchBar.value.trim());
                    searchBar.value = '';
                } else if (target === 'dashboard') {
                    await loadProductsForDashboard();
                }
            });
        });

        backToHomeBtn.addEventListener('click', () => {
            showTab('home');
            loadProducts(searchBar.value.trim());
        });

        startSellingBtn.addEventListener('click', () => {
            toggleProductForm(true);
        });

        productUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            disableSubmitButton();
            submitProductBtn.textContent = 'Listing...';
            enableSubmitButton();
            if (submitProductBtn.disabled) {
                alert('Please fill out all required fields correctly before listing your product.');
                submitProductBtn.textContent = 'List Product';
                return;
            }
            try {
                const finalProductFileUrl = convertToGoogleDriveDirectDownload(productFileUrlInput.value.trim());
                const newProduct = {
                    title: titleInput.value.trim(),
                    description: descriptionInput.value.trim(),
                    price: parseFloat(priceInput.value),
                    fileUrl: finalProductFileUrl,
                    previewImageUrl: previewImageUrlInput.value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    sellerId: 'placeholder_seller_id',
                    paypalEmail: paypalEmailInput.value.trim()
                };
                await db.collection('products').add(newProduct);
                alert('Product listed successfully!');
                toggleProductForm(false);
                await loadProducts('');
            } catch (error) {
                console.error("Error adding document to Firestore:", error);
                alert('Failed to list product. Please check console for details. (Check Firestore rules!)');
            } finally {
                enableSubmitButton();
                submitProductBtn.textContent = 'List Product';
            }
        });

        titleInput.addEventListener('input', enableSubmitButton);
        descriptionInput.addEventListener('input', enableSubmitButton);
        priceInput.addEventListener('input', enableSubmitButton);
        productFileUrlInput.addEventListener('input', enableSubmitButton);
        previewImageUrlInput.addEventListener('input', enableSubmitButton);
        paypalEmailInput.addEventListener('input', enableSubmitButton);

        openPreviewImageWidgetBtn.addEventListener('click', () => {
            previewImageWidget.open();
        });

        priceInput.addEventListener('input', () => {
            const price = parseFloat(priceInput.value);
            if (isNaN(price) || price === 0) {
                paypalEmailContainer.classList.add('hidden');
                paypalEmailInput.removeAttribute('required');
                paypalEmailInput.value = '';
            } else {
                paypalEmailContainer.classList.remove('hidden');
                paypalEmailInput.setAttribute('required', 'required');
            }
            enableSubmitButton();
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
            showTab('home');
        });

        searchBar.addEventListener('input', () => {
            if (!document.getElementById('home').classList.contains('hidden')) {
                const query = searchBar.value.trim();
                const filteredProducts = window.allProducts.filter(product =>
                    product.title.toLowerCase().includes(query.toLowerCase()) ||
                    product.description.toLowerCase().includes(query.toLowerCase())
                );
                renderProducts(filteredProducts, productListContainer, noProductsMessage, false);
            }
        });
    </script>
</body>
</html>
