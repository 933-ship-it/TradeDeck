import{initializeApp}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";import{getAuth,onAuthStateChanged,signOut,deleteUser}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";import{getFirestore,collection,doc,setDoc,getDoc,getDocs,addDoc,updateDoc,deleteDoc,query,where,orderBy,serverTimestamp,onSnapshot,runTransaction}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";const CLOUDINARY_CLOUD_NAME="desejdvif",CLOUDINARY_UPLOAD_PRESET="TradeDeck user products",SELL_FORM_KEY="TradeDeckSellForm",LANDING_URL="https://933-ship-it.github.io/TradeDeck.com/",firebaseConfig={apiKey:"AIzaSyA0RFkuXJjh7X43R6wWdQKrXtdUwVJ-4js",authDomain:"tradedeck-82bbb.firebaseapp.com",projectId:"tradedeck-82bbb",storageBucket:"tradedeck-82bbb.appspot.com",messagingSenderId:"755235931546",appId:"1:755235931546:web:7e35364b0157cd7fc2a623",measurementId:"G-4RXR7V9NCW"},app=initializeApp(firebaseConfig),db=getFirestore(app),auth=getAuth(app),profilePic=document.getElementById("userProfilePic"),dropdownMenu=document.getElementById("dropdownMenu"),userEmail=document.getElementById("userEmail"),authOverlay=document.getElementById("authOverlay");let userGlobal=null;const tabs=document.querySelectorAll("aside nav a[data-tab]"),sections=document.querySelectorAll("main section"),startSellingBtn=document.getElementById("startSellingBtn"),sellLandingContent=document.getElementById("sellLandingContent"),productForm=document.getElementById("productForm"),formErrorSummary=document.getElementById("formErrorSummary"),titleInput=document.getElementById("title"),descriptionInput=document.getElementById("description"),priceInput=document.getElementById("price"),paypalEmailContainer=document.getElementById("paypalEmailContainer"),paypalEmailInput=document.getElementById("paypalEmail"),paypalEmailValidationMsg=document.getElementById("paypalEmailValidationMsg"),productFileUrlInput=document.getElementById("productFileUrlInput"),openPreviewImageWidgetBtn=document.getElementById("openPreviewImageWidget"),previewImageUrlInput=document.getElementById("previewImageUrl"),previewImageStatus=document.getElementById("previewImageStatus"),previewImageContainer=document.getElementById("previewImageContainer"),currentPreviewImage=document.getElementById("currentPreviewImage"),productUploadForm=document.getElementById("productUploadForm"),submitProductBtn=document.getElementById("submitProductBtn"),searchBar=document.getElementById("searchBar"),productListContainer=document.getElementById("productList"),noProductsMessage=document.getElementById("noProductsMessage"),myProductsContainer=document.getElementById("myProducts"),noMyProductsMessage=document.getElementById("noMyProductsMessage"),sellerBalance=document.getElementById("sellerBalance"),productDetailsSection=document.getElementById("productDetails"),backToHomeBtn=document.getElementById("backToHomeBtn"),detailProductImage=document.getElementById("detailProductImage"),detailProductTitle=document.getElementById("detailProductTitle"),detailProductDescription=document.getElementById("detailProductDescription"),detailProductPrice=document.getElementById("detailProductPrice"),detailActionButton=document.getElementById("detailActionButton"),productDetailsError=document.getElementById("productDetailsError"),paypalButtonContainer=document.getElementById("paypal-button-container"),editProductModal=document.getElementById("editProductModal"),editProductForm=document.getElementById("editProductForm"),editProductIdInput=document.getElementById("editProductId"),editTitleInput=document.getElementById("editTitle"),editDescriptionInput=document.getElementById("editDescription"),editPriceInput=document.getElementById("editPrice"),editFileUrlInput=document.getElementById("editFileUrl"),cancelEditBtn=document.getElementById("cancelEditBtn");function sendSaleEmail({buyerName:e,buyerEmail:t,sellerPaypalEmail:r,productTitle:a,amount:o}){emailjs.send("service_px8mdvo","template_4gvs2zf",{buyer_name:e,buyer_email:t,seller_paypal_email:r,product_title:a,amount:o}).then((function(e){console.log("Sale email sent!",e.status,e.text)}),(function(e){console.error("FAILED to send sale email.",e)}))}function showProfileUI(e){e&&(profilePic.src=e.photoURL||"https://ui-avatars.com/api/?name="+encodeURIComponent(e.email||"U"),profilePic.classList.remove("hidden"),userEmail.textContent=e.email||"(no email)",profilePic.onclick=function(e){e.stopPropagation(),dropdownMenu.classList.toggle("hidden")},document.addEventListener("click",(e=>{profilePic.contains(e.target)||dropdownMenu.contains(e.target)||dropdownMenu.classList.add("hidden")})),document.getElementById("deleteAccountBtn").onclick=async()=>{if(confirm("Delete your account? This cannot be undone."))try{await deleteUser(e),alert("Account deleted."),window.location.href=LANDING_URL}catch(e){"auth/requires-recent-login"===e.code?alert("Please sign out and sign in again, then try deleting your account."):alert("Failed to delete account: "+e.message)}},document.getElementById("signOutBtn").onclick=()=>{signOut(auth)})}function showTab(e){tabs.forEach((e=>{e.classList.remove("bg-blue-100"),e.removeAttribute("aria-current")}));const t=document.querySelector(`a[data-tab="${e}"]`);t&&(t.classList.add("bg-blue-100"),t.setAttribute("aria-current","page")),sections.forEach((t=>{t.id===e?t.classList.remove("hidden"):t.classList.add("hidden")}))}function toggleProductForm(e){e?(sellLandingContent.classList.add("hidden"),productForm.classList.remove("hidden"),showTab("sell"),productUploadForm.reset(),restoreSellForm(),enableSubmitButton()):(sellLandingContent.classList.remove("hidden"),productForm.classList.add("hidden"))}function saveSellForm(){const e={title:titleInput.value,description:descriptionInput.value,price:priceInput.value,paypalEmail:paypalEmailInput.value,previewImageUrl:previewImageUrlInput.value,productFileUrl:productFileUrlInput.value};localStorage.setItem(SELL_FORM_KEY,JSON.stringify(e))}function restoreSellForm(){const e=JSON.parse(localStorage.getItem(SELL_FORM_KEY)||"{}");titleInput.value=e.title||"",descriptionInput.value=e.description||"",priceInput.value=e.price||"",paypalEmailInput.value=e.paypalEmail||"",previewImageUrlInput.value=e.previewImageUrl||"",productFileUrlInput.value=e.productFileUrl||"",e.previewImageUrl?(currentPreviewImage.src=e.previewImageUrl,previewImageContainer.classList.remove("hidden")):(previewImageContainer.classList.add("hidden"),currentPreviewImage.src="");const t=parseFloat(e.price);!isNaN(t)&&t>0?(paypalEmailContainer.classList.remove("hidden"),paypalEmailInput.setAttribute("required","required")):(paypalEmailContainer.classList.add("hidden"),paypalEmailInput.removeAttribute("required"))}document.body.style.visibility="hidden",onAuthStateChanged(auth,(e=>{document.body.style.visibility="",e?(authOverlay.style.display="none",userGlobal=e,showProfileUI(e)):(authOverlay.style.display="flex",userGlobal=null)})),tabs.forEach((e=>{e.addEventListener("click",(async t=>{t.preventDefault();const r=e.getAttribute("data-tab");showTab(r),"sell"===r||productForm.classList.contains("hidden")||toggleProductForm(!1),productDetailsSection.classList.add("hidden"),"home"===r?(await loadProducts(searchBar.value.trim()),searchBar.value=""):"dashboard"===r&&await showDashboard()}))})),backToHomeBtn.addEventListener("click",(()=>{showTab("home"),loadProducts(searchBar.value.trim())})),startSellingBtn.addEventListener("click",(()=>{toggleProductForm(!0)})),[titleInput,descriptionInput,priceInput,paypalEmailInput,previewImageUrlInput,productFileUrlInput].forEach((e=>{e.addEventListener("input",saveSellForm)})),document.addEventListener("DOMContentLoaded",restoreSellForm);let isPreviewImageUploading=!1;const previewImageWidget=window.cloudinary.createUploadWidget({cloudName:"desejdvif",uploadPreset:CLOUDINARY_UPLOAD_PRESET,sources:["local"],resourceType:"image",clientAllowedFormats:["jpg","jpeg","png","gif","svg"],maxFileSize:10485760,multiple:!1,folder:"tradedeck_product_previews"},((e,t)=>{!e&&t&&"success"===t.event?(previewImageUrlInput.value=t.info.secure_url,setFileInputStatus(previewImageStatus,`Image uploaded: ${t.info.original_filename}.${t.info.format}`,"success"),openPreviewImageWidgetBtn.classList.remove("input-invalid"),currentPreviewImage.src=t.info.secure_url,previewImageContainer.classList.remove("hidden"),isPreviewImageUploading=!1,enableSubmitButton(),saveSellForm()):e?(setFileInputStatus(previewImageStatus,"Image upload failed. Please try again.","error"),previewImageUrlInput.value="",openPreviewImageWidgetBtn.classList.add("input-invalid"),previewImageContainer.classList.add("hidden"),currentPreviewImage.src="",isPreviewImageUploading=!1,enableSubmitButton()):!t||"close"!==t.event&&"abort"!==t.event?t&&"asset_selected"===t.event&&(setFileInputStatus(previewImageStatus,`Uploading ${t.info.original_filename||"image"}...`,"loading"),isPreviewImageUploading=!0,disableSubmitButton()):(""===previewImageUrlInput.value&&(setFileInputStatus(previewImageStatus,"Preview image selection cancelled or not provided.","error"),openPreviewImageWidgetBtn.classList.add("input-invalid")),isPreviewImageUploading=!1,enableSubmitButton())}));function setFileInputStatus(e,t,r="default"){e.textContent=t,e.classList.remove("success","error","loading"),"success"===r?e.classList.add("success"):"error"===r?e.classList.add("error"):"loading"===r&&e.classList.add("loading")}function convertToGoogleDriveDirectDownload(e){if(!e)return e;let t=e;const r=e.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/(view|edit|preview)/);if(r&&r[1]){t=`https://drive.google.com/uc?export=download&id=${r[1]}`}else if(e.includes("drive.google.com/open?id=")){const r=e.match(/id=([a-zA-Z0-9_-]+)/);if(r&&r[1]){t=`https://drive.google.com/uc?export=download&id=${r[1]}`}}return t}function validateSellForm(){let e=[];if(titleInput.value.trim()||e.push("Product title is required."),descriptionInput.value.trim()||e.push("Product description is required."),(isNaN(parseFloat(priceInput.value))||parseFloat(priceInput.value)<0)&&e.push("Price must be zero or a positive number."),productFileUrlInput.value.trim()&&/^https?:\/\/.+\..+/.test(productFileUrlInput.value.trim())||e.push("Valid download link is required."),previewImageUrlInput.value||e.push("Product preview image is required."),!paypalEmailContainer.classList.contains("hidden")){const t=paypalEmailInput.value.trim();/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||e.push("Valid PayPal email is required for paid products.")}return isPreviewImageUploading&&e.push("Please wait for the image upload to finish."),e}function showFormErrors(e){if(!e.length)return formErrorSummary.classList.add("hidden"),void(formErrorSummary.innerHTML="");formErrorSummary.classList.remove("hidden"),formErrorSummary.innerHTML=`<ul>${e.map((e=>`<li>${e}</li>`)).join("")}</ul>`}function enableSubmitButton(){const e=validateSellForm();showFormErrors(e),e.length?(submitProductBtn.disabled=!0,submitProductBtn.classList.add("opacity-50","cursor-not-allowed")):(submitProductBtn.disabled=!1,submitProductBtn.classList.remove("opacity-50","cursor-not-allowed"))}function disableSubmitButton(){submitProductBtn.disabled=!0,submitProductBtn.classList.add("opacity-50","cursor-not-allowed")}async function loadProducts(e=""){productListContainer.innerHTML="",noProductsMessage.textContent="Loading products...",noProductsMessage.classList.remove("hidden");try{const t=query(collection(db,"products"),orderBy("createdAt","desc")),r=(await getDocs(t)).docs.map((e=>({id:e.id,...e.data()})));window.allProducts=r;const a=e.toLowerCase();renderProducts(r.filter((e=>(e.title||"").toLowerCase().includes(a)||(e.description||"").toLowerCase().includes(a))),productListContainer,noProductsMessage,!1)}catch(e){console.error("Error loading products:",e),noProductsMessage.textContent="Error loading products. Please try again.",noProductsMessage.classList.remove("hidden")}}function renderProducts(e,t,r,a=!1){if(t.innerHTML="",r.classList.add("hidden"),!Array.isArray(e)||0===e.length)return r.classList.remove("hidden"),void(r.textContent=a?"No products listed on the dashboard.":"No products found matching your search.");e.forEach((e=>{const r=document.createElement("div");r.className="bg-white rounded-lg shadow p-4 flex flex-col product-card "+(a?"":"interactive-card border border-transparent"),r.setAttribute("data-product-id",e.id);const o=0===parseFloat(e.price)?"Free":`$${parseFloat(e.price).toFixed(2)}`;let n="";if(a&&(n=`\n        <div class="mt-auto flex justify-end items-center pt-2">\n          <a href="${e.fileUrl}" target="_blank" download="${(e.title||"").replace(/\s/g,"-")}" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition">Download</a>\n          <button data-product-id="${e.id}" class="delist-product-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition ml-2">Delist</button>\n        </div>\n      `),r.innerHTML=`\n      <img src="${e.previewImageUrl||"https://via.placeholder.com/300x200?text=Product+Preview"}" alt="${e.title} preview" class="rounded mb-3 h-48 object-cover w-full"/>\n      <h3 class="font-semibold text-lg mb-1">${e.title}</h3>\n      <p class="text-gray-600 text-sm flex-grow mb-2 overflow-hidden overflow-ellipsis whitespace-nowrap">${e.description}</p>\n      <div class="mt-auto flex justify-between items-center pt-2">\n        <span class="font-bold text-blue-600">${o}</span>\n        ${n}\n      </div>\n    `,t.appendChild(r),a){const e=r.querySelector(".delist-product-btn");e&&e.addEventListener("click",(t=>{t.stopPropagation();const r=e.getAttribute("data-product-id");r&&deleteProduct(r)}))}else r.addEventListener("click",(()=>{const e=r.getAttribute("data-product-id");e&&showProductDetails(e)}))}))}async function deleteProduct(e){if(confirm("Are you sure you want to permanently delist this product? This action cannot be undone."))try{await deleteDoc(doc(db,"products",e)),alert("Product delisted successfully!"),await loadProducts(""),await showDashboard()}catch(e){console.error("Error removing document: ",e),alert("Error delisting product. Please try again. (Check Firestore rules if it fails)")}}async function showProductDetails(e){showTab("productDetails"),productDetailsError.classList.add("hidden");try{const t=await getDoc(doc(db,"products",e));if(!t.exists())return productDetailsError.textContent="Product not found.",void productDetailsError.classList.remove("hidden");const r={id:t.id,...t.data()};detailProductImage.src=r.previewImageUrl||"https://via.placeholder.com/600x400?text=Product+Preview",detailProductTitle.textContent=r.title,detailProductDescription.textContent=r.description;const a=0===parseFloat(r.price)?"Free":`$${parseFloat(r.price).toFixed(2)}`;detailProductPrice.textContent=a,detailActionButton.className="w-full py-3 rounded-xl font-semibold transition",detailActionButton.disabled=!1,parseFloat(r.price)>0?(detailActionButton.style.display="none",paypalButtonContainer.innerHTML="",void 0!==window.paypal&&window.paypal.Buttons?window.paypal.Buttons({createOrder:function(e,t){return t.order.create({purchase_units:[{amount:{value:r.price.toString()},description:r.title}]})},onApprove:async function(e,t){return t.order.capture().then((async function(e){alert("Payment completed by "+e.payer.name.given_name+"!"),paypalButtonContainer.innerHTML=`<a href="${r.fileUrl}" target="_blank" class="w-full block bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-xl mt-2 font-semibold transition">Download Product</a>`,await handleProductPurchase(r),sendSaleEmail({buyerName:e.payer&&e.payer.name&&e.payer.name.given_name?e.payer.name.given_name:"Unknown",buyerEmail:e.payer&&e.payer.email_address?e.payer.email_address:"Unknown",sellerPaypalEmail:r.paypalEmail||"Not Provided",productTitle:r.title||"Unknown",amount:void 0!==r.price?r.price:"Unknown"})}))},onError:function(e){alert("Payment could not be completed. Please try again."),console.error(e)}}).render("#paypal-button-container"):paypalButtonContainer.innerHTML='<p class="text-red-600">PayPal buttons could not be loaded. Please refresh.</p>'):(detailActionButton.style.display="",paypalButtonContainer.innerHTML="",detailActionButton.textContent="Download",detailActionButton.classList.add("bg-green-600","hover:bg-green-700","text-white"),detailActionButton.onclick=()=>{window.open(r.fileUrl,"_blank")},detailActionButton.setAttribute("aria-label",`Download ${r.title}`))}catch(e){console.error("Error loading product details:",e),productDetailsError.textContent="Error loading product details. Please try again.",productDetailsError.classList.remove("hidden")}}async function updateSellerBalance(e){try{const t=await getDoc(doc(db,"balances",e));let r=0;t.exists()&&"number"==typeof t.data().balance&&(r=t.data().balance),sellerBalance.textContent=`$${r.toFixed(2)}`}catch(e){sellerBalance.textContent="$0.00"}}openPreviewImageWidgetBtn.addEventListener("click",(()=>{previewImageWidget.open()})),[titleInput,descriptionInput,priceInput,paypalEmailInput,previewImageUrlInput,productFileUrlInput].forEach((e=>{e.addEventListener("input",enableSubmitButton)})),priceInput.addEventListener("input",(()=>{const e=parseFloat(priceInput.value);isNaN(e)||0===e?(paypalEmailContainer.classList.add("hidden"),paypalEmailInput.removeAttribute("required"),paypalEmailInput.value=""):(paypalEmailContainer.classList.remove("hidden"),paypalEmailInput.setAttribute("required","required")),enableSubmitButton(),saveSellForm()})),productUploadForm.addEventListener("submit",(async e=>{e.preventDefault(),disableSubmitButton(),submitProductBtn.textContent="Listing...";const t=validateSellForm();if(showFormErrors(t),t.length)return submitProductBtn.textContent="List Product",void enableSubmitButton();try{if(!auth.currentUser)return alert("You must be signed in to list a product."),void window.location.reload();const e=convertToGoogleDriveDirectDownload(productFileUrlInput.value.trim()),t={title:titleInput.value.trim(),description:descriptionInput.value.trim(),price:parseFloat(priceInput.value),fileUrl:e,previewImageUrl:previewImageUrlInput.value,createdAt:serverTimestamp(),sellerId:auth.currentUser.uid,paypalEmail:paypalEmailInput.value.trim()};await addDoc(collection(db,"products"),t),alert("Product listed successfully!"),localStorage.removeItem(SELL_FORM_KEY),toggleProductForm(!1),await loadProducts(""),auth.currentUser&&await loadMyProducts(auth.currentUser.uid)}catch(e){showFormErrors(["Failed to list product. Please try again."]),console.error("Error adding document to Firestore:",e),alert("Failed to list product. Please check console for details. (Check Firestore rules!)")}finally{enableSubmitButton(),submitProductBtn.textContent="List Product"}})),searchBar.addEventListener("input",(()=>{if(!document.getElementById("home").classList.contains("hidden")){const e=searchBar.value.trim().toLowerCase();if(!window.allProducts)return;if(!e)return void renderProducts(window.allProducts,productListContainer,noProductsMessage,!1);const t=e.split(/\s+/).filter(Boolean),r=window.allProducts.filter((e=>{const r=[e.title||"",e.description||""].join(" ").toLowerCase();return t.some((e=>r.includes(e)))}));r.length>0?(renderProducts(r,productListContainer,noProductsMessage,!1),noProductsMessage.classList.add("hidden")):(productListContainer.innerHTML="",noProductsMessage.textContent="No products found for your search. Try different keywords!",noProductsMessage.classList.remove("hidden"))}}));let balanceUnsub=null;function watchSellerBalance(e){balanceUnsub&&balanceUnsub(),balanceUnsub=onSnapshot(doc(db,"balances",e),(e=>{let t=0;e.exists()&&"number"==typeof e.data().balance&&(t=e.data().balance),sellerBalance.textContent=`$${t.toFixed(2)}`}))}async function loadMyProducts(e){myProductsContainer.innerHTML="",noMyProductsMessage.classList.add("hidden");try{const t=query(collection(db,"products"),where("sellerId","==",e)),r=(await getDocs(t)).docs.map((e=>({id:e.id,...e.data()})));if(0===r.length)return void noMyProductsMessage.classList.remove("hidden");renderProducts(r,myProductsContainer,noMyProductsMessage,!0)}catch(e){console.error("Error loading user's products:",e),myProductsContainer.innerHTML='<p class="text-center text-red-600">Error loading your products.<br>'+e.message+"</p>"}}function openEditProductModal(e){editProductIdInput.value=e.id,editTitleInput.value=e.title,editDescriptionInput.value=e.description,editPriceInput.value=e.price,editFileUrlInput.value=e.fileUrl,editProductModal.classList.remove("hidden")}function closeEditProductModal(){editProductModal.classList.add("hidden")}async function showDashboard(){auth.currentUser&&(showTab("dashboard"),await updateSellerBalance(auth.currentUser.uid),watchSellerBalance(auth.currentUser.uid),await loadMyProducts(auth.currentUser.uid))}async function incrementSellerBalance(e,t){const r=doc(db,"balances",e);await runTransaction(db,(async e=>{const a=await e.get(r);let o=t;a.exists()&&"number"==typeof a.data().balance&&(o+=a.data().balance),e.set(r,{balance:o},{merge:!0})}))}async function handleProductPurchase(e){e&&e.sellerId&&e.price&&await incrementSellerBalance(e.sellerId,parseFloat(e.price))}editProductForm.onsubmit=async function(e){e.preventDefault();const t=editProductIdInput.value,r={title:editTitleInput.value.trim(),description:editDescriptionInput.value.trim(),price:parseFloat(editPriceInput.value),fileUrl:editFileUrlInput.value.trim()};try{await updateDoc(doc(db,"products",t),r),closeEditProductModal(),auth.currentUser&&await loadMyProducts(auth.currentUser.uid)}catch(e){alert("Failed to update product.")}},cancelEditBtn.onclick=closeEditProductModal,loadProducts(),showTab("home"),enableSubmitButton();
